<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.renkeju.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="时光穿梭机">
<meta property="og:url" content="https://blog.renkeju.com/index.html">
<meta property="og:site_name" content="时光穿梭机">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Keju Ren">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="Cloud">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.renkeju.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>时光穿梭机</title>
  
    <script>
      function sendPageView() {
        if (CONFIG.hostname !== location.hostname) return;
        var uid = localStorage.getItem('uid') || (Math.random() + '.' + Math.random());
        localStorage.setItem('uid', uid);
        navigator.sendBeacon('https://www.google-analytics.com/collect', new URLSearchParams({
          v  : 1,
          tid: 'UA-149464655-1',
          cid: uid,
          t  : 'pageview',
          dp : encodeURIComponent(location.pathname)
        }));
      }
      document.addEventListener('pjax:complete', sendPageView);
      sendPageView();
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">时光穿梭机</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">穿梭时间的飞行日志</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/07/10/lotus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/10/lotus/" class="post-title-link" itemprop="url">lotus 部署与实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-10 19:34:33" itemprop="dateCreated datePublished" datetime="2020-07-10T19:34:33+08:00">2020-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-23 02:32:45" itemprop="dateModified" datetime="2020-07-23T02:32:45+08:00">2020-07-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="lotus-安装"><a href="#lotus-安装" class="headerlink" title="lotus 安装"></a>lotus 安装</h2><h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SHELL&#x3D;&#x2F;bin&#x2F;bash</span><br><span class="line">PATH&#x3D;&#x2F;root&#x2F;.cargo&#x2F;bin:&#x2F;root&#x2F;.cargo&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;local&#x2F;games:&#x2F;snap&#x2F;bin</span><br><span class="line">MAILTO&#x3D;root</span><br><span class="line"></span><br><span class="line">0 *&#x2F;1 * * * source &#x2F;etc&#x2F;profile.d&#x2F;lotus.sh &amp;&amp; &#x2F;usr&#x2F;local&#x2F;bin&#x2F;lotus-storage-miner sectors pledge</span><br><span class="line">20 *&#x2F;1 * * * source &#x2F;etc&#x2F;profile.d&#x2F;lotus.sh &amp;&amp; &#x2F;usr&#x2F;local&#x2F;bin&#x2F;lotus-storage-miner sectors pledge</span><br><span class="line">40 *&#x2F;1 * * * source &#x2F;etc&#x2F;profile.d&#x2F;lotus.sh &amp;&amp; &#x2F;usr&#x2F;local&#x2F;bin&#x2F;lotus-storage-miner sectors pledge</span><br></pre></td></tr></table></figure>

<p>定时任务建议根据<code>lotus-banch</code>测试出<code>addPiece</code>的时间，调整时间间隔，当然，后端的服务器也需要有能力消化。</p>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># lotus 路径：</span><br><span class="line">LOTUS_PATH</span><br><span class="line"># 例如： export LOTUS_PATH&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;lotus</span><br><span class="line"></span><br><span class="line"># miner 路径： </span><br><span class="line">LOTUS_STORAGE_PATH</span><br><span class="line"># 例如： export LOTUS_STORAGE_PATH&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;lotusstorage</span><br><span class="line"></span><br><span class="line"># worker 路径： </span><br><span class="line">WORKER_PATH</span><br><span class="line"># 例如： export WORKER_PATH&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;lotusworker</span><br><span class="line"></span><br><span class="line"># proof 证明参数路径： </span><br><span class="line">FIL_PROOFS_PARAMETER_CACHE</span><br><span class="line"># 例如： export FIL_PROOFS_PARAMETER_CACHE&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;filecoin-proof-parameters</span><br><span class="line"></span><br><span class="line"># 临时文件夹路径： </span><br><span class="line">TMPDIR</span><br><span class="line"># 例如： export TMPDIR&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;tmp</span><br><span class="line"></span><br><span class="line"># 最大化内存参数</span><br><span class="line">FIL_PROOFS_MAXIMIZE_CACHING</span><br><span class="line"># 例如： export FIL_PROOFS_MAXIMIZE_CACHING&#x3D;1</span><br><span class="line"></span><br><span class="line"># Rust 日志</span><br><span class="line">RUST_LOG</span><br><span class="line"># 例如： export RUST_LOG&#x3D;Debug</span><br><span class="line"></span><br><span class="line"># GPU计算Precommit2</span><br><span class="line">FIL_PROOFS_USE_GPU_COLUMN_BUILDER</span><br><span class="line"># 例如： export FIL_PROOFS_USE_GPU_COLUMN_BUILDER&#x3D;1</span><br><span class="line"></span><br><span class="line"># 源码编译底层库</span><br><span class="line">FFI_BUILD_FROM_SOURCE</span><br><span class="line"># 例如： export FFI_BUILD_FROM_SOURCE&#x3D;1</span><br><span class="line"></span><br><span class="line"># GOLANG 代理</span><br><span class="line">GOPROXY</span><br><span class="line"># 例如： export GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn</span><br><span class="line"></span><br><span class="line"># 启动小扇区支持</span><br><span class="line">FIL_USE_SMALL_SECTORS</span><br><span class="line"># 例如： export FIL_USE_SMALL_SECTORS&#x3D;true</span><br><span class="line"></span><br><span class="line"># 显卡相关</span><br><span class="line">BELLMAN_CUSTOM_GPU</span><br><span class="line"># 例如： export BELLMAN_CUSTOM_GPU&#x3D;&quot;GeForce RTX 2080 Ti:4352&quot;</span><br><span class="line"></span><br><span class="line"># 下载证明参数代理：</span><br><span class="line">IPFS_GATEWAY</span><br><span class="line"># 例如： export IPFS_GATEWAY&#x3D;&quot;https:&#x2F;&#x2F;proof-parameters.s3.cn-south-1.jdcloud-oss.com&#x2F;ipfs&#x2F;&quot;</span><br><span class="line"></span><br><span class="line"># 启用 GPU 计算 Precommit2 中的部分过程</span><br><span class="line">FIL_PROOFS_USE_GPU_TREE_BUILDER</span><br><span class="line">FIL_PROOFS_USE_GPU_COLUMN_BUILDER</span><br><span class="line"># 例如：export FIL_PROOFS_USE_GPU_TREE_BUILDER&#x3D;1</span><br><span class="line"># 例如：export FIL_PROOFS_USE_GPU_COLUMN_BUILDER&#x3D;1</span><br></pre></td></tr></table></figure>

<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># apt update </span><br><span class="line"># apt -y install mesa-opencl-icd ocl-icd-opencl-dev gcc git bzr jq pkg-config curl git</span><br><span class="line"># HTTP_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 HTTPS_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 curl --proto &#39;&#x3D;https&#39; --tlsv1.2 -sSf https:&#x2F;&#x2F;sh.rustup.rs | RUSTUP_INIT_SKIP_PATH_CHECK&#x3D;yes HTTP_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 HTTPS_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 sh</span><br><span class="line"># source $HOME&#x2F;.cargo&#x2F;env &amp;&amp; echo &quot;source $HOME&#x2F;.cargo&#x2F;env&quot; &gt;&gt; &#x2F;root&#x2F;.bashrc</span><br><span class="line"># add-apt-repository ppa:longsleep&#x2F;golang-backports</span><br><span class="line"># apt update</span><br><span class="line"># apt -y install golang-go</span><br></pre></td></tr></table></figure>

<h3 id="获取代码"><a href="#获取代码" class="headerlink" title="获取代码"></a>获取代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># git config --global http.proxy http:&#x2F;&#x2F;192.168.1.4:8118</span><br><span class="line"># git config --global https.proxy http:&#x2F;&#x2F;192.168.1.4:8118</span><br><span class="line"># git clone https:&#x2F;&#x2F;github.com&#x2F;filecoin-project&#x2F;lotus.git</span><br></pre></td></tr></table></figure>

<h3 id="切换标签"><a href="#切换标签" class="headerlink" title="切换标签"></a>切换标签</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd lotus</span><br><span class="line"># git tag     ## 查看所有标签</span><br><span class="line"># git checkout v0.4.1        ## 切换标签</span><br><span class="line"># git branch				## 查看所在标签</span><br></pre></td></tr></table></figure>

<h3 id="从源代码构建-Lotus-二进制文件并安装"><a href="#从源代码构建-Lotus-二进制文件并安装" class="headerlink" title="从源代码构建 Lotus 二进制文件并安装"></a>从源代码构建 Lotus 二进制文件并安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># make clean &amp;&amp; HTTP_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 HTTPS_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 make all</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>

<h4 id="编译参数"><a href="#编译参数" class="headerlink" title="编译参数"></a>编译参数</h4><p>v26/v27版本代码的编译命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 启用 GPU 相关环境变量【Precommit2 的时候可以使用 GPU 计算】</span><br><span class="line">env HTTP_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 HTTPS_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 RUSTFLAGS&#x3D;&quot;-C target-cpu&#x3D;native -g&quot; FIL_PROOFS_USE_GPU_COLUMN_BUILDER&#x3D;1 FIL_PROOFS_USE_GPU_TREE_BUILDER&#x3D;1 FFI_BUILD_FROM_SOURCE&#x3D;1 make clean all bench &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3 id="将Lotus与systemd一起使用"><a href="#将Lotus与systemd一起使用" class="headerlink" title="将Lotus与systemd一起使用"></a>将Lotus与systemd一起使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># make install-services</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是，如果你使用远程lotus-daemon，需要将 /usr/local/lib/systemd/system/lotus-miner.service 中的<code>After=lotus-daemon.service</code>和<code>Requires=lotus-daemon.service</code>删除掉，以免本地lotus-daemon启动。<br>另外，你也可以将环境变量写入 systemd 中，管理启动时的环境变量。示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment&#x3D;FIL_PROOFS_PARAMETER_CACHE&#x3D;&#x2F;mnt&#x2F;lotus&#x2F;filecoin-proof-parameters</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="跟踪服务的日志"><a href="#跟踪服务的日志" class="headerlink" title="跟踪服务的日志"></a>跟踪服务的日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo journalctl -u lotus-daemon -f</span><br></pre></td></tr></table></figure>

<h4 id="以相反的顺序查看日志"><a href="#以相反的顺序查看日志" class="headerlink" title="以相反的顺序查看日志"></a>以相反的顺序查看日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo journalctl -u lotus-daemon -r</span><br></pre></td></tr></table></figure>

<h2 id="系统调试"><a href="#系统调试" class="headerlink" title="系统调试"></a>系统调试</h2><h3 id="增加-Swap-分区"><a href="#增加-Swap-分区" class="headerlink" title="增加 Swap 分区"></a>增加 Swap 分区</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># fdisk &#x2F;dev&#x2F;nvme0n1</span><br></pre></td></tr></table></figure>

<p>使用 fdisk 格式完成分区之后，将新建分区标记为 83 swap 类型分区，然后使用如下命令进行挂载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkswap -c &#x2F;dev&#x2F;nvme0n1p1   ## 检查是否有坏块</span><br><span class="line"># swapon -v &#x2F;dev&#x2F;nvme0n1p1</span><br></pre></td></tr></table></figure>

<p>最后使用 fstab 文件进行开机挂载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;dev&#x2F;nvme0n1p1 			none            swap    sw              0       0</span><br></pre></td></tr></table></figure>

<h3 id="打开文件限制"><a href="#打开文件限制" class="headerlink" title="打开文件限制"></a>打开文件限制</h3><h4 id="通过-limits-conf-修改文件限制"><a href="#通过-limits-conf-修改文件限制" class="headerlink" title="通过 limits.conf 修改文件限制"></a>通过 limits.conf 修改文件限制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt;&gt; &#x2F;etc&#x2F;security&#x2F;limits.conf</span><br><span class="line">*               soft    core            10000</span><br><span class="line">*               hard    core            10000</span><br><span class="line">*               soft    nproc            10000</span><br><span class="line">*               hard    nproc            10000</span><br><span class="line">*               soft    nofile            10000</span><br><span class="line">*               hard    nofile            10000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="或使用-systemd-修改文件限制"><a href="#或使用-systemd-修改文件限制" class="headerlink" title="或使用 systemd 修改文件限制"></a>或使用 systemd 修改文件限制</h4><p>在 <code>lotus-daemon.service</code>文件中加入如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">LimitCORE&#x3D;infinity</span><br><span class="line">LimitNOFILE&#x3D;10000</span><br><span class="line">LimitNPROC&#x3D;10000</span><br></pre></td></tr></table></figure>

<p>修改完成重新加载 <code>lotus-daemon.service</code> 文件，并重启lotus-daemon服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl restart lotus-daemon</span><br></pre></td></tr></table></figure>

<h2 id="使用远程-daemon"><a href="#使用远程-daemon" class="headerlink" title="使用远程 daemon"></a>使用远程 daemon</h2><p>假设daemon在 <code>192.168.1.100</code> 机器上，miner在 <code>192.168.1.101</code> 机器上：</p>
<ol>
<li>修改远程 daemon (192.168.1.100)上 <code>~/.lotus/config.toml</code> 中的 <code>ListenAddress</code> 为：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Default config:</span><br><span class="line">[API]</span><br><span class="line">ListenAddress &#x3D; &quot;&#x2F;ip4&#x2F;192.168.1.100&#x2F;tcp&#x2F;1234&#x2F;http&quot;</span><br></pre></td></tr></table></figure>

<ol>
<li>将远程 daemon (192.168.1.100) 上 <code>~/.lotus</code> 目录下的 <code>api</code> 和 <code>token</code> 拷贝到 miner 机器(192.168.1.101)的 <code>~/.lotus</code> 目录下，miner主机不用启动lotus-daemon。</li>
<li>重启miner机器的 miner 服务即可。</li>
</ol>
<h2 id="Testnet3-集群配置"><a href="#Testnet3-集群配置" class="headerlink" title="Testnet3 集群配置"></a>Testnet3 集群配置</h2><h3 id="修改-miner"><a href="#修改-miner" class="headerlink" title="修改 miner"></a>修改 miner</h3><p>修改 miner <code>~/.lotusstorage/config.toml</code> 里面的 <code>ListenAddress</code> 和 <code>RemoteListenAddress</code> ，把这两个变量中的地址都改为 miner 本机的地址:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[API]</span><br><span class="line">ListenAddress &#x3D; &quot;&#x2F;ip4&#x2F;192.168.1.100&#x2F;tcp&#x2F;2345&#x2F;http&quot;</span><br><span class="line">RemoteListenAddress &#x3D; &quot;192.168.1.100:2345&quot;</span><br></pre></td></tr></table></figure>

<h3 id="配置-worker"><a href="#配置-worker" class="headerlink" title="配置 worker"></a>配置 worker</h3><p>在 <strong>启动了 miner 之后</strong>，复制 miner 的 <code>~/.lotusstorage</code> 目录中的 <code>token</code> 和 <code>api</code> 到 worker 中的 <code>~/.lotusstorage</code> （worker 中没有这个目录就手动创建一个），然后启动 worker 即可。</p>
<h3 id="启动-worker"><a href="#启动-worker" class="headerlink" title="启动 worker"></a>启动 worker</h3><p>编辑 lotus-seal-worker systemd 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; &#x2F;usr&#x2F;local&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;lotus-worker.service </span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Lotus Storage Seal Worker</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart&#x3D;lotus-seal-worker run --address&#x3D;192.168.1.41:10001 --precommit1&#x3D;false --precommit2&#x3D;true --commit&#x3D;false</span><br><span class="line">Environment&#x3D;GOLOG_FILE&#x3D;&quot;&#x2F;var&#x2F;log&#x2F;lotus&#x2F;worker.log&quot;</span><br><span class="line">Environment&#x3D;GOLOG_LOG_FMT&#x3D;&quot;json&quot;</span><br><span class="line">Environment&#x3D;FIL_PROOFS_MAXIMIZE_CACHING&#x3D;1</span><br><span class="line">Environment&#x3D;RUST_LOG&#x3D;Debug</span><br><span class="line">Environment&#x3D;FIL_PROOFS_USE_GPU_COLUMN_BUILDER&#x3D;1</span><br><span class="line">Environment&#x3D;FIL_PROOFS_USE_GPU_TREE_BUILDER&#x3D;1</span><br><span class="line">Environment&#x3D;FFI_BUILD_FROM_SOURCE&#x3D;1</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multiuser.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># lotus-seal-worker run --address&#x3D;192.168.1.201:2333 --precommit1&#x3D;false --precommit2&#x3D;true --commit&#x3D;true</span><br></pre></td></tr></table></figure>

<p>启动worker需要注意以下几点：</p>
<ul>
<li>要给 worker 指定<strong>本机地址</strong>和一个<strong>随机端口（至少四位数）</strong>;</li>
<li><code>precommit1</code>、<code>precommit2</code> 和 <code>commit</code> 默认是启用的，如果想要禁用，可以设置为 <code>false</code>，例如： <code>--precommit1=false</code>;</li>
<li><code>commit</code> 参数是配置 <code>commit2</code> 的，<code>commit1</code> 无法在 Worker 中启用。</li>
</ul>
<h2 id="生成钱包"><a href="#生成钱包" class="headerlink" title="生成钱包"></a>生成钱包</h2><h3 id="初始化一个新钱包"><a href="#初始化一个新钱包" class="headerlink" title="初始化一个新钱包"></a>初始化一个新钱包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># lotus wallet new</span><br></pre></td></tr></table></figure>

<p>有时，您的操作系统可能会将文件名的长度限制为150个字符以下。您需要使用支持长文件名的文件系统。</p>
<p>这是响应的示例：</p>
<p><code>t1aswwvjsae63tcrniz6x5ykvsuotlgkvlulnqpsi</code></p>
<ul>
<li>访问<a href="https://faucet.testnet.filecoin.io/" target="_blank" rel="noopener">水龙头</a>以增加资金。</li>
<li>粘贴您创建的地址。</li>
<li>按发送按钮。</li>
</ul>
<h2 id="存储矿工"><a href="#存储矿工" class="headerlink" title="存储矿工"></a>存储矿工</h2><p>请使用以下命令确保您的钱包中至少有一个BLS地址（以t3开头）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># lotus wallet list</span><br></pre></td></tr></table></figure>

<p>如果您没有bls地址，请创建一个新的bls钱包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># lotus wallet new bls</span><br></pre></td></tr></table></figure>

<p>使用您的钱包地址：</p>
<ul>
<li>访问[水龙头][<a href="https://faucet.testnet.filecoin.io/]" target="_blank" rel="noopener">https://faucet.testnet.filecoin.io/]</a></li>
<li>点击 “Create Miner”</li>
<li>不要刷新页面。此操作可能需要一些时间。</li>
</ul>
<p>当您看到以下内容时，任务将完成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New storage miners address is: &lt;YOUR_NEW_MINING_ADDRESS&gt;</span><br></pre></td></tr></table></figure>

<h3 id="初始化矿工"><a href="#初始化矿工" class="headerlink" title="初始化矿工"></a>初始化矿工</h3><p>在CLI窗口中，使用以下命令启动您的矿工：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># lotus-storage-miner init --actor&#x3D;ACTOR_VALUE_RECEIVED --owner&#x3D;OWNER_VALUE_RECEIVED</span><br></pre></td></tr></table></figure>

<p>您将需要等待一段时间才能完成此操作。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/06/13/facileManager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/13/facileManager/" class="post-title-link" itemprop="url">facileManager</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-13 18:19:17" itemprop="dateCreated datePublished" datetime="2020-06-13T18:19:17+08:00">2020-06-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-14 03:29:04" itemprop="dateModified" datetime="2020-06-14T03:29:04+08:00">2020-06-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="安装-facileManager"><a href="#安装-facileManager" class="headerlink" title="安装 facileManager"></a>安装 facileManager</h2><ol>
<li><p>从github克隆facileManager的ansible安装脚本</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;renkeju&#x2F;ansible-facilemanager.git</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 inventory 中目录与文件</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd ansible-facilemanager</span><br><span class="line">mkdir inventory&#x2F;host_vars</span><br><span class="line">touch inventory&#x2F;host_vars&#x2F;fm.yml</span><br><span class="line"></span><br><span class="line">ansible_ssh_host: 192.168.0.2</span><br><span class="line">ansible_ssh_port: 22</span><br><span class="line">ansible_ssh_user: firefly</span><br><span class="line">ansible_ssh_pass: firefly</span><br><span class="line">ansible_sudo_pass: firefly</span><br><span class="line">ansible_become_user: root</span><br><span class="line">ansible_become_pass: firefly</span><br><span class="line">ansible_python_interpreter: &#x2F;usr&#x2F;bin&#x2F;python3.6</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>修改 fm.yml 的配置信息，可以参考<a href="http://www.ansible.com.cn/docs/intro_inventory.html#behavioral-parameters" target="_blank" rel="noopener">《Ansible 权威指南》Inventory参数的说明</a></p>
</blockquote>
<ol start="3">
<li><p>修改 <code>inventory/group_vars/all.yml</code> 配置文件。</p>
<p> 下面这两个参数是需要关注的。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apache_listen_interface: eth0</span><br><span class="line">php_packages_state: []</span><br></pre></td></tr></table></figure>
</li>
<li><p>开始安装</p>
<p> 现在配置完成了，可以执行ansible剧本。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible -i inventory&#x2F;hosts.ini fm -m ping</span><br><span class="line">ansible-playbook -i inventory&#x2F;hosts.ini main.yml</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="配置web界面"><a href="#配置web界面" class="headerlink" title="配置web界面"></a>配置web界面</h2><p>打开浏览器输入 http://<ip_address> 并按照下面实例进行操作。</p>
<ol>
<li><p>提供数据库密码并提交</p>
<p> 数据库主机：localhost<br> 数据库名称：facileManager<br> 数据库用户名：facileManager<br> 数据库密码：facileManagerPassword!</p>
<p> <img src="/images/facilemanager/fmdns-01.png" alt="数据库安装"></p>
</li>
<li><p>点击 <code>continue</code> 按钮创建数据库 schema。</p>
<p> <img src="/images/facilemanager/fmdns-02.png" alt="schema"></p>
</li>
<li><p>检查PHP依赖，所有检测通过后，点击continue。</p>
<p> <img src="/images/facilemanager/fmdns-03.png" alt="检查依赖"></p>
</li>
<li><p>创建管理员用户并未管理员用户提供密码，然后点击 continue。</p>
<p> <img src="/images/facilemanager/fmdns-04.png" alt="创建管理员"></p>
</li>
<li><p>到这一步就完成了，点击按钮 Next。</p>
<p> <img src="/images/facilemanager/fmdns-05.png" alt="完成"></p>
</li>
<li><p>输入用户名和密码登录。</p>
<p> <img src="/images/facilemanager/fmdns-06.png" alt="登录"></p>
</li>
<li><p>在配置模块部分激活 fmDNS 与 fmDHCP 模块。</p>
<p> <img src="/images/facilemanager/fmdns-07.png" alt="激活模块"></p>
</li>
<li><p>模块激活成功。</p>
<p> <img src="/images/facilemanager/fmdns-08.png" alt="模块激活成功"></p>
</li>
<li><p>fmDNS已成功加载。点击右上角切换到 fmDNS 模块。</p>
<p> <img src="/images/facilemanager/fmdns-09.png" alt="切换到 fmDNS 模块"></p>
</li>
</ol>
<h2 id="安装-fmDNS-客户端"><a href="#安装-fmDNS-客户端" class="headerlink" title="安装 fmDNS 客户端"></a>安装 fmDNS 客户端</h2><p>登录主机终端，切换到<code>/usr/local/facileManager/fmDNS</code>中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;facileManager&#x2F;fmDNS</span><br><span class="line">php client.php install</span><br><span class="line"></span><br><span class="line">Welcome to the fmDNS installer.</span><br><span class="line"></span><br><span class="line">Please answer the following questions and the necessary configurations will be performed for you.</span><br><span class="line"></span><br><span class="line">Please enter the location of the facileManager interface:</span><br><span class="line">    Examples include:</span><br><span class="line">        fm.mydomain.com</span><br><span class="line">        fm.mydomain.com:8443</span><br><span class="line">        mydomain.com&#x2F;fm</span><br><span class="line">        http:&#x2F;&#x2F;fm.mydomain.com&#x2F;facileManager</span><br><span class="line"></span><br><span class="line">Please enter the location of the facileManager interface: controller.k3s.lan&#x2F;</span><br><span class="line">  --&gt; Testing controller.k3s.lan via https...failed</span><br><span class="line">  --&gt; Testing controller.k3s.lan via http...ok</span><br><span class="line">  --&gt; Checking account details...Success</span><br><span class="line"></span><br><span class="line">Please enter the serial number for controller.k3s.lan (or leave blank to create new): 213688597</span><br><span class="line">  --&gt; Adding controller.k3s.lan to the database...Success</span><br><span class="line">  --&gt; Running version tests...ok</span><br><span class="line"></span><br><span class="line">  --&gt; Tests complete.  Continuing installation.</span><br><span class="line"></span><br><span class="line">Will controller.k3s.lan get updates via cron, ssh, or http(s) [c|s|h]? h</span><br><span class="line"></span><br><span class="line">Cannot find DocumentRoot in apache2.conf.  Please enter the full path of your default DocumentRoot (&#x2F;var&#x2F;www&#x2F;html): &#x2F;var&#x2F;www&#x2F;html&#x2F;facilemanager</span><br><span class="line">  --&gt; Creating &#x2F;var&#x2F;www&#x2F;html&#x2F;facilemanager&#x2F;fM link.</span><br><span class="line">      --&gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;facilemanager&#x2F;fM already exists...skipping</span><br><span class="line">  --&gt; Detected apache2 runs as &#39;www-data&#39;</span><br><span class="line">  --&gt; The sudoers entry already exists...skipping</span><br><span class="line"></span><br><span class="line">Configuration file has been saved.</span><br><span class="line"></span><br><span class="line">Installation is complete. Please login to the UI to ensure the server settings are correct.</span><br></pre></td></tr></table></figure>

<p>如果没有报错，我们在UI中添加服务器。点击 config -&gt; Servers，如下图：</p>
<p><img src="/images/facilemanager/fmdns-10.png" alt="添加服务器"></p>
<p>单击”Enable”按钮启用服务器：</p>
<p><img src="/images/facilemanager/fmdns-11.png" alt="启用服务器"></p>
<p>完成后，UI 右上角需要手动确认更新提交。您的UI界面可以与您的服务器进行通信，并在Web UI中配置您的域并在您的服务器中自动更新。</p>
<h3 id="创建-SOA-模板"><a href="#创建-SOA-模板" class="headerlink" title="创建 SOA 模板"></a>创建 SOA 模板</h3><ol>
<li><p>创建 Forware 使用的 SOA 模板 loaclhost</p>
<p> <img src="/images/facilemanager/SOA_template-01.png" alt="localhost SOA template"></p>
</li>
<li><p>创建 Reveres 使用的 SOA 模板 arpa-ipv6</p>
<p> <img src="/images/facilemanager/SOA_template-02.png" alt="arpa-ipv6 SOA template"></p>
</li>
<li><p>创建 Reveres 使用的 SOA 模板 arpa</p>
<p> <img src="/images/facilemanager/SOA_template-03.png" alt="arpa SOA template"></p>
</li>
</ol>
<h3 id="创建-Zone-模板"><a href="#创建-Zone-模板" class="headerlink" title="创建 Zone 模板"></a>创建 Zone 模板</h3><ol>
<li><p>添加Zone模板并不生效，也可以跳过这一步。</p>
<p> <img src="/images/facilemanager/Zone_Templates.png" alt="添加 Zone 模板"></p>
</li>
<li><p>在模板中添加A记录，Record 所在列是记录，Value为值。</p>
<p> <img src="/images/facilemanager/add_A.png" alt="在模板中添加A记录"></p>
</li>
<li><p>在模板中添加NS记录，NS记录为必须存在的。</p>
<p> <img src="/images/facilemanager/add_NS.png" alt="在模板中添加NS记录"></p>
</li>
<li><p>选择SOA模板，这些SOA模板就是刚刚创建的。</p>
<p> <img src="/images/facilemanager/select_SOA.png" alt="在模板中选择SOA模板"></p>
</li>
</ol>
<h3 id="添加正向解析"><a href="#添加正向解析" class="headerlink" title="添加正向解析"></a>添加正向解析</h3><ol>
<li><p>编辑正向解析区域</p>
<p> <img src="/images/facilemanager/Edit_Zone.png" alt="编辑正向解析区域"></p>
</li>
<li><p>编辑A解析记录</p>
<p> <img src="/images/facilemanager/A_Records.png" alt="编辑A解析记录"></p>
</li>
<li><p>编辑NS解析记录</p>
<p> <img src="/images/facilemanager/NS_Records.png" alt="编辑NS解析记录"></p>
</li>
</ol>
<h3 id="一些其他全局选项"><a href="#一些其他全局选项" class="headerlink" title="一些其他全局选项"></a>一些其他全局选项</h3><p><img src="/images/facilemanager/fmDNS_Global_Options.png" alt="fmDNS全局选项"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/21/firewalld-NAT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/21/firewalld-NAT/" class="post-title-link" itemprop="url">在 CentOS7 使用 firewalld 配置 NAT</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-21 15:16:21 / 修改时间：15:33:06" itemprop="dateCreated datePublished" datetime="2020-05-21T15:16:21+08:00">2020-05-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="创建WAN-LAN区域"><a href="#创建WAN-LAN区域" class="headerlink" title="创建WAN\LAN区域"></a>创建WAN\LAN区域</h2><p>配置NAT需要有两个网络平面，一个负责WAN，一个负责LAN，先创建网卡的zone分别为External（WAN）和Internal（LAN），下面的示例中ens32负责WAN，ens36负责LAN。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nmcli c mod ens32 connection.zone external</span><br><span class="line"># nmcli c mod ens36 connection.zone internal</span><br></pre></td></tr></table></figure>

<p>确认一下是否创建成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --get-active-zone</span><br></pre></td></tr></table></figure>

<p>WAN\LAN配置IP masquerad</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --zone&#x3D;external --add-masquerade --permanent</span><br><span class="line"># firewall-cmd --zone&#x3D;internal --add-masquerade --permanent</span><br><span class="line"># firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>检查一下ip fordwarding 是否启用，如果启用的话为1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br></pre></td></tr></table></figure>

<p>如果<code>/proc/sys/net/ipv4/ip_forward</code>不为1，执行下面的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;sysctl.d&#x2F;99-sysctl.conf </span><br><span class="line"></span><br><span class="line">net.ipv4&#x2F;ip_forward &#x3D; 1</span><br><span class="line"></span><br><span class="line"># sysctl --system</span><br></pre></td></tr></table></figure>

<h2 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h2><p>因为修改了网卡的区域，之前在 public 区域生效的防火墙规则已经失效，所以需要对需要对WAN/LAN开放的端口进行配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --add-service&#x3D;http --zone&#x3D;external --permanent</span><br></pre></td></tr></table></figure>

<ul>
<li>–add-service 指定服务</li>
<li>–zone 指定区域</li>
<li>–permanent 将规则添加到持久规则集</li>
</ul>
<p>当所有服务都定义完成后，可以使用如下命令重新加载 FirewallD。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><p>查看已经配置完成的区域</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --zone&#x3D;external --list-all</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/cobbler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/cobbler/" class="post-title-link" itemprop="url">cobbler 部署与实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:44:00" itemprop="dateCreated datePublished" datetime="2020-05-11T14:44:00+08:00">2020-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 15:38:39" itemprop="dateModified" datetime="2020-05-21T15:38:39+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">自动化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="初始化环境"><a href="#初始化环境" class="headerlink" title="初始化环境"></a>初始化环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install epel-release</span><br><span class="line"># yum makecache</span><br><span class="line"># yum -y update</span><br><span class="line"># systemctl --now disable postfix firewalld</span><br><span class="line"># setenforce 0</span><br><span class="line"># sed -i &#39;s@^\(SELINUX&#x3D;\).*@\1disabled@&#39; &#x2F;etc&#x2F;sysconfig&#x2F;selinux</span><br><span class="line"># sed -i &#39;s@^\(SELINUX&#x3D;\).*@\1disabled@&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line"># reboot</span><br></pre></td></tr></table></figure>

<h2 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install cobbler cobbler-web pykickstart debmirror httpd tftp-server rsync debmirror fence-agents xinetd dhcp bind</span><br><span class="line"># systemctl --now enable cobblerd httpd rsyncd dhcpd named xinetd</span><br></pre></td></tr></table></figure>

<h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># cobbler check</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : The &#39;server&#39; field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the &#39;next_server&#39; field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.   </span><br><span class="line">3 : SELinux is enabled. Please review the following wiki page for details on ensuring cobbler works correctly in your SELinux environment:</span><br><span class="line">    https:&#x2F;&#x2F;github.com&#x2F;cobbler&#x2F;cobbler&#x2F;wiki&#x2F;Selinux</span><br><span class="line">4 : Some network boot-loaders are missing from &#x2F;var&#x2F;lib&#x2F;cobbler&#x2F;loaders, you may run &#39;cobbler get-loaders&#39; to download them, or, if you only want to handle x86&#x2F;x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The &#39;cobbler get-loaders&#39; command is the easiest way to resolve these requirements.</span><br><span class="line">5 : comment out &#39;dists&#39; on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">6 : comment out &#39;arches&#39; on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">7 : The default password used by the sample templates for newly installed machines (default_password_crypted in &#x2F;etc&#x2F;cobbler&#x2F;settings) is still set to &#39;cobbler&#39; and should be changed, try: &quot;openssl passwd -1 -salt &#39;random-phrase-here&#39; &#39;your-password-here&#39;&quot; to generate new one</span><br><span class="line"></span><br><span class="line">Restart cobblerd and then run &#39;cobbler sync&#39; to apply changes.</span><br></pre></td></tr></table></figure>

<h2 id="解决报错"><a href="#解决报错" class="headerlink" title="解决报错"></a>解决报错</h2><ul>
<li><p><code>/etc/cobbler/settings</code> 配置文件中 “server” 字段必须设置为 localhos t以外的 IP 地址,否则 kickstart 将不会工作。应该使用的是一个可解析启动服务器的主机名或所有服务器可以访问的 IP 地址。</p>
</li>
<li><p>PXE 放置在 functional 区域,在 <code>/etc/cobbler/settings</code> 配置文件中 “next_server” 字段必须设置为 127.0.0.1 以外的 IP 地址,而且应该匹配 PXE 启动服务器的 IP 网络。</p>
</li>
<li><p>检查是否关闭了 SELinux</p>
</li>
<li><p><code>/var/lib/cobbler/loaders</code> 文件缺少一些网络引导加载程序,您可以运行 “cobbler get-loaders” 下载,或者,如果您只想处理 x86/x86_64 网络引导,你可以确保您已经安装了一个最近的 recent 版本的 syslinux 包安装和完全可以忽略此消息。这个目录中的文件,你应该要支持所有架构,应包括 pxelinux.0 menu.c32 elilo.efi yaboot。执行 <code>cobbler get-loaders</code> 命令是解决这些需求最简单的方法。</p>
</li>
<li><p>在 <code>/etc/debmirror.conf</code> 配置文件中将 <strong>dists</strong> 所在行注释</p>
</li>
<li><p>在 <code>/etc/debmirror.conf</code> 配置文件中将 <strong>arches</strong> 所在行注释</p>
</li>
<li><p>在新安装的示例模板机器仍将使用 “cobbler” 作为默认密码(/etc/cobbler/settings default_password_crypted)最好更改一下,尝试使用: <code>openssl passwd -1 -salt ‘random-phrase-here’ ‘your-password-here’</code> 产生新的密码</p>
</li>
</ul>
<h2 id="配置-cobbler"><a href="#配置-cobbler" class="headerlink" title="配置 cobbler"></a>配置 cobbler</h2><p>配置 <code>/etc/cobbler/settings</code>，让 cobbler 接管 dns、dhcp、rsync 服务，修改配置文件中的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">manager_dns: 1</span><br><span class="line">manager_dhcp: 1</span><br><span class="line">manager_rsync: 1</span><br></pre></td></tr></table></figure>

<p>修改 cobbler dhcpd <code>/etc/cobbler/dhcp.template</code> 配置模板文件，主要将 dhcp 地址段范围修改与你网卡相同地址段:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"># ******************************************************************</span><br><span class="line"># Cobbler managed dhcpd.conf file</span><br><span class="line">#</span><br><span class="line"># generated from cobbler dhcp.conf template ($date)</span><br><span class="line"># Do NOT make changes to &#x2F;etc&#x2F;dhcpd.conf. Instead, make your changes</span><br><span class="line"># in &#x2F;etc&#x2F;cobbler&#x2F;dhcp.template, as &#x2F;etc&#x2F;dhcpd.conf will be</span><br><span class="line"># overwritten.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">******************************************************************                                </span><br><span class="line"></span><br><span class="line">ddns-update-style interim;</span><br><span class="line">allow booting;</span><br><span class="line">allow bootp;</span><br><span class="line">ignore client-updates;</span><br><span class="line">set vendorclass &#x3D; option vendor-class-identifier;</span><br><span class="line"></span><br><span class="line">option pxe-system-type code 93 &#x3D; unsigned integer 16;</span><br><span class="line"></span><br><span class="line">subnet 192.168.133.0 netmask 255.255.255.0 &#123;</span><br><span class="line">     option routers             192.168.133.5;</span><br><span class="line">     option domain-name-servers 192.168.133.100;</span><br><span class="line">     option subnet-mask         255.255.255.0;</span><br><span class="line">     range dynamic-bootp        192.168.133.100 192.168.133.254;</span><br><span class="line">     default-lease-time         21600;</span><br><span class="line">     max-lease-time             43200;</span><br><span class="line">     next-server                $next_server;</span><br><span class="line">     class &quot;pxeclients&quot; &#123;</span><br><span class="line">          match if substring (option vendor-class-identifier, 0, 9) &#x3D; &quot;PXEClient&quot;;</span><br><span class="line">          if option pxe-system-type &#x3D; 00:02 &#123;</span><br><span class="line">                  filename &quot;ia64&#x2F;elilo.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:06 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:07 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86_64.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:09 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86_64.efi&quot;;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">                  filename &quot;pxelinux.0&quot;;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#for dhcp_tag in $dhcp_tags.keys():</span><br><span class="line">    ## group could be subnet if your dhcp tags line up with your subnets</span><br><span class="line">    ## or really any valid dhcpd.conf construct ... if you only use the</span><br><span class="line">    ## default dhcp tag in cobbler, the group block can be deleted for a</span><br><span class="line">    ## flat configuration</span><br><span class="line"># group for Cobbler DHCP tag: $dhcp_tag</span><br><span class="line">group &#123;</span><br><span class="line">        #for mac in $dhcp_tags[$dhcp_tag].keys():</span><br><span class="line">            #set iface &#x3D; $dhcp_tags[$dhcp_tag][$mac]</span><br><span class="line">    host $iface.name &#123;</span><br><span class="line">        #if $iface.interface_type &#x3D;&#x3D; &quot;infiniband&quot;:</span><br><span class="line">        option dhcp-client-identifier &#x3D; $mac;</span><br><span class="line">        #else</span><br><span class="line">        hardware ethernet $mac;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.ip_address:</span><br><span class="line">        fixed-address $iface.ip_address;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.hostname:</span><br><span class="line">        option host-name &quot;$iface.hostname&quot;;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.netmask:</span><br><span class="line">        option subnet-mask $iface.netmask;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.gateway:</span><br><span class="line">        option routers $iface.gateway;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.enable_gpxe:</span><br><span class="line">        if exists user-class and option user-class &#x3D; &quot;gPXE&quot; &#123;</span><br><span class="line">            filename &quot;http:&#x2F;&#x2F;$cobbler_server&#x2F;cblr&#x2F;svc&#x2F;op&#x2F;gpxe&#x2F;system&#x2F;$iface.owner&quot;;</span><br><span class="line">        &#125; else if exists user-class and option user-class &#x3D; &quot;iPXE&quot; &#123;</span><br><span class="line">            filename &quot;http:&#x2F;&#x2F;$cobbler_server&#x2F;cblr&#x2F;svc&#x2F;op&#x2F;gpxe&#x2F;system&#x2F;$iface.owner&quot;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            filename &quot;undionly.kpxe&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        #else</span><br><span class="line">        filename &quot;$iface.filename&quot;;</span><br><span class="line">        #end if</span><br><span class="line">        ## Cobbler defaults to $next_server, but some users</span><br><span class="line">        ## may like to use $iface.system.server for proxied setups</span><br><span class="line">        next-server $next_server;</span><br><span class="line">        ## next-server $iface.next_server;</span><br><span class="line">    &#125;</span><br><span class="line">        #end for</span><br><span class="line">&#125;</span><br><span class="line">#end for</span><br></pre></td></tr></table></figure>
<p>修改完成后，执行 <code>cobbler sync</code> 命令进行同步。</p>
<h2 id="访问-cobbler"><a href="#访问-cobbler" class="headerlink" title="访问 cobbler"></a>访问 cobbler</h2><p>此时在浏览器中输入 <code>https://&lt;your_virtual_machine_ip_address&gt;/cobbler_web</code> 访问 cobbler web，初始用户名为 <em>cobbler</em>，初始密码为 <em>cobbler</em>。 </p>
<p><img src="/images/cobbler/access_cobbler_web.png" alt="访问 cobbler web 界面"></p>
<p>上载启动镜像，你可以选择挂载光盘，也可以下载 ISO 到系统文件系统内，再进行挂载。</p>
<ul>
<li>挂载光盘后，使用命令 <code>mount /dev/sr0 /mnt</code> 进行挂载。</li>
<li>下载 ISO 镜像文件后，使用命令 <code>mount -or &lt;iso_file_path&gt; /mnt</code> 进行挂载。</li>
</ul>
<p><img src="/images/cobbler/import_image.png" alt="上传镜像"></p>
<p>上传完成后我们可以看到如下内容：</p>
<p><img src="/images/cobbler/distors.png" alt="发行版"></p>
<h2 id="修改Cobbler-web登录密码"><a href="#修改Cobbler-web登录密码" class="headerlink" title="修改Cobbler web登录密码"></a>修改Cobbler web登录密码</h2><p>在终端中执行如下命令，然后输入两次密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># htdigest &#x2F;etc&#x2F;cobbler&#x2F;users.digest &quot;Cobbler&quot; cobbler</span><br><span class="line">Changing password for user cobbler in realm Cobbler</span><br><span class="line">New password: </span><br><span class="line">Re-type new password:</span><br></pre></td></tr></table></figure>

<h2 id="在新主机上安装系统"><a href="#在新主机上安装系统" class="headerlink" title="在新主机上安装系统"></a>在新主机上安装系统</h2><p>网络引导：</p>
<p><img src="/images/cobbler/PXE.png" alt="pxe"><br><img src="/images/cobbler/boot.png" alt="网络引导"></p>
<p>选择你想要安装的发行版本</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Build_a_simple_container_image/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Build_a_simple_container_image/" class="post-title-link" itemprop="url">构建一个简单的容器镜像</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:44:00" itemprop="dateCreated datePublished" datetime="2020-05-11T14:44:00+08:00">2020-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">容器</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>先列出 <a href="https://github.com/renkeju/freerdp" target="_blank" rel="noopener">freerdp</a> 的目录树：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">freerdp</span><br><span class="line">├── docker-compose.build.yml</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── entrypoint.sh</span><br><span class="line">├── freerdp.repo</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>

<ul>
<li>Dockerfile 是构建镜像的文件，当我们在目录 freerdp 中执行<code>docker build -t freerdp:latest .</code>命令后，本地会构建一个名为“freerdp:latest”的镜像。</li>
<li>entrypoint.sh 是在构建镜像的过程中添加到镜像内部的一个 shell 脚本，主要作用为了启动容器是可以将一些自定义的变量在容器内生效。</li>
<li>docker-compose.yml/docker-compose.build.yml 这两个文件可以通过 <code>docker-compose</code> 命令启动容器，docker-compose.build.yml 会在本地构建镜像并启动，docker-compose.yml 则从公共镜像仓库获取镜像后启动。</li>
<li>freerdp.repo 是一个 repo 仓库文件，在构建镜像时，这个文件会添加到 <code>/etc/yum.repos.d</code> 目录下。</li>
</ul>
<h2 id="Dockerfile-的内容"><a href="#Dockerfile-的内容" class="headerlink" title="Dockerfile 的内容"></a>Dockerfile 的内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:6</span><br><span class="line">MAINTAINER Keju Ren &lt;renkeju@gmail.com&gt;</span><br><span class="line">ENV PORT 8888</span><br><span class="line">ENV BINDADDR 127.0.0.1</span><br><span class="line"></span><br><span class="line">ADD freerdp.repo &#x2F;etc&#x2F;yum.repos.d</span><br><span class="line">RUN yum makecache &amp;&amp; \</span><br><span class="line">    yum update -y &amp;&amp; \</span><br><span class="line">    yum -y install wsgate</span><br><span class="line"></span><br><span class="line">ADD entrypoint.sh &#x2F;</span><br><span class="line">RUN chmod +x &#x2F;entrypoint.sh &amp;&amp; \</span><br><span class="line">    ln -s &#x2F;entrypoint.sh &#x2F;usr&#x2F;bin</span><br><span class="line"></span><br><span class="line">EXPOSE $PORT</span><br><span class="line"></span><br><span class="line">CMD entrypoint.sh</span><br></pre></td></tr></table></figure>

<ol>
<li>通过 FROM 这个关键字我们可以从公共镜像仓库中获取一个镜像作为我们的基础镜像。</li>
<li>maintainer 说明一下维护者的联系方式</li>
<li>在 ENV 中定义了两个环境变量。环境变量不一定需要值，在启动镜像时也可以从外部传入值。PORT变量是配置文件中的端口，BINDADDR变量是配置文件中的绑定地址。</li>
<li>ADD 将当前目录下的 <code>freerdp.repo</code> 文件上传到了centos6 基础镜像的 <code>/etc/yum.repos.d</code> 目录下。</li>
<li>RUN 执行了与安装相关的命令</li>
<li>ADD 将 <code>entrypoint.sh</code> 脚本上传到了 centos6 基础镜像的根目录下。</li>
<li>RUN 脚本赋权并且做软链接</li>
<li>将 PORT 变量定义的端口号暴露出来</li>
<li>CMD 定义镜像启动时的执行操作</li>
</ol>
<h2 id="查看容器镜像详细的内容"><a href="#查看容器镜像详细的内容" class="headerlink" title="查看容器镜像详细的内容"></a>查看容器镜像详细的内容</h2><p>容器构建成功后，使用 <code>docker image inspect freerdp:latest</code> 命令查看容器镜像相关的内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">docker image inspect freerdp:latest</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;sha256:0a7b3333fe481578c6a8987e209e6a826ad046fb5099b7202d827033ea69cbf1&quot;,</span><br><span class="line">        &quot;RepoTags&quot;: [</span><br><span class="line">            &quot;freerdp:latest&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;RepoDigests&quot;: [],</span><br><span class="line">        &quot;Parent&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">        &quot;Comment&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2019-11-02T08:13:46.481340443Z&quot;,</span><br><span class="line">        &quot;Container&quot;: &quot;77535bee56c8f980129d3dcbc77367bedd85909ff6257ebb7c04997bf77419ae&quot;,</span><br><span class="line">        &quot;ContainerConfig&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;77535bee56c8&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: false,</span><br><span class="line">            &quot;AttachStdout&quot;: false,</span><br><span class="line">            &quot;AttachStderr&quot;: false,</span><br><span class="line">            &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">                &quot;8888&#x2F;tcp&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Tty&quot;: false,</span><br><span class="line">            &quot;OpenStdin&quot;: false,</span><br><span class="line">            &quot;StdinOnce&quot;: false,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;,</span><br><span class="line">                &quot;PORT&#x3D;8888&quot;,</span><br><span class="line">                &quot;BINDADDR&#x3D;127.0.0.1&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;&#x2F;bin&#x2F;sh&quot;,</span><br><span class="line">                &quot;-c&quot;,</span><br><span class="line">                &quot;#(nop) &quot;,</span><br><span class="line">                &quot;CMD [\&quot;&#x2F;bin&#x2F;sh\&quot; \&quot;-c\&quot; \&quot;entrypoint.sh\&quot;]&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20181006&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DockerVersion&quot;: &quot;19.03.4&quot;,</span><br><span class="line">        &quot;Author&quot;: &quot;Keju Ren &lt;renkeju@gmail.com&gt;&quot;,</span><br><span class="line">        &quot;Config&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: false,</span><br><span class="line">            &quot;AttachStdout&quot;: false,</span><br><span class="line">            &quot;AttachStderr&quot;: false,</span><br><span class="line">            &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">                &quot;8888&#x2F;tcp&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Tty&quot;: false,</span><br><span class="line">            &quot;OpenStdin&quot;: false,</span><br><span class="line">            &quot;StdinOnce&quot;: false,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;,</span><br><span class="line">                &quot;PORT&#x3D;8888&quot;,</span><br><span class="line">                &quot;BINDADDR&#x3D;127.0.0.1&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;&#x2F;bin&#x2F;sh&quot;,</span><br><span class="line">                &quot;-c&quot;,</span><br><span class="line">                &quot;entrypoint.sh&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20181006&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">        &quot;Os&quot;: &quot;linux&quot;,</span><br><span class="line">        &quot;Size&quot;: 625547394,</span><br><span class="line">        &quot;VirtualSize&quot;: 625547394,</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;ad889e09f7b4cbe8d3234f438c8319877172531f7392377600c8df876d7832dd&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;60dd8a91b33be52d53145fe3aed04834ece10a92166aaf0532d5f66a9d067318&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;077badaf444344118bd8197be3d0b841fdfdc1044aa9a5a483acceddc54627a5&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;17535fa5f72208d996b9b99fc325e4fc5066fb39bf7eebbbed2b202678418486&#x2F;diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;RootFS&quot;: &#123;</span><br><span class="line">            &quot;Type&quot;: &quot;layers&quot;,</span><br><span class="line">            &quot;Layers&quot;: [</span><br><span class="line">                &quot;sha256:af6bf1987c2eb07d73f33836b0d8fd825d7c785273526b077e46780e8b4b2ae9&quot;,</span><br><span class="line">                &quot;sha256:cc8e5a6b427b31cf82519aac2ca72844444e9df74734d343dd5b81527dc1f258&quot;,</span><br><span class="line">                &quot;sha256:87715d9735cfcae05d246891eee5583492253e37d270a480665fcd0985fa5dc5&quot;,</span><br><span class="line">                &quot;sha256:a7c3fa2ec462a6226c6d43afe2b694ece538acf184dd07f152a882657f8c51d8&quot;,</span><br><span class="line">                &quot;sha256:1456e758e7b477d0d55b8bd82e3711c57d6616181497044a2ca1f05a63f7b927&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Metadata&quot;: &#123;</span><br><span class="line">            &quot;LastTagTime&quot;: &quot;2019-11-02T16:13:46.509755292+08:00&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以看到在打印出的内容中 ENV 与 CMD 与Dockerfile 中定义的 ENV 与 CMD 相同。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Brief_description_of_the_configuration_file/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Brief_description_of_the_configuration_file/" class="post-title-link" itemprop="url">配置文件的简单说明</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在文章 <a href="/2020/05/11/Quickly_build_a_monitoring_system_test_environment/" title="快速构建监控系统测试环境">快速构建监控系统测试环境</a> 中，我们已经启动了一个实验环境，<a href="https://github.com/renkeju/prometheus_lab.git" target="_blank" rel="noopener">prometheus_lab</a> 中的配置文件内容被没有做详细的说明。下面我们来说说测试环境中的配置文件。</p>
<h2 id="Prometheus-scrape-config"><a href="#Prometheus-scrape-config" class="headerlink" title="Prometheus scrape config"></a>Prometheus scrape config</h2><p>这里只着重说明 <code>prometheus/prometheus.yml</code> 文件中与 SNMP 相关的配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/prometheus/file_sd/node.yml</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">snmp</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">30s</span> <span class="comment"># 覆盖全局默认值</span></span><br><span class="line">    <span class="attr">scrape_timeout:</span> <span class="string">5s</span> <span class="comment"># 覆盖全局默认值</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/prometheus/file_sd/snmp.yml</span> <span class="comment"># 指定 snmp 服务发现配置文件路径</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/snmp</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">if_mib</span>   <span class="comment"># 指定默认采集 MIB 模块的名称</span></span><br><span class="line">      <span class="attr">community:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">public</span>  <span class="comment"># 指定团体号，当 snmp_exporter snmp.yml 配置文件没有指定团体号，此处定义的团体号生效。</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">replacement:</span> <span class="string">snmp_exporter:9116</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span>  <span class="comment"># 从目标中获取MIB模块名称</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mib</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_module</span></span><br></pre></td></tr></table></figure>

<h2 id="Service-Discovery-Config"><a href="#Service-Discovery-Config" class="headerlink" title="Service Discovery Config"></a>Service Discovery Config</h2><p>snmp 的服务发现配置文件中我们可以额外定义一些参数，方便我们可以对不同目标做更小颗粒度的划分。<br>自动发现配置文件支持 json 格式与 yaml 格式，目标定义了 Prometheus 必须为指标而抓取的端点。<br>比如我在下面的示例中添加了<code>architecture</code>与<code>model</code>等变量，这些变量prometheus获取目标信息是，会作为目标的标签与目标绑定。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">"labels"</span>: &#123;</span><br><span class="line">          <span class="attr">"mib"</span>: <span class="string">"apcups"</span>,</span><br><span class="line">          <span class="attr">"architecture"</span>: <span class="string">"x86_64"</span>,</span><br><span class="line">          <span class="attr">"model"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"targets"</span>: [</span><br><span class="line">          <span class="string">"snmpd"</span></span><br><span class="line">      ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><img src="/images/Brief_description_of_the_configuration_file/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" alt="服务发现中的目标标签"></p>
<h2 id="多个目标"><a href="#多个目标" class="headerlink" title="多个目标"></a>多个目标</h2><p>如果有多个目标，需要在服务发现配置文件中列出多个目标信息，这里我贴出一个简单的 python 脚本，可以生成自动发现配置文件，你也可以根据自己的需求修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>], <span class="string">"r"</span>) <span class="keyword">as</span> handler:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> handler:</span><br><span class="line">        line = line.strip(<span class="string">'\n'</span>)</span><br><span class="line">        fields = line.split(<span class="string">','</span>)</span><br><span class="line">        labels = &#123;&#125;</span><br><span class="line">        labels[<span class="string">'brand'</span>] = fields[<span class="number">1</span>]</span><br><span class="line">        labels[<span class="string">'model'</span>] = fields[<span class="number">2</span>]</span><br><span class="line">        labels[<span class="string">'hostname'</span>] = fields[<span class="number">3</span>]</span><br><span class="line">        labels[<span class="string">'mib'</span>] = fields[<span class="number">4</span>]</span><br><span class="line">        targets = []</span><br><span class="line">        targets.append(fields[<span class="number">0</span>])</span><br><span class="line">        custom = &#123;&#125;</span><br><span class="line">	custom[<span class="string">'targets'</span>] = targets</span><br><span class="line">        custom[<span class="string">'labels'</span>] = labels</span><br><span class="line">        print(custom)</span><br><span class="line">        data.append(custom)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">2</span>], <span class="string">"w"</span>) <span class="keyword">as</span> json_handler:</span><br><span class="line">    json.dump(data, json_handler, indent=<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>你需要提前编辑一个 csv 文件，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.1,Huawei,S5328C-EI,BJ-LG-HW5328,if_mib</span><br><span class="line">192.168.100.2,Huawei,Quidway S9306,SH-GQ-HW9306CSS,if_mib</span><br><span class="line">192.168.100.3,Huawei,Quidway S9306,BJ-LG-HW9306CSS,if_mib</span><br><span class="line">192.168.100.4,Huawei,Quidway S9306,GZ-RMZ-HW9306CSS,if_mib</span><br></pre></td></tr></table></figure>

<p>第一个逗号前的内容为主机地址，第二个逗号前的内容为设备厂商名称，第三个逗号前的内容设备型号，第四个逗号前的内容为自定义设备名称，最后一段内容为获取mib名称。<br>使用下面的名称执行脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sd_generate.py &lt;your_csv_file_name&gt; &lt;sd_json_file_name&gt;</span><br></pre></td></tr></table></figure>

<p>执行后生成如下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"BJ-LG-HW5328"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"S5328C-EI"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.1"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"SH-GQ-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.2"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"BJ-LG-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.3"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"GZ-RMZ-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.4"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>之后 prometheus 会自动加载刚刚生成的服务发现配置文件，不需要重启 prometheus。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/SNMP_Exporter_config_generate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/SNMP_Exporter_config_generate/" class="post-title-link" itemprop="url">SNMP Exporter 配置生成器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://github.com/prometheus/snmp_exporter/tree/master/generator" target="_blank" rel="noopener">SNMP Exporter generator 项目地址</a></p>
<p>此配置生成器使用 NetSNMP 解析 MIB，并使用它们为 snmp_exporter 生成配置。</p>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>由于对 NetSNMP 的动态依赖，因此您必须自己构建生成器。</p>
<ul>
<li><p>Debian 系发行版</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install unzip build-essential libsnmp-dev # Debian-based distros</span><br></pre></td></tr></table></figure>
</li>
<li><p>Redhat 系发行版</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gcc gcc-g++ make net-snmp net-snmp-utils net-snmp-libs net-snmp-devel # RHEL-based distros</span><br><span class="line">go get github.com&#x2F;prometheus&#x2F;snmp_exporter&#x2F;generator</span><br><span class="line">cd $&#123;GOPATH-$HOME&#x2F;go&#125;&#x2F;src&#x2F;github.com&#x2F;prometheus&#x2F;snmp_exporter&#x2F;generator</span><br><span class="line">go build</span><br><span class="line">make mibs</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export MIBDIRS&#x3D;mibs</span><br><span class="line">.&#x2F;generator generate</span><br></pre></td></tr></table></figure>

<p>生成器从 <code>generator.yml</code> 读取并写入 <code>snmp.yml</code>。<br>其他命令可用于调试，请使用 <code>help</code> 命令查看它们。</p>
<h2 id="使用-Docker"><a href="#使用-Docker" class="headerlink" title="使用 Docker"></a>使用 Docker</h2><p>如果要在 docker 中运行生成器以生成 <code>snmp.yml</code> 配置，请运行以下命令。<br>Docker 镜像需要一个包含 <code>generator.yml</code> 的目录和一个名为 mibs 的目录，其中包含您要使用的所有 MIB。<br>此示例将生成示例 <code>snmp.yml</code>，该示例包含在 <code>snmp_exporter</code> 存储库的顶级中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">make</span> <span class="string">mibs</span></span><br><span class="line"><span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">snmp-generator</span> <span class="string">.</span></span><br><span class="line"><span class="string">docker</span> <span class="string">run</span> <span class="string">-ti</span> <span class="string">\</span></span><br><span class="line">  <span class="string">-v</span> <span class="string">"$&#123;PWD&#125;:/opt/"</span> <span class="string">\</span></span><br><span class="line">  <span class="string">snmp-generator</span> <span class="string">generate</span></span><br></pre></td></tr></table></figure>

<h2 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h2><p><code>generator.yml</code> 提供模块列表。最简单的模块只是一个名称和一组要遍历的 OID。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">module_name:</span>  <span class="comment"># The module name. You can have as many modules as you want.</span></span><br><span class="line">    <span class="attr">walk:</span>       <span class="comment"># List of OIDs to walk. Can also be SNMP object names or specific instances.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span>              <span class="comment"># Same as "interfaces"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sysUpTime</span>                  <span class="comment"># Same as "1.3.6.1.2.1.1.3"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.6</span><span class="number">.40</span>  <span class="comment"># Instance of "ifHCInOctets" with index "40"</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span>  <span class="comment"># SNMP version to use. Defaults to 2.</span></span><br><span class="line">                <span class="comment"># 1 will use GETNEXT, 2 and 3 use GETBULK.</span></span><br><span class="line">    <span class="attr">max_repetitions:</span> <span class="number">25</span>  <span class="comment"># How many objects to request with GET/GETBULK, defaults to 25.</span></span><br><span class="line">                         <span class="comment"># May need to be reduced for buggy devices.</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">3</span>   <span class="comment"># How many times to retry a failed request, defaults to 3.</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span> <span class="comment"># Timeout for each walk, defaults to 10s.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">auth:</span></span><br><span class="line">      <span class="comment"># Community string is used with SNMP v1 and v2. Defaults to "public".</span></span><br><span class="line">      <span class="attr">community:</span> <span class="string">public</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># v3 has different and more complex settings.</span></span><br><span class="line">      <span class="comment"># Which are required depends on the security_level.</span></span><br><span class="line">      <span class="comment"># The equivalent options on NetSNMP commands like snmpbulkwalk</span></span><br><span class="line">      <span class="comment"># and snmpget are also listed. See snmpcmd(1).</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">user</span>  <span class="comment"># Required, no default. -u option to NetSNMP.</span></span><br><span class="line">      <span class="attr">security_level:</span> <span class="string">noAuthNoPriv</span>  <span class="comment"># Defaults to noAuthNoPriv. -l option to NetSNMP.</span></span><br><span class="line">                                    <span class="comment"># Can be noAuthNoPriv, authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">pass</span>  <span class="comment"># Has no default. Also known as authKey, -A option to NetSNMP.</span></span><br><span class="line">                      <span class="comment"># Required if security_level is authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">auth_protocol:</span> <span class="string">MD5</span>  <span class="comment"># MD5 or SHA, defaults to MD5. -a option to NetSNMP.</span></span><br><span class="line">                          <span class="comment"># Used if security_level is authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">priv_protocol:</span> <span class="string">DES</span>  <span class="comment"># DES or AES, defaults to DES. -x option to NetSNMP.</span></span><br><span class="line">                          <span class="comment"># Used if security_level is authPriv.</span></span><br><span class="line">      <span class="attr">priv_password:</span> <span class="string">otherPass</span> <span class="comment"># Has no default. Also known as privKey, -X option to NetSNMP.</span></span><br><span class="line">                               <span class="comment"># Required if security_level is authPriv.</span></span><br><span class="line">      <span class="attr">context_name:</span> <span class="string">context</span> <span class="comment"># Has no default. -n option to NetSNMP.</span></span><br><span class="line">                            <span class="comment"># Required if context is configured on the device.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">lookups:</span>  <span class="comment"># Optional list of lookups to perform.</span></span><br><span class="line">              <span class="comment"># The default for `keep_source_indexes` is false. Indexes must be unique for this option to be used.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># If the index of a table is bsnDot11EssIndex, usually that'd be the label</span></span><br><span class="line">      <span class="comment"># on the resulting metrics from that table. Instead, use the index to</span></span><br><span class="line">      <span class="comment"># lookup the bsnDot11EssSsid table entry and create a bsnDot11EssSsid label</span></span><br><span class="line">      <span class="comment"># with that value.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_indexes:</span> <span class="string">[bsnDot11EssIndex]</span></span><br><span class="line">        <span class="attr">lookup:</span> <span class="string">bsnDot11EssSsid</span></span><br><span class="line">        <span class="attr">drop_source_indexes:</span> <span class="literal">false</span>  <span class="comment"># If true, delete source index labels for this lookup.</span></span><br><span class="line">                                    <span class="comment"># This avoids label clutter when the new index is unique.</span></span><br><span class="line"></span><br><span class="line">     <span class="attr">overrides:</span> <span class="comment"># Allows for per-module overrides of bits of MIBs</span></span><br><span class="line">       <span class="attr">metricName:</span></span><br><span class="line">         <span class="attr">ignore:</span> <span class="literal">true</span> <span class="comment"># Drops the metric from the output.</span></span><br><span class="line">         <span class="attr">regex_extracts:</span></span><br><span class="line">           <span class="attr">Temp:</span> <span class="comment"># A new metric will be created appending this to the metricName to become metricNameTemp.</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'(.*)'</span> <span class="comment"># Regex to extract a value from the returned SNMP walks's value.</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'$1'</span> <span class="comment"># The result will be parsed as a float64, defaults to $1.</span></span><br><span class="line">           <span class="attr">Status:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'.*Example'</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'1'</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'.*'</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'0'</span></span><br><span class="line">         <span class="attr">type:</span> <span class="string">DisplayString</span> <span class="comment"># Override the metric type, possible types are:</span></span><br><span class="line">                             <span class="comment">#   gauge:   An integer with type gauge.</span></span><br><span class="line">                             <span class="comment">#   counter: An integer with type counter.</span></span><br><span class="line">                             <span class="comment">#   OctetString: A bit string, rendered as 0xff34.</span></span><br><span class="line">                             <span class="comment">#   DateAndTime: An RFC 2579 DateAndTime byte sequence. If the device has no time zone data, UTC is used.</span></span><br><span class="line">                             <span class="comment">#   DisplayString: An ASCII or UTF-8 string.</span></span><br><span class="line">                             <span class="comment">#   PhysAddress48: A 48 bit MAC address, rendered as 00:01:02:03:04:ff.</span></span><br><span class="line">                             <span class="comment">#   Float: A 32 bit floating-point value with type gauge.</span></span><br><span class="line">                             <span class="comment">#   Double: A 64 bit floating-point value with type gauge.</span></span><br><span class="line">                             <span class="comment">#   InetAddressIPv4: An IPv4 address, rendered as 1.2.3.4.</span></span><br><span class="line">                             <span class="comment">#   InetAddressIPv6: An IPv6 address, rendered as 0102:0304:0506:0708:090A:0B0C:0D0E:0F10.</span></span><br><span class="line">                             <span class="comment">#   InetAddress: An InetAddress per RFC 4001. Must be preceded by an InetAddressType.</span></span><br><span class="line">                             <span class="comment">#   InetAddressMissingSize: An InetAddress that violates section 4.1 of RFC 4001 by</span></span><br><span class="line">                             <span class="comment">#       not having the size in the index. Must be preceded by an InetAddressType.</span></span><br><span class="line">                             <span class="comment">#   EnumAsInfo: An enum for which a single timeseries is created. Good for constant values.</span></span><br><span class="line">                             <span class="comment">#   EnumAsStateSet: An enum with a time series per state. Good for variable low-cardinality enums.</span></span><br></pre></td></tr></table></figure>

<h2 id="EnumAsInfo-和-EnumAsStateSet"><a href="#EnumAsInfo-和-EnumAsStateSet" class="headerlink" title="EnumAsInfo 和 EnumAsStateSet"></a>EnumAsInfo 和 EnumAsStateSet</h2><p>SNMP 包含整数索引枚举的概念。 在 Prometheus 中有两种表示这些字符串的方法。 它们可以是“信息”指标，也可以是“状态集”。 SNMP 没有指定应使用的内容，这取决于数据的使用情况。 一些用户可能更喜欢原始整数值，而不是字符串。<br>为了将枚举整数设置为字符串映射，必须使用两个替代之一。<br><code>EnumAsInfo</code>应该用于提供类库存数据的属性。 例如设备类型，颜色名称等。此值恒定是很重要的。<br><code>EnumAsStateSet</code>应该用于表示状态或您可能要发出警报的事物。 例如，链接状态是打开还是关闭，处于错误状态，面板是打开还是关闭等。请注意不要将其用于高基数值，因为它将为每个可能的值生成1个时间序列。</p>
<h2 id="从哪里获得-MIB"><a href="#从哪里获得-MIB" class="headerlink" title="从哪里获得 MIB"></a>从哪里获得 MIB</h2><p>其中一些相当缓慢，建议使用 wget下载。<br>将提取的 mib 放在 NetSNMP 可以读取的位置。 <code>$HOME/.snmp/mibs</code> 是一种选择。</p>
<ul>
<li>Cisco: <a href="ftp://ftp.cisco.com/pub/mibs/v2/v2.tar.gz">ftp://ftp.cisco.com/pub/mibs/v2/v2.tar.gz</a></li>
<li>APC: <a href="https://download.schneider-electric.com/files?p_File_Name=powernet426.mib" target="_blank" rel="noopener">https://download.schneider-electric.com/files?p_File_Name=powernet426.mib</a></li>
<li>Servertech: <a href="ftp://ftp.servertech.com/Pub/SNMP/sentry3/Sentry3.mib">ftp://ftp.servertech.com/Pub/SNMP/sentry3/Sentry3.mib</a></li>
<li>Palo Alto PanOS 7.0 enterprise MIBs: <a href="https://www.paloaltonetworks.com/content/dam/pan/en_US/assets/zip/technical-documentation/snmp-mib-modules/PAN-MIB-MODULES-7.0.zip" target="_blank" rel="noopener">https://www.paloaltonetworks.com/content/dam/pan/en_US/assets/zip/technical-documentation/snmp-mib-modules/PAN-MIB-MODULES-7.0.zip</a></li>
<li>Arista Networks:<br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-ENTITY-SENSOR-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-ENTITY-SENSOR-MIB.txt</a><br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-SW-IP-FORWARDING-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-SW-IP-FORWARDING-MIB.txt</a><br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-SMI-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-SMI-MIB.txt</a></li>
<li>Synology: <a href="https://global.download.synology.com/download/Document/MIBGuide/Synology_MIB_File.zip" target="_blank" rel="noopener">https://global.download.synology.com/download/Document/MIBGuide/Synology_MIB_File.zip</a></li>
<li>MikroTik: <a href="http://download2.mikrotik.com/Mikrotik.mib" target="_blank" rel="noopener">http://download2.mikrotik.com/Mikrotik.mib</a></li>
<li>UCD-SNMP-MIB (Net-SNMP): <a href="http://www.net-snmp.org/docs/mibs/UCD-SNMP-MIB.txt" target="_blank" rel="noopener">http://www.net-snmp.org/docs/mibs/UCD-SNMP-MIB.txt</a></li>
<li>Ubiquiti Networks:<br><a href="http://dl.ubnt-ut.com/snmp/UBNT-MIB" target="_blank" rel="noopener">http://dl.ubnt-ut.com/snmp/UBNT-MIB</a><br><a href="http://dl.ubnt-ut.com/snmp/UBNT-UniFi-MIB" target="_blank" rel="noopener">http://dl.ubnt-ut.com/snmp/UBNT-UniFi-MIB</a><br><a href="https://dl.ubnt.com/firmwares/airos-ubnt-mib/ubnt-mib.zip" target="_blank" rel="noopener">https://dl.ubnt.com/firmwares/airos-ubnt-mib/ubnt-mib.zip</a></li>
</ul>
<p><a href="https://github.com/librenms/librenms/tree/master/mibs" target="_blank" rel="noopener">https://github.com/librenms/librenms/tree/master/mibs</a> can also be a good source of MIBs.<br><a href="http://oidref.com" target="_blank" rel="noopener">http://oidref.com</a> is recommended for browsing MIBs.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Quickly_build_a_monitoring_system_test_environment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Quickly_build_a_monitoring_system_test_environment/" class="post-title-link" itemprop="url">快速构建监控系统测试环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>在测试环境中建议使用 Docker 进行部署。在后面的生产环境部署中我也会提供 Ansible 安装方式。<br><a href="https://download.daocloud.io/Docker_Mirror/Docker" target="_blank" rel="noopener">Docker 安装方式</a><br><a href="https://download.daocloud.io/Docker_Mirror/Docker_Compose" target="_blank" rel="noopener">Docker Compose 安装方式</a><br><a href="https://www.daocloud.io/mirror" target="_blank" rel="noopener">Docker 加速器</a></p>
<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p><a href="https://github.com/renkeju/prometheus_lab" target="_blank" rel="noopener">prometheus 实验环境 Docker Compose 编排文件项目地址</a></p>
<ul>
<li>启动<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/renkeju/prometheus_lab.git</span><br><span class="line"><span class="built_in">cd</span> prometheus_lab</span><br><span class="line">docker-compose push</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li>
<li>停止<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br></pre></td></tr></table></figure></li>
<li>删除<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose rm -f</span><br><span class="line">docker volume prune <span class="comment"># 注意：执行此命令之后所存储的历史数据都会被删除</span></span><br></pre></td></tr></table></figure></li>
<li>查看日志<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs</span><br></pre></td></tr></table></figure>
<h2 id="启动后检查"><a href="#启动后检查" class="headerlink" title="启动后检查"></a>启动后检查</h2>在 docker compose 文件中暴露了三个端口号，分别是：</li>
</ul>
<table>
<thead>
<tr>
<th align="center">端口号</th>
<th align="center">容器内端口号</th>
<th align="center">服务</th>
<th align="center">用户认证</th>
</tr>
</thead>
<tbody><tr>
<td align="center">3000</td>
<td align="center">3000</td>
<td align="center">grafana</td>
<td align="center">有</td>
</tr>
<tr>
<td align="center">9090</td>
<td align="center">9090</td>
<td align="center">prometheus</td>
<td align="center">无</td>
</tr>
<tr>
<td align="center">9116</td>
<td align="center">9116</td>
<td align="center">snmp_exporter</td>
<td align="center">无</td>
</tr>
</tbody></table>
<p>其他容器内启动的服务端口号没有必要暴露出来，使用 <code>links</code> 作为链接，可以提高安全性。如果需要为其他服务端口访问添加访问认证，可以配置 Nginx 使用，在后面我们会提到。</p>
<ul>
<li><p>Grafana</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:3000</code> 访问 Grafana，默认用户名：<code>admin</code>，密码则是 docker-composer 文件中变量 <code>GF_SECURITY_ADMIN_PASSWORD</code> 的值。</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/grafana.png" alt="第一次登录 Grafana"></p>
</li>
<li><p>prometheus</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:9090</code> 访问 prometheus</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" alt="prometheus 服务发现"></p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E7%9B%AE%E6%A0%87.png" alt="prometheus 目标"></p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E5%91%8A%E8%AD%A6.png" alt="prometheus 报警"></p>
</li>
<li><p>snmp_exporter</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:9116</code> 访问 snmp_exporter，snmp_exporter web 提供的信息并不多，你可以查看 <code>snmp.yml</code> 配置文件的内容，也可以对 snmpd 服务进行测试。</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/SNMP_exporter.png" alt="snmp_exporter"></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Prometheus_SNMP_Exporter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Prometheus_SNMP_Exporter/" class="post-title-link" itemprop="url">Prometheus SNMP Exporter</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://github.com/prometheus/snmp_exporter" target="_blank" rel="noopener">Prometheus SNMP Exporter 项目地址</a></p>
<p>SNMP Exporter 从 SNMP 服务中采集信息提供给 Promethers 监控系统使用。<br>有两个部分，执行提供数据的 exporter，以使用的 <a href="https://github.com/prometheus/snmp_exporter/blob/master/generator" target="_blank" rel="noopener">generator</a> （取决于netsnmp）生成配置为 exporter 提供配置。</p>
<h2 id="Exporter-配置"><a href="#Exporter-配置" class="headerlink" title="Exporter 配置"></a>Exporter 配置</h2><p>默认情况下，snmp exporter 从 snmp.yml 文件中读取配置。此文件不是手动编写的，而是使用 <a href="https://github.com/prometheus/snmp_exporter/blob/master/generator" target="_blank" rel="noopener">generator</a> 生成它。<br>默认配置的 snmp.yml 配置文件中包含各种公共硬件，对于这些硬件，mib对常见设备通用，使用 snmp v2 GETBULK 可以遍历它们。<br>除了最简单的设置外，您还需要使用生成器。需要定制哪些对象是遍历的，使用非公开 MIB 或指定认证参数。</p>
<h2 id="Prometheus-配置"><a href="#Prometheus-配置" class="headerlink" title="Prometheus 配置"></a>Prometheus 配置</h2><p>SNMP Exporter 需要将地址作为参数传递，这可以通过重新标记来完成。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'snmp'</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span>  <span class="comment"># SNMP 设备</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/snmp</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span> <span class="string">[if_mib]</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9116</span>  <span class="comment"># SNMP exporter's 真正地址，格式为 hostname:port。</span></span><br></pre></td></tr></table></figure>

<p>这种配置允许 Prometheus 提供调度和服务自动发现，这与不能在我们要从其获取指标的机器上运行 Exporter 的所有其他 Exporter 有所不同。</p>
<h2 id="处理大计数器值"><a href="#处理大计数器值" class="headerlink" title="处理大计数器值"></a>处理大计数器值</h2><p>为 Counter64 较大的值提供准确的计数器，exporter 将为每 2^53 值自动包装，以避免 64 位浮点舍入。<br>要禁用此功能，请使用命令行参数 <code>--no-snmp.wrap-large-counters</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/private_airport/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/private_airport/" class="post-title-link" itemprop="url">个人小机场</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GFW/" itemprop="url" rel="index"><span itemprop="name">GFW</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这篇笔记主要对 <a href="https://github.com/shadowsocks/shadowsocks-manager" target="_blank" rel="noopener">shadowsocks manager</a> 做一些补充，更详细的内容请查看 <a href="https://shadowsocks.github.io/shadowsocks-manager/#/home" target="_blank" rel="noopener">Shadowsocks manager 官方文档</a>。</p>
<h2 id="shadowsocks-manager"><a href="#shadowsocks-manager" class="headerlink" title="shadowsocks manager"></a>shadowsocks manager</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sL https:&#x2F;&#x2F;deb.nodesource.com&#x2F;setup_10.x | bash -</span><br><span class="line">apt-get -y install nodejs</span><br></pre></td></tr></table></figure>

<h3 id="安装-ssmgr"><a href="#安装-ssmgr" class="headerlink" title="安装 ssmgr"></a>安装 ssmgr</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g shadowsocks-manager --unsafe-perm</span><br></pre></td></tr></table></figure>

<h3 id="配置-systemd"><a href="#配置-systemd" class="headerlink" title="配置 systemd"></a>配置 systemd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;ssmgr-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Shadowsocks Node Service Master 2</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">User&#x3D;root</span><br><span class="line">LimitNOFILE&#x3D;32768</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;ssmgr -c &#x2F;etc&#x2F;ssmgr&#x2F;manager.yml </span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<h3 id="配置-ssmgr"><a href="#配置-ssmgr" class="headerlink" title="配置 ssmgr"></a>配置 ssmgr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/ssmgr</span></span><br><span class="line"><span class="comment"># cat &lt;&lt; EOF &gt; /etc/ssmgr/manager.yml</span></span><br><span class="line"><span class="built_in">type</span>: m</span><br><span class="line">manager:</span><br><span class="line">  address: 172.22.217.6:6789</span><br><span class="line">  password: <span class="string">'password'</span></span><br><span class="line">plugins:</span><br><span class="line">  flowSaver:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">  user:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">  account:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">  email:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">    <span class="built_in">type</span>: <span class="string">'smtp'</span></span><br><span class="line">    username: <span class="string">'17003905536@163.com'</span></span><br><span class="line">    password: <span class="string">'password'</span></span><br><span class="line">    host: <span class="string">'smtp.163.com'</span></span><br><span class="line">  webgui:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">    host: <span class="string">'127.0.0.1'</span></span><br><span class="line">    port: <span class="string">'8080'</span></span><br><span class="line">    <span class="comment"># site: 'http://yourwebsite.com'</span></span><br><span class="line">    <span class="comment"># icon: 'icon.png'</span></span><br><span class="line">    <span class="comment"># skin: 'default'</span></span><br><span class="line">    <span class="comment"># googleAnalytics: 'UA-xxxxxxxx-x'</span></span><br><span class="line">    <span class="comment"># gcmSenderId: '476902381496'</span></span><br><span class="line">    <span class="comment"># gcmAPIKey: 'AAAAGzddLRc:XXXXXXXXXXXXXX'</span></span><br><span class="line">db:</span><br><span class="line">  host: <span class="string">'localhost'</span></span><br><span class="line">  port: 3306</span><br><span class="line">  user: <span class="string">'renkeju'</span></span><br><span class="line">  password: <span class="string">'password'</span></span><br><span class="line">  database: <span class="string">'ssmgr'</span></span><br><span class="line"><span class="comment"># 从 0.30 开始需要配置 redis</span></span><br><span class="line">redis:</span><br><span class="line">  host: <span class="string">'localhost'</span></span><br><span class="line">  port: 6379</span><br><span class="line">  password: <span class="string">'password'</span></span><br><span class="line">  db: 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get -y install mysql-server</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>

<h3 id="安全设置"><a href="#安全设置" class="headerlink" title="安全设置"></a>安全设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>

<h3 id="修改数据库配置"><a href="#修改数据库配置" class="headerlink" title="修改数据库配置"></a>修改数据库配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/mysql/conf.d/mysql.cnf</span><br><span class="line">[client]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">collation-server = utf8_unicode_ci</span><br><span class="line">init-connect=<span class="string">'SET NAMES utf8'</span></span><br><span class="line">character-set-server = utf8</span><br><span class="line"><span class="built_in">bind</span>-address=127.0.0.1</span><br></pre></td></tr></table></figure>

<h3 id="重启数据库"><a href="#重启数据库" class="headerlink" title="重启数据库"></a>重启数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set @@global.sql_mode &#x3D;&#39;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#39;;</span><br><span class="line">create database ssmgr;</span><br><span class="line">grant all privileges on ssmgr.* to ssmgr@localhost identified by &#39;Password&#39;;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt -y install nginx</span><br></pre></td></tr></table></figure>

<h3 id="配置-http"><a href="#配置-http" class="headerlink" title="配置 http"></a>配置 http</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rm -rf &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;default</span><br><span class="line">cat &lt;&lt; &quot;EOF&quot; &gt; &#x2F;etc&#x2F;nginx&#x2F;sites-available&#x2F;ssmgr</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  wg.renkeju.com;</span><br><span class="line">    # return       301 https:&#x2F;&#x2F;$server_name$request_uri;</span><br><span class="line">    </span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">        proxy_set_header   Host             $http_host;</span><br><span class="line">        proxy_set_header   X-Frame-Options  DENY;</span><br><span class="line">        proxy_pass         http:&#x2F;&#x2F;127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 &#x2F;404.html;</span><br><span class="line">        location &#x3D; &#x2F;40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">ln -s &#x2F;etc&#x2F;nginx&#x2F;sites-&#123;available,enabled&#125;&#x2F;ssmgr</span><br></pre></td></tr></table></figure>

<h3 id="安装-certbot"><a href="#安装-certbot" class="headerlink" title="安装 certbot"></a>安装 certbot</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install software-properties-common</span><br><span class="line">$ sudo add-apt-repository universe</span><br><span class="line">$ sudo add-apt-repository ppa:certbot&#x2F;certbot</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get -y install certbot python-certbot-nginx</span><br></pre></td></tr></table></figure>

<h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo certbot --nginx</span><br></pre></td></tr></table></figure>

<h3 id="配置-https"><a href="#配置-https" class="headerlink" title="配置 https"></a>配置 https</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; &quot;EOF&quot; &gt; &#x2F;etc&#x2F;nginx&#x2F;sites-available&#x2F;ssmgr_ssl</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  wg.renkeju.com;</span><br><span class="line">    ssl_certificate &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;wg.renkeju.com&#x2F;fullchain.pem; # managed by Certbot</span><br><span class="line">    ssl_certificate_key &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;wg.renkeju.com&#x2F;privkey.pem; # managed by Certbot</span><br><span class="line">    include &#x2F;etc&#x2F;letsencrypt&#x2F;options-ssl-nginx.conf; # managed by Certbot</span><br><span class="line">    ssl_dhparam &#x2F;etc&#x2F;letsencrypt&#x2F;ssl-dhparams.pem; # managed by Certbot</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">        proxy_set_header   Host             $http_host;</span><br><span class="line">        proxy_set_header   X-Frame-Options  DENY;</span><br><span class="line">        proxy_pass         http:&#x2F;&#x2F;127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 &#x2F;404.html;</span><br><span class="line">        location &#x3D; &#x2F;40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">ln -s &#x2F;etc&#x2F;nginx&#x2F;sites-&#123;available,enabled&#125;&#x2F;ssmgr_ssl</span><br></pre></td></tr></table></figure>

<h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now nginx</span><br></pre></td></tr></table></figure>

<h2 id="Shadowsocks"><a href="#Shadowsocks" class="headerlink" title="Shadowsocks"></a>Shadowsocks</h2><h3 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt -y install shadowsocks-libev</span><br></pre></td></tr></table></figure>

<h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; &#x2F;etc&#x2F;ssmgr&#x2F;server.yml</span><br><span class="line">type: s</span><br><span class="line">shadowsocks:</span><br><span class="line">  address: 127.0.0.1:6001</span><br><span class="line">manager:</span><br><span class="line">  address: 0.0.0.0:4002</span><br><span class="line">  password: &#39;password&#39;</span><br><span class="line">db: &#39;db.sqlite&#39;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="ssmgr-server-systemd"><a href="#ssmgr-server-systemd" class="headerlink" title="ssmgr-server systemd"></a>ssmgr-server systemd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;lib&#x2F;systemd&#x2F;system&#x2F;ssmgr-server.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Shadowsocks Manager Server mode Service</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">User&#x3D;root</span><br><span class="line">LimitNOFILE&#x3D;32768</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;ssmgr -c &#x2F;etc&#x2F;ssmgr&#x2F;server.yml -r libev:aes-256-cfb</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl --now enable ssmgr-server</span><br></pre></td></tr></table></figure>

<h2 id="wireguard"><a href="#wireguard" class="headerlink" title="wireguard"></a>wireguard</h2><h3 id="安装-tables-addons"><a href="#安装-tables-addons" class="headerlink" title="安装 tables-addons"></a>安装 tables-addons</h3><p>安装 iptables geoip 模块依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install iptables-dev xtables-addons-common libtext-csv-xs-perl pkg-config libnet-cidr-lite-perl</span><br></pre></td></tr></table></figure>

<p>下载并编译 xtables-addons（所需 kernel 版本 4.15）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;downloads.sourceforge.net&#x2F;project&#x2F;xtables-addons&#x2F;Xtables-addons&#x2F;xtables-addons-3.3.tar.xz</span><br><span class="line">tar xf xtables-addons-3.3.tar.xz</span><br><span class="line">cd xtables-addons-3.3</span><br><span class="line">.&#x2F;configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">cd geoip</span><br><span class="line">make install</span><br><span class="line">mkdir -p &#x2F;usr&#x2F;share&#x2F;xt_geoip</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;libexec&#x2F;xtables-addons</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;libexec&#x2F;xtables-addons&#x2F;xt_geoip_dl</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;libexec&#x2F;xtables-addons&#x2F;xt_geoip_build -D &#x2F;usr&#x2F;share&#x2F;xt_geoip -S &#x2F;usr&#x2F;share&#x2F;xt_geoip&#x2F;GeoLite2-Country-CSV_$(date &#39;+%Y%m%d&#39;)</span><br></pre></td></tr></table></figure>

<h3 id="开启转发"><a href="#开启转发" class="headerlink" title="开启转发"></a>开启转发</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">net.ipv4.ip_forward&#x3D;1</span><br><span class="line">sysctl -p</span><br><span class="line">echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br></pre></td></tr></table></figure>

<h3 id="开启松散的源地址校验"><a href="#开启松散的源地址校验" class="headerlink" title="开启松散的源地址校验"></a>开启松散的源地址校验</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;ens3&#x2F;rp_filter</span><br><span class="line">echo &quot;net.ipv4.conf.ens3.rp_filter&#x3D;2&quot; &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="安装-4"><a href="#安装-4" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo add-apt-repository ppa:wireguard/wireguard</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install wireguard</span><br></pre></td></tr></table></figure>

<h3 id="生成服务端密钥对"><a href="#生成服务端密钥对" class="headerlink" title="生成服务端密钥对"></a>生成服务端密钥对</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;wireguard&#x2F;</span><br><span class="line">wg genkey | tee privatekey | wg pubkey &gt; publickey</span><br></pre></td></tr></table></figure>

<h3 id="生成环境变量"><a href="#生成环境变量" class="headerlink" title="生成环境变量"></a>生成环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export SERVER_IP_ADDRESS&#x3D;$(curl icanhazip.com)</span><br><span class="line">export SPRIVATE&#x3D;$(cat privatekey)</span><br><span class="line">export SPUBLIC&#x3D;$(cat publickey)</span><br></pre></td></tr></table></figure>

<h3 id="增加配置文件"><a href="#增加配置文件" class="headerlink" title="增加配置文件"></a>增加配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/wireguard/</span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/wireguard/wg0.conf</span><br><span class="line">[Interface]</span><br><span class="line">Address = 10.100.0.1/16</span><br><span class="line">ListenPort = 49999</span><br><span class="line">PostUp   = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE; iptables -t nat -A POSTROUTING -o ens7 -j MASQUERADE; iptables -t mangle -A PREROUTING -i wg0 -m geoip --destination-country CN -j MARK --<span class="built_in">set</span>-mark 2</span><br><span class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE; iptables -t nat -D POSTROUTING -o ens7 -j MASQUERADE; iptables -t mangle -D PREROUTING -i wg0 -m geoip --destination-country CN -j MARK --<span class="built_in">set</span>-mark 2</span><br><span class="line">PrivateKey = <span class="variable">$SPRIVATE</span></span><br><span class="line">MTU = 1420</span><br><span class="line">DNS = 1.1.1.1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="开机启动-1"><a href="#开机启动-1" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl --now disable ufw</span><br><span class="line"># systemctl --now enable wg-quick@wg0</span><br></pre></td></tr></table></figure>

<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># wg show</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: xE1SNRHKGDppk0+b7fdmy2+YydXm6kzx6iOkiP5uc1U&#x3D;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 50000</span><br></pre></td></tr></table></figure>

<h3 id="shadowsocks-manager-wireguard"><a href="#shadowsocks-manager-wireguard" class="headerlink" title="shadowsocks-manager-wireguard"></a>shadowsocks-manager-wireguard</h3><p>安装 nodejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sL https:&#x2F;&#x2F;deb.nodesource.com&#x2F;setup_8.x | bash -</span><br><span class="line">apt-get install nodejs</span><br></pre></td></tr></table></figure>

<p>获取项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;gyteng&#x2F;shadowsocks-manager-wireguard.git</span><br></pre></td></tr></table></figure>

<p>添加 systemd 环境配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;opt&#x2F;shadowsocks-manager-wireguard&#x2F;env</span><br><span class="line">GATEWAY&#x3D;10.100.0.1</span><br><span class="line">MANAGER_IP_ADDRESS&#x3D;0.0.0.0</span><br><span class="line">MANAGER_PORT&#x3D;6002</span><br><span class="line">PASSWORD&#x3D;password</span><br><span class="line">INTERFACE&#x3D;wg0</span><br><span class="line">DATABASE_FILE_PATH&#x3D;&#x2F;opt&#x2F;shadowsocks-manager-wireguard&#x2F;data.json</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>编辑 systemd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; &quot;EOF&quot; &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;ssmgr-wireguard.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Shadowsocks Manager Wireguard</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;&#x2F;opt&#x2F;shadowsocks-manager-wireguard&#x2F;env</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">User&#x3D;root</span><br><span class="line">LimitNOFILE&#x3D;32768</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;opt&#x2F;shadowsocks-manager-wireguard</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;node index \</span><br><span class="line">--gateway $&#123;GATEWAY&#125; \</span><br><span class="line">--manager $&#123;MANAGER_IP_ADDRESS&#125;:$&#123;MANAGER_PORT&#125; \</span><br><span class="line">--password $&#123;PASSWORD&#125; \</span><br><span class="line">--interface $&#123;INTERFACE&#125; \</span><br><span class="line">--db $&#123;DATABASE_FILE_PATH&#125;</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl --now enable ssmgr-wireguard</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Keju Ren"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Keju Ren</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/renkeju" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;renkeju" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:renkeju@gmail.com" title="E-Mail → mailto:renkeju@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Keju Ren</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
