<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.renkeju.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="时光穿梭机">
<meta property="og:url" content="https://blog.renkeju.com/index.html">
<meta property="og:site_name" content="时光穿梭机">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Keju Ren">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="Cloud">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.renkeju.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>时光穿梭机</title>
  
    <script>
      function sendPageView() {
        if (CONFIG.hostname !== location.hostname) return;
        var uid = localStorage.getItem('uid') || (Math.random() + '.' + Math.random());
        localStorage.setItem('uid', uid);
        navigator.sendBeacon('https://www.google-analytics.com/collect', new URLSearchParams({
          v  : 1,
          tid: 'UA-149464655-1',
          cid: uid,
          t  : 'pageview',
          dp : encodeURIComponent(location.pathname)
        }));
      }
      document.addEventListener('pjax:complete', sendPageView);
      sendPageView();
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">时光穿梭机</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">穿梭时间的飞行日志</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/07/29/haproxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/29/haproxy/" class="post-title-link" itemprop="url">haproxy</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-07-29 23:11:10 / 修改时间：23:13:53" itemprop="dateCreated datePublished" datetime="2020-07-29T23:11:10+08:00">2020-07-29</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="HAproxy-简介"><a href="#HAproxy-简介" class="headerlink" title="HAproxy 简介"></a>HAproxy 简介</h2><p>HAProxy 提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy 特别适用于那些负载特别大的 web 站点，这些站点通常又需要会话保持和七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中，同时可以保护你的web服务器不被暴露在公网当中。</p>
<p>HAProxy 实现了一种事件驱动，单一进程模型，此模型支持非常大的并发连接数，多进程或多线程模型受内存限制、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的时间和资源管理的用户端（user-space）实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，此程序的扩展性通常比较差。这就是为什么他们必须进行优化以使得每个CPU时间片（Cycle）做更多的工作。</p>
<h2 id="HAProxy-版本"><a href="#HAProxy-版本" class="headerlink" title="HAProxy 版本"></a>HAProxy 版本</h2><p>HAProxy 目前主要有两个版本：</p>
<h3 id="1-4"><a href="#1-4" class="headerlink" title="1.4"></a>1.4</h3><blockquote>
<p> 提供较好的弹性，衍生于 1.2 版本，并提供了额外的新特性，其中大多数是期待已久的。</p>
</blockquote>
<ul>
<li>客户端侧的长连接（client-side keep-alive）</li>
<li>TCP 加速（TCP Speedups）</li>
<li>响应池（response buffering）</li>
<li>RDP 协议</li>
<li>基于源的粘性（source-based stickiness）</li>
<li>更好的统计数据数据接口（a much better stats interfaces）</li>
<li>更详细的健康状态监测机制（more verbose health checks）</li>
<li>基于流量的健康评估机制（traffice-based health）</li>
<li>支持 http 认证</li>
<li>服务器管理命令行接口（server management from the CLI）</li>
<li>基于 ACL 的持久性（ACL-based persistence）</li>
<li>日志分析器</li>
</ul>
<h3 id="1-3"><a href="#1-3" class="headerlink" title="1.3"></a>1.3</h3><blockquote>
<p>内容交换和超强负载：衍生于 1.2 版本，提供了额外的新特性</p>
</blockquote>
<ul>
<li>ACL：编写内容交换规则</li>
<li>复杂均衡算法（load-balacing algorithms）：更多算法的支持</li>
<li>内容探测（connect inspecion）：阻止非授权协议</li>
<li>透明代理（transparent proxy）：在Linux 客户端上允许使用客户端IP直接连入服务器</li>
<li>内核 TCP 拼接（kernel TCP splicing）：无 copy 方式在客户端和服务端之间转发数据以实现数G级别的数据速率</li>
<li>分层设计（layered design）：分别实现套接字、TCP、HTTP处理以提供更好的健壮性、更快的处理机制以及便捷的演进能力</li>
<li>快速、公平调度器（fast and fair scheduler）：为某些服务指定优先级可实现理好的QoS</li>
<li>会话速率限制（session rate limiting）：适用于托管环境</li>
</ul>
<h3 id="支持的平台及OS"><a href="#支持的平台及OS" class="headerlink" title="支持的平台及OS"></a>支持的平台及OS</h3><ul>
<li>x86、x86_64、Alpha、SPARC、MIPS及PARISC平台上的 Linux 2.4</li>
<li>x86、x86_64、ARM（ixp425）以及PPC64平台上的Linux 2.6</li>
<li>UltraSPARC 2 和 3 上的 Solaris 10</li>
<li>X86 平台上的 FreeBSD 4.1-8</li>
<li>i386、amd64、macppc、alpha、sparc64和VAX平台上的 OpenBSD 3.1-current</li>
</ul>
<p>要获得最高性能，需要在Linux 2.6 或打了 epoll 补丁的 Linux 上运行 haproxy 1.2.5 以上的版本。haproxy 1.11 默认使用的 polling 系统为 <code>select()</code>，其处理的文件数达千个时性能便会急剧下降。1.2 和 1.3 版本默认为 <code>poll()</code>，在有些操作系统上可能会有性能方面的问题，但在Solaris上表现的相当不错，HAProxy 1.3 在 Linux 2.6 以及打了 epoll 补丁的 Linux 上默认使用 epoll，在 FreeBSD 上使用kqueue，这两种机制在任何负载上都能提供恒定的性能表现。</p>
<p>在较新的版本的 Linux 2.6 (&gt;=2.6.27.19)上，HAProxy 还能够使用 splice() 系统调用在接口间无复制地转发任何数据，这甚至可以达到10GB的性能。</p>
<p>基于以上事实，在 x86 或 x86_64 平台上，要获得最好性能的负载均衡器，建议按照以下顺序参考方案：</p>
<ul>
<li>Linux 2.6.32 及以后的版本上运行 HAProxy 1.4</li>
<li>打了 epoll 补丁的 Linux 运行 HAProxy 1.4 </li>
<li>FreeBSD 运行 HAProxy 1.4</li>
<li>Solaris 10 上运行 HAProxy 1.4</li>
</ul>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><p>HAProxy 借助OS上几种常见的技术来实现性能上的最大化</p>
<ul>
<li>单进程、事件驱动模型显著降低了上下文切换的开销及内存占用</li>
<li>O(1) 事件检查器（event check）允许其在高并发连接中对任何连接的任何事件实现即时探测</li>
<li>在任何可用的情况下，单缓冲（single buffering）机制能以不复制任何数据的方式完成读写操作，这会节约大量的CPU时钟周期及内存带宽</li>
<li>借助于 Linux 2.6 (&gt;=2.6.27.16) 上的 splice() 系统调用，HAProxy 能实现零复制转发（Zero-copy forwarding），在 Linux 3.5 及以上的 OS 中还可以实现零复制启动（zero-starting）</li>
<li>MRU 内存分配器在固定大小的内存池中可以实现即时内存分配，这能显著减少创建一个会话的时长</li>
<li>树形存储：侧重于使用作者多年前开发的弹性二叉树，实现了以 O(log(N)) 的低开销来保持计时器的命令、保持运行队列命令及管理轮循及最少连接队列</li>
<li>优化的 HTTP 首部分析：优化的首部分析功能避免了在 HTTP 首部分析的过程中重读任何内存区域</li>
<li>精心的降低了昂贵的系统调用，大部分工作都在用户空间完成，如时间读取、缓冲聚合及文件描述符的启用和禁用等</li>
</ul>
<p>所有的这些细微之处的优化实现了在中等规模负载之上依然有着相当低的 CPU 负载，甚至在非常高的负载场景中，%5的用户空间占用率和%95的系统空间占用率也是非常普遍的现象，这意味着 HAProxy 进程消耗比系统空间消耗低二十倍以上。因此，对OS进行性能调优是非常重要的。即是用户空间的占用率提高一倍，其CPU占用率也仅为%10，这也解释了为何7层处理对性能影响有限这一现象。由此，在高端系统上HAProxy 的7层性能可以轻易超过硬件负载均衡设备。</p>
<p>在生产环境中，在7层处理上使用  HAProxy 作为昂贵的高端硬件负载均衡设备故障时的紧急解决方案也时长可见。硬件负载均衡设备在“报文”级别处理请求，这在支持跨报文请求（request across multiple packets）有着较高的难度，并且它们不缓冲任何数据，因此有着较长的响应时间，对应地，软件负载均衡设备使用TCP 缓冲，可建立极长的请求，且有着较大的相应时间。</p>
<p>可以从三个因素评估负载均衡器的性能：</p>
<ol>
<li>会话率</li>
<li>会话并发能力</li>
<li>数据率</li>
</ol>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="配置文件格式"><a href="#配置文件格式" class="headerlink" title="配置文件格式"></a>配置文件格式</h3><p>HAProxy 配置处理3类主要参数来源</p>
<ol>
<li>最优先处理的命令行参数</li>
<li>“global” 配置段，用于设定全局配置参数</li>
<li>proxy 相关配置段，如“defaults”，“listen”，“frontend”和“backend”</li>
</ol>
<h3 id="时间格式"><a href="#时间格式" class="headerlink" title="时间格式"></a>时间格式</h3><p>一些包含了值的参数表示时间，如超时时长。这些值一般以毫秒为单位，但也可以使用其他时间单位后缀。</p>
<ul>
<li>us: 微秒（microseconds），即 1/1000000 秒</li>
<li>ms: 毫秒（milliseconds），即 1/1000 秒</li>
<li>s：秒（seconds）</li>
<li>m：分钟（minutes）</li>
<li>h：小时（hours）</li>
<li>d：天（days）</li>
</ul>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>下面的例子配置了一个监听在所有接口的80端口上http proxy 服务，它转发所有的请求至后端监听在 <code>127.0.0.1:8000</code> 上的 “server”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">	daemon</span><br><span class="line">	maxconn 256</span><br><span class="line">	</span><br><span class="line">defaults</span><br><span class="line">	mode http</span><br><span class="line">	timeout connect 5000ms</span><br><span class="line">	timeout client 50000ms</span><br><span class="line">	timeout server 50000ms</span><br><span class="line">	</span><br><span class="line">fronrend http-in</span><br><span class="line">	bind *:80</span><br><span class="line">	default-backend servers</span><br><span class="line">	</span><br><span class="line">backend servers</span><br><span class="line">	server server1 127.0.0.1:8080 maxconn 32</span><br></pre></td></tr></table></figure>



<h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><p>“global” 配置中的参数为进程级别的参数，且通常与其运行的OS相关</p>
<ul>
<li>进程管理及安全相关的参数<ul>
<li>chroot &lt;jail di&gt; : 修改 haproxy 的工作目录至指定的目录并在放弃权限之前执行 chroot() 操作，可以提升 haproxy 安全级别，不过需要注意的是要确保指定的目录为空目录且任何用户均不能有写权限</li>
<li>daemon : 让 haproxy 以进程的方式工作于后台，其等同于“-D”选项的功能，当然，也可以在命令行中以 “-db” 选项将其禁用</li>
<li>gid &lt;number&gt; : 以指定的GID运行haproxy，建议使用专用于运行 HAProxy 的 GID，以免权限问题带来风险</li>
<li>group &lt;Group Name&gt; : 同 GID 不过指定的是组名</li>
<li>log &lt;address&gt; &lt;facility&gt; [max level [min level]] : 定义全局的 syslog 服务器，最多可以定义两个</li>
<li>Log-send-hostname [&lt;string&gt;] :  在 syslog 信息的首部添加当前主机名，可以为 “string” 指定名称，也可以缺省使用当前主机名</li>
<li>nbproc &lt;numbe&gt; : 指定启动的 haproxy 进程个数，只能用与守护进程模式的 HAProxy，默认只启动一个进程，鉴于调试困难等多方面的原因，一般只在单进程仅能打开少数文件描述符的场景中才能使用多进程模式</li>
<li>pidfile :</li>
<li>uid &lt;number&gt; :  以指定的 UID 身份运行 haproxy 进程</li>
<li>ulimit-n : 设定每进程能够打开的最大文件描述符数量，默认情况下其会自动进行计算，因此不推荐修改此项</li>
<li>user : 同UID，但使用的是用户名</li>
<li>stats :</li>
<li>node :</li>
<li>description : 当前实例的描述信息</li>
</ul>
</li>
<li>性能调整先关参数<ul>
<li>maxconn &lt;number&gt; : 设定每个 haproxy 进程所接受的最大并发连接数，其等同于命令行选项<code>-n</code> <code>ulimit -n</code> 自动计算的结果正是参照此参数设定的</li>
<li>maxpipes &lt;number&gt; : haproxy 使用 pipe 完成了基于内核的 TCP 报文重组，此选项则用于设定每个进程所允许使用最大的 pipe 个数，每个 pipe 会打开两个文件的描述符。因此，<code>ulimit -n</code> 自动计算时会根据需要调大此值；默认为 maxconn/4，其通常会显示的过大。</li>
<li>noepoll : 在 Linux 系统上禁用 epoll 机制</li>
<li>nokqueue : 在 BSE 系统上禁用 kqueue 机制</li>
<li>nopoll : 禁用 poll 机制</li>
<li>nosepoll : 禁止在 Linux 套接字上使用内核 tcp 重组，这会导致更多的 recv/send 系统调用；不过，在 Linux 2.6.25-28 系列的内核上，tcp 重组功能有 bug 存在</li>
<li>spread-check &lt;0-50, in percent&gt; : 在 haproxy 后端有着众多服务器的场景中，在精确的时间间隔后统一对众服务器进行健康状态检测可能会带来意外问题；此选项用于将其检测的时间间隔长度上增加或减小一定的随机时长</li>
<li>tune.bufsize &lt;number&gt; : 设定 buffer 的大小，同样的条件内存小，较小的值可以让 haproxy 有能力接收更多的并发连接，较大的值可以让某些应用程序使用较大 cookie 信息，默认为 16384，其可以在编译时修改，不过强烈建议使用默认值。</li>
<li>tune.chksize &lt;number&gt; : 设定检查缓冲区的大小，单位为字节；更大的值有助于在较大的页面中完成基于字符串或模式的文本查找，但也会占用更多的系统资源；不建议修改</li>
<li>tune.maxaccept &lt;number&gt; : 设定 haproxy 进程内核调度运行时一次性可以接受的连接的个数，较大的值可以带来较大的吞吐率，默认单进程模式下为 100，多进程模式下为 8，设定为 -1 可以禁止此限制；一般不建议修改</li>
<li>tune.maxpollevents &lt;number&gt; : 设定一次系统调用可以处理的事件最大数，默认值取决于OS，其值小于 200 时可以节约带宽，但会略微增大网络延迟，而大于 200 时会降低延迟，但会稍稍增加网络带宽的占用量</li>
<li>tune.maxrewrite &lt;number&gt;: 设定为首部重写或追加而预留的缓冲空间，建议使用1024 左右的大小，在需要使用更大空间的，haproxy 会自动增加其值</li>
<li>tune.rcvbuf.client &lt;number&gt; :</li>
<li>tune.rcvbuf.server &lt;number&gt; : 设定内核嵌套字中服务端或客户端接收缓冲的大小，单位为字节；强烈推荐使用默认值</li>
<li>tune.sndbuf.client</li>
<li>tune.sndbuf.server</li>
</ul>
</li>
<li>DeBug 相关参数<ul>
<li>debug</li>
<li>quiet </li>
</ul>
</li>
</ul>
<h3 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h3><p>代理相关配置可以如下相关配置中</p>
<ul>
<li>defaults &lt;name&gt;</li>
<li>frontend &lt;name&gt;</li>
<li>backend &lt;name&gt;</li>
<li>listen &lt;name&gt;</li>
</ul>
<p><code>defaults</code> 段用于为所有其他配置提供默认参数，这配置默认配置参数可由下一个 <code>defaults</code> 所重新设定</p>
<p><code>frontend</code> 段用于定义一系列监听的套接字，这些套接字可以接收客户端的请求并与之建立连接</p>
<p><code>backend</code> 段用于定义一系列“后端”服务器，代理将对应客户端的请求转发至这些服务器</p>
<p><code>listen</code> 段通过关联“前端”和“后端”定义了一个完整的代理，通常只对TCP流量有用</p>
<p>所有名称只能使用大写字母、小写字母、数字、<code>-</code>（中划线）、<code>_</code>（下划线）、<code>.</code>（点）和 <code>:</code>冒号。此外，ACL名称会区分字母大小写</p>
<h3 id="配置文件中的关键字参考"><a href="#配置文件中的关键字参考" class="headerlink" title="配置文件中的关键字参考"></a>配置文件中的关键字参考</h3><h4 id="balance"><a href="#balance" class="headerlink" title="balance"></a>balance</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">balance &lt;algorithm&gt; [&lt;arguments&gt;]</span><br><span class="line">balance url_param &lt;param&gt; [check_post [&lt;max_wait&gt;]]</span><br></pre></td></tr></table></figure>



<p>定义负载均衡的算法，可用于 “defaults”、“listen“和“bakcend”。&lt;algorithm&gt;</p>
<p>用于在负载均衡场景中挑选一个server，其仅应用于持久信息不可用的条件下或需要将一个连接重新派发至另外一个服务器时。支持的算法有：</p>
<ul>
<li>roundrobin : 基于权重进行轮叫，在服务器的处理时间保持均匀分布时，这是最平衡最公平的算法。此算法是动态的，这表示其权重可以在运行时进行调整，不过，在设计上，每个后端服务器最多只能接受4128个连接。</li>
<li>static-rr : 基于权重进行轮叫，与 roundrobin 类似，但是为静态方法，在运行时调整其服务器权重不会生效；不过，其在后端服务器连接数上没有限制</li>
<li>leastconn : 新的连接请求被派发至具有最少连接数目的后端服务器：在有着较长回话连接的场景中推荐使用此算法，如 LDAP、SQL等，其并不太适用于较短会话的应用层协议，如 HTTP。此算法是动态的，可以在运行时调整其权重。</li>
<li>source : 将请求的源地址进行 hash 运算，并由后端服务器的权重总数相除后派发至某匹配的服务器；这可以使得同一个客户端IP的请求始终被派发至某特定的服务器；不过当服务器权重总数发生变化时，如果某服务器宕机或添加了新的服务器，许多客户端的请求可能会被派发至与此前请求不同的服务器；常用于负载均衡无cookie功能的基于TCP的协议；其默认为静态，不过也可以使用 hash-type 修改此特性。</li>
<li>uri : 对 URI 的有左半部分（“问题”标记之前的部分）或整个 URI 进行 hash 运算，并由服务器的总权重相除后派发至某特定的服务器；这可以使得对同一个URI的请求总是被派发至特定的服务器，除非服务器的权重总数发生了变化；此算法常用于代理缓存或反病毒代理以提高缓存的命中率；需要注意的是，此算法仅用于HTTP后端服务器场景；其默认为静态算法，不过也可以使用 hash-type 修改此特性。</li>
<li>url_param :  通过 &lt;argument&gt; 为URL指定的参数在每个 HTTP GET 请求中将会被检索：如果找到了指定的参数且其通过等于号<code>=</code>被赋予了一个值，那么此值将被执行 hash 运算并被服务器的总权重相除后派发至某匹配的服务器；此算法可以通过追踪请求中的用户标识进而确保同一个用户ID的请求将被发往同一个特定的服务器，除非服务器的总权重发生了变化；如果某请求中没有出现指定的参数或其没有有效值，则使用轮叫算法对相应请求进行调度；此算法默认为静态的，不过其可以使用 hash-type 修改此特性；</li>
<li>hdr&lt;name&gt;) : 对于每个 HTTP 请求，通过 &lt;name&gt; 指定的HTTP首部将会被检索：如果相应的首部没有出现或其没有有效值，则使用轮叫算法对相应请求进行调度；其有一个可选选项 <code>use_daemon_only</code> ，可以在指定检索类似 host 类的首部时仅计算域名部分（比如通过 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 来说，仅计算 baidu 字符串的 hash 值）以降低 hash 算法的计算量；此算法默认是静态的，不过其也可以使用 hash-type 修改此特性</li>
<li>rdp-cookie</li>
<li>rdp-cookie(name) : </li>
</ul>
<h4 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind [&lt;address&gt;]:&lt;port_range&gt; [,...]</span><br><span class="line">bind [&lt;address&gt;]:&lt;port_range&gt; [,...] interface &lt;interface&gt;</span><br></pre></td></tr></table></figure>

<p>此指令仅能用于<code>frontend</code>和<code>listen</code>区段，用于定义一个或几个监听的套接字。</p>
<ul>
<li>&lt;address&gt; : 可选选项，其可以为主机名、IPv4 地址、IPv6 地址或 *；省略此选项、将其指定为 * 或 0.0.0.0 时，将监听当前系统所有 IPv4 地址；</li>
<li>&lt;port_range&gt; : 可以是一个特定的TCP端口，也可以是一个端口范围（如5005-5010），代理服务器将通过指定的端口来接收客户端的请求；需要注意的是，每组监听的套接字 &lt;address:port&gt; 在同一个实例上只能使用一次，而且小于 1024 的端口需要有特定权限的用户才能使用，这可能需要通过 uid 参数来定义；</li>
<li>&lt;interface&gt; : 指定物理接口的名称，仅能在Liunx 系统上使用；其不能使用接口别名，而仅能使用物理接口名称，而且只有管理有权限指定绑定的物理接口</li>
</ul>
<h4 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mode &#123;tcp|http|health&#125;</span><br></pre></td></tr></table></figure>

<p>设定实例的运行模式或协议。当实现内容交换时，前端和后端必须工作于同一种模式（一般来说都是 HTTP 模式），否则将无法启动实例。</p>
<ul>
<li>tcp : 实例运行于纯 TCP 模式，在客户端和服务端之间将建立一个全双工的连接，且不会对7层报文做任何类型的检查；此为默认模式，通常用于 SSL、SSH、SMTP 等应用</li>
<li>http : 实例运行于 HTTP 模式，客户端请求在转发至后端服务器之前将被深度分析，所有不与RFC格式兼容的请求都会被拒绝；</li>
<li>health : 实例工作于 health 模式，其对入站请求仅响应”ok“信息并关闭连接，且不会记录任何日志信息；此模式将用于响应外部组件的健康状态检查请求；目前来讲，此模式已经废弃，因为tcp和http模式中的 monitor 关键字可以完成类似的功能</li>
</ul>
<h4 id="hash-type"><a href="#hash-type" class="headerlink" title="hash-type"></a>hash-type</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash-type &lt;method&gt;</span><br></pre></td></tr></table></figure>

<p>定义用于将 hash 码映射至后端服务器的方法：其不能用于frontend区段；可用的方法有 map-based 和 consistent，在大多数场景下推荐使用默认的 map-based 方法。</p>
<ul>
<li>map-based : hash 表是一个包含了所有在线服务器的静态数组，其 hash 值将会非常的平滑，会将权重考虑在列，但其为静态方法，对在线服务器的权重进行调整将不会生效，这意为这其不支持慢速启动。此外，挑选服务器是根据其在数组中的位置进行的，因此，当一台服务器宕机或添加了一台新的服务器时，大多数连接将会被重新派发至一个与此前不通的服务器上，对于缓存服务器的工作场景来说，此方法不甚使用。</li>
<li>consistent : hash 表是一个由各服务器填充而成的树状结构：基于 hash 键在 hash 树中查找相应的服务器时，最近的服务器将被选中，此方法是动态的，支持在运行时修改服务器权重，因此兼容慢速启动的特性，添加一个新的服务器时，仅会对一小部分请求产生影响，因此，由其适用于后端服务器为 cache 场景，不过，此算法不甚平滑，派发至各服务器的请求未必能达到理想的理想的均衡效果，因此，可能需要不时的调整服务器的权重以获得更好的均衡性。</li>
</ul>
<h4 id="log"><a href="#log" class="headerlink" title="log"></a>log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log global</span><br><span class="line">log &lt;address&gt; &lt;facility&gt; [&lt;level&gt; [&lt;minlevel&gt;]]</span><br></pre></td></tr></table></figure>

<p>为每个实例启用时间和流量日志，因此可用于所有区段，每个实例最多可以指定两个 log 参数，不过，如果使用了 <code>log global</code> 且<code>global</code> 段已经定了 log 参数时，多余的 log 参数将被忽略。</p>
<ul>
<li>global : 当前实例的日志系统参数同 <code>global</code> 段中的定义时，将使用此格式；每个实例仅能定义一次 <code>log global</code> 语句，且其没有任何额外的参数。</li>
<li>&lt;address&gt; : 定义日志发往的位置，其格式之一可以为 &lt;IPv4_address:PORT&gt;，其中的port为 UDP 协议的端口，默认为 514：格式之二为Unix套接字文件路径，但需要留心 chroot 应用及用户的读写权限。</li>
<li>&lt;facility&gt; : 可以为 syslog 系统的标准 facility 之一。</li>
<li>&lt;level&gt; : 定义日志级别，即输出信息过滤器，默认为所有信息；指定级别是，所有等于或高于此级别的日志信息将被发送</li>
</ul>
<h4 id="maxconn"><a href="#maxconn" class="headerlink" title="maxconn"></a>maxconn</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxconn &lt;conns&gt;</span><br></pre></td></tr></table></figure>

<p>设定一个前端的最大并发连接数，因此，其不能用于 backend 区段，对于大型站点来说，可以尽可能提高此值以便让 haproxy 管理链接队列，从而避免无法应答用户请求，当然，此最大值不能超出 <code>global</code> 段中的定义。此外，需要留心的是，haproxy 会为每个链接维持两个缓冲，每个缓冲的大小为 8 KB，再加上其他的数据，每个连接将大约占用 17 KB 的 RAM 空间。这意味着经过适当优化后，有着 1GB 的可用 RAM 空间时将能能为 40000-50000 并发连接。</p>
<p>如果为 &lt;conns&gt; 指定了一个过大值，极端场景下，其最终占据的空间可能会超出当前主机的可用内存，这可能会带来意想不到的结果；因此，将其设定了一个可以接受的值方为明智之选，其默认为 2000</p>
<h4 id="default-backend"><a href="#default-backend" class="headerlink" title="default_backend"></a>default_backend</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_backend &lt;backend&gt;</span><br></pre></td></tr></table></figure>

<p>在没有匹配的 <code>use backend</code> 规则时为实例指定使用的默认后端，因此，其不可应用于 backend 区段，在 <code>frontend</code> 和 <code>backend</code> 之间进行内容交换时，通常使用 <code>use-backend</code> 定义其匹配规则；而没有被规则匹配到的请求将由此参数指定的后端接收。</p>
<ul>
<li>&lt;backend&gt; : 指定使用的后端的名称</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use_backend	dynamic if	url_dyn</span><br><span class="line">use_backend	static	if url_css url_img extension_img</span><br><span class="line">default_backend	dynamic</span><br></pre></td></tr></table></figure>



<h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server &lt;name&gt; &lt;address&gt;[:port] [param*]</span><br></pre></td></tr></table></figure>

<p>为后端声明一个 server，因此，不能用于 defaults 和 frontend 区段</p>
<ul>
<li>&lt;name&gt; : 为此服务器指定的内部名称，其将出现在日志即警告信息中；如果设定了 <code>http-send-server-name</code>，它还将被添加至发往此服务器的请求首部中；</li>
<li>&lt;address&gt; : 此服务器的 IPv4 地址，也支持使用可解析的主机名，只不过在启动时需要解析主机名至相应的IPv4地址；</li>
<li>[:port] : 指定将连接请求所发往的此服务器的目标端口，其为可选项；未设定时，将使用客户端请求时的同一相同端口</li>
<li>[param*] : 为此服务器设定的一系列参数：其可用的参数非常多，具体请参考官方文档中的说明，下面仅说明几个常用的参数：</li>
</ul>
<p>服务器或默认服务器参数：</p>
<ul>
<li>backup : 设定为备用服务器，仅在负载均衡场景中的其他 server 均不可用于启用此 server;</li>
<li>check : 启动对此 server 执行健康状态检查，其可以借助于额外的其他参数完成更精细的设定，如：<ul>
<li>Inter &lt;delay&gt; : 设定健康状态检查的时间间隔，单位为毫秒，默认为 2000；也可以使用 fastinter 和 downinter 来根据服务器状态优化此时间延迟；</li>
<li>rise &lt;count&gt; : 设定健康状态检查中，某离线的 server 从离线状态转换至正常状态需要成功检查的次数；</li>
<li>fall &lt;count&gt; : 确认 server 从正常状态转换为不可用状态需要检查的次数；</li>
</ul>
</li>
<li>cookie &lt;value&gt; : 为指定 server 设定 cookie 值，此处指定的值将在请求入站时被检查，第一次为此值挑选的 server 将在后续的请求中被选中，其目的在于实现持久连接的功能；</li>
<li>maxconn &lt;maxconn&gt; : 指定此服务器接受的最大连接数：如果发往此服务器的连接数目高于此处指定的值，其将被放置于请求队列，以等待其他连接被释放</li>
<li>maxqueue &lt;maxqueue&gt; : 设定请求队列的最大长度</li>
<li>observe &lt;mode&gt; : 通过观察服务器的通信状况来判断健康状态，默认为禁用，其支持的类型有 <code>layer4</code> 和 <code>layer7</code> , <code>layer7</code> 仅能用于 http 代理场景</li>
<li>redir &lt;prefix&gt; : 启用重定向功能，将发往此服务器的 GET 和 HEAD 请求均以 302 状态码相应；需要注意的是，在 prefix 后面不能使用 <code>/</code>，且不能使用相对地址，以免造成循环：例如 <code>server srv1 172.16.100.6:80 redir http://imageserver.renkeju.com check</code></li>
<li>weight &lt;weight&gt; : 权重，默认为1，最大值为 256，0 表示不参与负载均衡</li>
</ul>
<p>检查方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">option httpchk</span><br><span class="line">option httpchk &lt;uri&gt;</span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt;</span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt; # 不能用于 frontend 段</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend htto_relay</span><br><span class="line">	mode tcp</span><br><span class="line">	option httpchk OPTION * HTTP&#x2F;1.1\r\nHost:\ www</span><br><span class="line">	server apache1 192.168.1.1:443 check port 80</span><br></pre></td></tr></table></figure>

<p>使用案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server first	172.16.100.7:1080 cookie first check inter 1080</span><br><span class="line">server second	172.16.100.8:1080 cookie second check inter 1080</span><br></pre></td></tr></table></figure>



<h4 id="capture-request-header"><a href="#capture-request-header" class="headerlink" title="capture request header"></a>capture request header</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture request header &lt;name&gt; len &lt;length&gt;</span><br></pre></td></tr></table></figure>

<p>捕获并记录指定的请求首部最近一次出现时的第一个值，仅能用于<code>frontend</code> 和 <code>listen</code> 区段，捕获的首部值使用花括号 <code>{}</code>  括起来后添加进日志中，如果需要捕获多个首部值，它们将以指定的次序出现在日志文件中，并以竖线<code>|</code> 作为分隔符。不存在的首部记录为空字符串，最常需要捕获的首部包括在虚拟主机环境中使用的 <code>Host</code>、上传请求首部中的 <code>Content-length</code>、快速区别真实用户和网络机器人的 <code>User-agent</code>，以及代理环境好中记录真实请求来源的 <code>X-Forward-For</code>。</p>
<ul>
<li>&lt;name&gt; : 要捕获的首部的名称，此名称不区分字符大小写，但建议与他们出现在首部中的格式相同，比如大写首字母，需要注意的是，记录在日志中的首部对应的值，而非首部的名称。</li>
<li>&lt;length&gt; : 指定记录首部值所记录的精确长度，超出的部分将会被忽略。</li>
</ul>
<p>可以捕获的请求首部的个数没有限制，但每个捕获最多只能记录64个字符。为了保证同一个 frontend 中日志格式的统一性，首部捕获仅能在 frontend 中定义。</p>
<h4 id="capture-response-header"><a href="#capture-response-header" class="headerlink" title="capture response header"></a>capture response header</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture response header &lt;name&gt; len &lt;length&gt;</span><br></pre></td></tr></table></figure>

<p>捕获并记录相应首部，其格式和要点同请求首部。</p>
<h4 id="stats-enable"><a href="#stats-enable" class="headerlink" title="stats enable"></a>stats enable</h4><p>启用基于程序编译时默认设置的统计报告，不能用于<code>frontend</code> 区段，只要没有另外的其他的设定，他们就会使用如下的配置：</p>
<ul>
<li>stats uri    : /haproxyadmin?stats</li>
<li>stats realm : “HAProxy Statistics”</li>
<li>stats auth  : no authentication</li>
<li>stats scope : no restriction</li>
</ul>
<p>尽管 <code>stats enable</code> 一条就能够启用统计报告，但还是建议设定其他所有的参数，以免其依赖于 默认设定而带来的非预期后果，下面是一个配置案例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">backend public_www</span><br><span class="line">	server websrv1 172.16.100.11:80</span><br><span class="line">	stats enable</span><br><span class="line">	stats hide-version</span><br><span class="line">	stats scope</span><br><span class="line">	stats uri	&#x2F;haproxyadmin?stats</span><br><span class="line">	stats realm	haproxy\ Statistics</span><br><span class="line">	stats auth	statsadmin:password</span><br><span class="line">	stats auth  statsmaster:password</span><br></pre></td></tr></table></figure>

<h4 id="stats-hide-version"><a href="#stats-hide-version" class="headerlink" title="stats hide-version"></a>stats hide-version</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats hide-version</span><br></pre></td></tr></table></figure>

<p>启用统计报告并隐藏 HAProxy 版本报告，不能用于 <code>frontend</code> 区段。默认情况下，统计页面会显示一些有用信息，包括 HAProxy 的版本号，然而，向所有人公开 HAProxy 的精确版本号是非常有风险的，因为他能帮助恶意用户快速定位版本的缺陷和漏洞，尽管<code>stats hide-version</code> 一条就能够启用统计报告，但还是建议设定其他所有的参数，以免其依赖于默认设定而带来的非期后果。具体请参照”stats enable” 一节的说明。</p>
<h4 id="stats-realm"><a href="#stats-realm" class="headerlink" title="stats realm"></a>stats realm</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats realm &lt;realm&gt;</span><br></pre></td></tr></table></figure>

<p>启用统计报告并高精认证领域，不能用于 <code>frontend</code> 区段，haproxy 在读取 realm 时会将其视作一个单词，因此，中间的任何空白字符都必须使用反斜线进行转义。此参数仅在与 <code>stats auth</code> 配置使用时有意义。</p>
<ul>
<li>&lt;realm&gt; ：实现 HTTP 基本认证时显示在浏览器中的领域名称，用于提示用户输入一个用户名和密码</li>
</ul>
<p>尽管 <code>stats realm</code> 一条就能够启用统计报告，但是还建议设定其他所有的参数，以免其依赖于默认设定而带来的非期后果。具体请参照<code>stats enable</code> 一节的说明。</p>
<h4 id="stats-scope"><a href="#stats-scope" class="headerlink" title="stats scope"></a>stats scope</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats scope &#123; &lt;name&gt; | &quot;.&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>启用统计报告并限定报告的区段，不能用于 <code>frontend</code> 区段，当之低昂此语句时，统计报告将仅显示其列举出区段的报告信息，所有其他区段的信息将被隐藏，如果需要显示多个区段的统计报告，此语句可以定义多次，需要注意的是，区段名称检测仅仅是以字符串比较的方式运行，它不会真检测指定的区段是否真正存在。</p>
<ul>
<li>&lt;name&gt; : 可以是一个“listen”、“frontend“ 或 ”backend“区段的名称，而 ”.“ 则表示 stats scope 语句所定义的当前区段。</li>
</ul>
<p>尽管 <code>stats scope</code> 一条就能够启用统计报告，但还是建议设定其他所有的参数，以免其依赖于默认设定而带来非期后果，下面试一个配置案例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend private_monitoring</span><br><span class="line">	stats enable</span><br><span class="line">	stats uri	&#x2F;haproxyadmin?stats</span><br><span class="line">	stats refresh 10s</span><br></pre></td></tr></table></figure>

<h4 id="stats-auth"><a href="#stats-auth" class="headerlink" title="stats auth"></a>stats auth</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats auth &lt;user&gt;:&lt;password&gt;</span><br></pre></td></tr></table></figure>

<p>启用带认证的统计报告功能逼格授权一个用户账号，其不能用于<code>frontend</code>区段</p>
<ul>
<li>&lt;user&gt; : 授权进行访问的用户名</li>
<li>&lt;stats&gt; ：此用户的访问密码： 明文格式</li>
</ul>
<p>此语句将基于默认设定启用统计报告功能，并仅允许其定义的用户访问，其也可以定义多次以授权多个用户账号，可以结合<code>stats realm</code> 参数在提示用户认证时给出一个领域说明信息，在使用非法用户访问统计功能时，其将会相应一个 <code>401 Forbidden</code>  页面，其认证方式为 HTTP Basic 认证，密码传输会以明文方式进行，因此，配置文件中也使用明文方式存储以说明其非保密信息故此不能相同于其他关键性账号的密码。</p>
<p>尽管 <code>stats auth</code> 一条就能够启用统计报告，但还是建议设定其他所有的参数，以免其依赖于默认设定而带来的非期后果。</p>
<h4 id="stats-admin"><a href="#stats-admin" class="headerlink" title="stats admin"></a>stats admin</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats admin &#123; if | unless &#125; &lt;cond&gt;</span><br></pre></td></tr></table></figure>

<p> 在指定的条件满足是启用统计报告页面的管理级别功能，它允许通过 web 接口启用或禁用服务器，不过，基于安全角度考虑，统计报告页面应尽可能为只读的。此外，如果启用了HAProxy 的多进程模式，启用此管理级别将有可能导致异常行为。</p>
<p>目前来说，POST请求方法被限制于仅能使用缓冲区减去保留部分之外的空间，因此，服务器列表不能过长，否则，此请求将无法正常工作，因此，建议一次仅调整少数几个服务器，下面是两个案例，第一个限制了仅能在本机打开打开报告页面是启用管理级别功能，第二个定义了仅允许通过认证的用户使用管理级别功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">backend stats_localhost</span><br><span class="line">	stats enable</span><br><span class="line">	stats admin if LOCALHOST</span><br><span class="line">	</span><br><span class="line">backend stats_auth</span><br><span class="line">	stats enable</span><br><span class="line">	stats auth haproxyadmin:password</span><br><span class="line">	stats admin if TRUE</span><br></pre></td></tr></table></figure>



<h4 id="option-httplog"><a href="#option-httplog" class="headerlink" title="option httplog"></a>option httplog</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option httplog [ clf ]</span><br></pre></td></tr></table></figure>

<p>启用记录 HTTP 请求、会话状态和计时器的功能</p>
<p>clf : 使用CLF  格式来代替 HAProxy 默认的 HTTP 格式，通常在使用仅支持 CLF 格式的特定日志分析器时才需要使用此格式。</p>
<p>默认情况下，日志输入格式非常简陋，因为其仅包括源地址、目标地址和实例名称，而 <code>option httplog</code> 参数将会使得日志格式变得丰富许多，其通常包括但不限于 HTTP 请求、连接计时器、会话状态、连接数、捕获的首部及 cookie、<code>frontend</code>和<code>backend</code> 及服务器名称，当然也包括源地址和端口号等。</p>
<h4 id="option-logasap"><a href="#option-logasap" class="headerlink" title="option logasap"></a>option logasap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">option logasap</span><br><span class="line">no option logasap</span><br></pre></td></tr></table></figure>

<p>启用或禁用提前将 HTTP 请求记入日志，不能用于 <code>backend</code> 区段。</p>
<p>默认情况下，HTTP 请求是在请求结束时进行记录以便能将其整体传输时长和字节数记入日志，由此，传输较大的对象时，其记入日志的时长可能会略有延迟。<code>option logasap</code> 参数能够在服务器发送 complete 首部时即时记录日志，只不过，此时将不记录整体传输时长和字节数。此情景下，捕获 <code>Content-Length</code> 相应首部来记录传输的字节数是一个较好选择，下面是一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listen http_proxy 0.0.0.0:80</span><br><span class="line">	mode http</span><br><span class="line">	option httplog</span><br><span class="line">	option logasap</span><br><span class="line">	log 172.16.100.9 local2</span><br></pre></td></tr></table></figure>

<h4 id="option-forwardfor"><a href="#option-forwardfor" class="headerlink" title="option forwardfor"></a>option forwardfor</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [ if-none ]</span><br></pre></td></tr></table></figure>

<p>允许在发往服务器的请求首部中插入 <code>X-Forwarded-For</code> 首部</p>
<ul>
<li><p>&lt;network&gt; : 可选参数，当指定是，源地址为匹配至此网络中的请求都禁用功能</p>
</li>
<li><p>&lt;name&gt; : 可选参数，可使用一个自定义的首部，如 <code>X-Forwarded-For</code>，有些独特的 web 服务器的确需要用于一个独特的首部。</p>
</li>
<li><p>if-none : 仅在此首部不存在时才将其添加至请求报文中</p>
</li>
</ul>
<p>Haproxy 工作于反向代理模式，其发往服务器的请求中的客户端IP均为HAProxy主机的地址而非真正客户端的地址，这会使得服务器端的日志信息记录不了真正的请求来源，<code>X-Forwarded-For</code>首部则可用于解决此问题，HAProxy 可以向每个发往服务器的请求上添加此首部，并以客户端IP为其value。</p>
<p>需要注意的是，HAProxy工作与隧道模式，其仅检查每一个连接的第一个请求，因此，仅第一个请求报文被附加此首部，如果想为每一个请求都附加此首部，请确保同时使用了 <code>option httpclose</code>、<code>option forceclose</code>和<code>option http-server-close</code>几个 option。</p>
<p>下面是一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frontend www</span><br><span class="line">	mode http</span><br><span class="line">	option forwarded except 127.0.0.1</span><br></pre></td></tr></table></figure>



<h4 id="errorfile"><a href="#errorfile" class="headerlink" title="errorfile"></a>errorfile</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorfile &lt;code&gt; &lt;file&gt;</span><br></pre></td></tr></table></figure>

<p> 在用户请求不存在的页面时，返回一个页面文件给客户端而非由haproxy生成的错误代码：可用于所有段中。</p>
<ul>
<li>&lt;code&gt; : 指定对 HTTP 的那些状态码返回指定的页面：这里可用的状态码有 200、400、403、408、500、502、503 和 504。</li>
<li>&lt;file&gt; : 指定用于相应的页面文件</li>
</ul>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">errorfile 400 &#x2F;etc&#x2F;haproxy&#x2F;errorpages&#x2F;400badreg.http</span><br><span class="line">errorfile 403 &#x2F;etc&#x2F;haproxy&#x2F;errorpages&#x2F;403badreg.http</span><br><span class="line">errorfile 503 &#x2F;etc&#x2F;haproxy&#x2F;errorpages&#x2F;503badreg.http</span><br></pre></td></tr></table></figure>

<h4 id="errorloc-和-errorloc302"><a href="#errorloc-和-errorloc302" class="headerlink" title="errorloc 和 errorloc302"></a>errorloc 和 errorloc302</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">errorloc &lt;code&gt; &lt;url&gt;</span><br><span class="line">errorloc302 &lt;code&gt; &lt;url&gt;</span><br></pre></td></tr></table></figure>

<p>请求错误时，返回一个HTTP重定向至某URL的信息：可用于所有配置段中。</p>
<ul>
<li>&lt;code&gt; : 指定对 HTTP 的哪些状态码返回指定的页面；这里可用的状态码有 200、400、403、408、500、502、503 和 504。</li>
<li>&lt;url&gt; : Location 首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径：需要注意的是，如果URI自身错误是产生某特定状态码信息的话，有可能会导致循环定向。</li>
</ul>
<p>需要留意的是，这两个关键字都会返回 302 状态码，这将使得客户端使用同样的HTTP方法获取指定的URL，对于非GET方法的场景（如POST）来说会产生问题，因为返回客户的URL是不允许使用GET以外的其他方法的。如果的确有这种问题，可以使用 errorloc303 来返回 303 状态码给客户端。</p>
<h4 id="errorloc303"><a href="#errorloc303" class="headerlink" title="errorloc303"></a>errorloc303</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorloc303 &lt;code&gt; &lt;url&gt;</span><br></pre></td></tr></table></figure>

<p>请求错误时，返回一个 HTTP 重定向至某 URL 的信息给客户端：可用于所有配置段中。</p>
<ul>
<li>&lt;code&gt; : 指定对HTTP的哪些状态码返回指定的页面：这里可用的状态码有 400、403、408、500、502 和 504 </li>
<li>&lt;url&gt; : Location 首部中指定的页面位置的具体路径，可以是在当前服务器上页面的绝对路径；也可以使用绝对路径；需要注意的是，如果URI自身错误时产生某特定状态码信息的话，有可能会导致循环定向。</li>
</ul>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">backend webserver</span><br><span class="line">	server 172.16.100.6 172.16.100.6:80 check maxconn 3000 cookie srv01</span><br><span class="line">	server 172.16.100.7 172.16.100.7:80 check maxconn 3000 cookie srv02</span><br><span class="line">	errorloc 403 &#x2F;etc&#x2F;haproxy&#x2F;errorpages&#x2F;sorry.htm</span><br><span class="line">	errorloc 503 &#x2F;etc&#x2F;haproxy&#x2F;errorpages&#x2F;sorry.htm</span><br></pre></td></tr></table></figure>



<h2 id="配置实例"><a href="#配置实例" class="headerlink" title="配置实例"></a>配置实例</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#----------------------------------------------------</span></span><br><span class="line"><span class="comment"># Global settings</span></span><br><span class="line"><span class="comment">#----------------------------------------------------</span></span><br><span class="line">global</span><br><span class="line">	<span class="comment"># to have these messages end up in /var/log/haproxy.log you will</span></span><br><span class="line">	<span class="comment"># need to:</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># 1) configure syslog to accept network log events. This is done</span></span><br><span class="line">	<span class="comment"># 	 by adding the '-r' option to the SYSLOGD_OPTIONS in</span></span><br><span class="line">	<span class="comment">#	 /etc/sysconfig/syslog</span></span><br><span class="line">	<span class="comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class="line">	<span class="comment">#   file. A line like the following can be added to</span></span><br><span class="line">	<span class="comment">#   /etc/sysconfig/syslog</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment">#   local2.*		/var/log/haproxy.log</span></span><br><span class="line">	log		127.0.0.1	local2</span><br><span class="line">	</span><br><span class="line">	chroot 		/var/lib/haproxy</span><br><span class="line">	pidfile		/var/run/haproxy.pid</span><br><span class="line">	maxconn		4000</span><br><span class="line">	user		haproxy</span><br><span class="line">	group		haproxy</span><br><span class="line">	daemon</span><br><span class="line">	</span><br><span class="line">defaults</span><br><span class="line">	mode		http</span><br><span class="line">	log			global</span><br><span class="line">	option		httplog</span><br><span class="line">	option		dontlognull</span><br><span class="line">	option		http-server-close</span><br><span class="line">	option		forwardfor</span><br><span class="line">	option		except	127.0.0.0/8</span><br><span class="line">	option		redispatch</span><br><span class="line">	retries		3</span><br><span class="line">    timeout	http-request	10s</span><br><span class="line">    timeout	queue			1m</span><br><span class="line">    timeout	connect			10s</span><br><span class="line">    timeout client			1m</span><br><span class="line">    timeout	server			1m</span><br><span class="line">    timeout	http-keep-alive	10s</span><br><span class="line">    timeout check			10s</span><br><span class="line">    maxconn					30000</span><br><span class="line">    </span><br><span class="line">listen	stats</span><br><span class="line">	mode	http</span><br><span class="line">	bind	0.0.0.0:1080</span><br><span class="line">	stats	enable</span><br><span class="line">	stats	hide-version</span><br><span class="line">	stats	uri	/haproxyadmin?stats</span><br><span class="line">	stats	realm	Haproxy\ Statistics</span><br><span class="line">	stats	auth	admin:password</span><br><span class="line">	stats	admin if TRUE</span><br><span class="line">	</span><br><span class="line">frontend http-in</span><br><span class="line">	bind	*:80</span><br><span class="line">	mode	http</span><br><span class="line">	log		global</span><br><span class="line">	option	httpclose</span><br><span class="line">	option	logasap</span><br><span class="line">	option	dontlognull</span><br><span class="line">	capture	request	header	Host len 20</span><br><span class="line">	capture	request	header	Referer	len 60</span><br><span class="line">	default_backend	servers</span><br><span class="line">	</span><br><span class="line">frontend healthcheck</span><br><span class="line">	bind :1099</span><br><span class="line">	mode http</span><br><span class="line">	option httpclose</span><br><span class="line">	option	forwardfor</span><br><span class="line">	default_backend	servers</span><br><span class="line">	</span><br><span class="line">backend servers</span><br><span class="line">	balance roundrobin</span><br><span class="line">	server websrv1	192.168.10.11:80 check maxconn 2000</span><br><span class="line">	server websrv2  192.168.10.12:80 check maxconn 2000</span><br></pre></td></tr></table></figure>



<h2 id="RabbitMQ-配置实例"><a href="#RabbitMQ-配置实例" class="headerlink" title="RabbitMQ 配置实例"></a>RabbitMQ 配置实例</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">	log 127.0.0.1 local0 info</span><br><span class="line">	maxconn 4096</span><br><span class="line">	chroot /var/lib/haproxy</span><br><span class="line">	user haproxy</span><br><span class="line">	group haproxy</span><br><span class="line">	daemon</span><br><span class="line">	pidfile /var/run/haproxy.pid</span><br><span class="line">	</span><br><span class="line">defaults </span><br><span class="line">	log global</span><br><span class="line">	mode tcp</span><br><span class="line">	option tcplog</span><br><span class="line">	option dontlognull</span><br><span class="line">	retries	3</span><br><span class="line">	maxconn 2000</span><br><span class="line">	timeout connect 5s</span><br><span class="line">	timeout client 120s</span><br><span class="line">	timeout server 120s</span><br><span class="line">	</span><br><span class="line">listen rabbitmq_cluster :5671</span><br><span class="line">	mode tcp</span><br><span class="line">	balance roundrobin</span><br><span class="line">	server rmq_node1 172.16.0.9:5672 check inter 5000 rise 2 fall 3 weight 1</span><br><span class="line">	server rmq_node2 172.16.0.8:5672 check inter 5000 rise 2 fall 3 weight 1</span><br><span class="line">	server rmq_node1 172.16.0.6:5672 check inter 5000 rise 2 fall 3 weight 1</span><br><span class="line">	</span><br><span class="line">listen monitor :8100</span><br><span class="line">	mode http</span><br><span class="line">	option httplog</span><br><span class="line">	stats enable</span><br><span class="line">	stats uri /stats</span><br><span class="line">	stats refresh 5s</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/07/10/lotus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/10/lotus/" class="post-title-link" itemprop="url">lotus 部署与实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-10 19:34:33" itemprop="dateCreated datePublished" datetime="2020-07-10T19:34:33+08:00">2020-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-04 10:15:07" itemprop="dateModified" datetime="2020-09-04T10:15:07+08:00">2020-09-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="系统调试"><a href="#系统调试" class="headerlink" title="系统调试"></a>系统调试</h2><h3 id="关闭-Swap-分区"><a href="#关闭-Swap-分区" class="headerlink" title="关闭 Swap 分区"></a>关闭 Swap 分区</h3><ul>
<li><p>临时关闭 swap 分区</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># swapoff -a</span><br></pre></td></tr></table></figure>
</li>
<li><p>永久关闭swap分区，但是执行此命令之后需要重启系统！</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sed -i.bak &#39;&#x2F; swap &#x2F; s&#x2F;^\(.*\)$&#x2F;#\1&#x2F;g&#39; &#x2F;etc&#x2F;fstab</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SHELL&#x3D;&#x2F;bin&#x2F;bash</span><br><span class="line">PATH&#x3D;&#x2F;root&#x2F;.cargo&#x2F;bin:&#x2F;root&#x2F;.cargo&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;local&#x2F;games:&#x2F;snap&#x2F;bin</span><br><span class="line">MAILTO&#x3D;root</span><br><span class="line"></span><br><span class="line">0 * * * * &#x2F;usr&#x2F;local&#x2F;bin&#x2F;lotus-storage-miner sectors pledge</span><br><span class="line">30 * * * * &#x2F;usr&#x2F;local&#x2F;bin&#x2F;lotus-storage-miner sectors pledge</span><br></pre></td></tr></table></figure>

<p>定时任务建议根据<code>lotus-banch</code>测试出<code>addPiece</code>的时间，调整时间间隔，当然，后端的服务器也需要有能力消化。</p>
<h3 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h3><ul>
<li><p>源文件</p>
<p>  使用 python 创建简单http服务</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># python3.8 -m http.server 8000</span><br></pre></td></tr></table></figure>
</li>
<li><p>目标文件</p>
<p>  使用 curl 获取源文件目录</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget -r -np -nH http:&#x2F;&#x2F;192.168.1.43:8000&#x2F;.lotusworker</span><br></pre></td></tr></table></figure>
<h2 id="lotus-安装"><a href="#lotus-安装" class="headerlink" title="lotus 安装"></a>lotus 安装</h2></li>
</ul>
<h3 id="lotus相关环境变量"><a href="#lotus相关环境变量" class="headerlink" title="lotus相关环境变量"></a>lotus相关环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># lotus 路径：</span><br><span class="line">LOTUS_PATH</span><br><span class="line"># 例如： export LOTUS_PATH&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;lotus</span><br><span class="line"></span><br><span class="line"># miner 路径： </span><br><span class="line">LOTUS_STORAGE_PATH</span><br><span class="line"># 例如： export LOTUS_STORAGE_PATH&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;lotusstorage</span><br><span class="line"></span><br><span class="line"># worker 路径： </span><br><span class="line">WORKER_PATH</span><br><span class="line"># 例如： export WORKER_PATH&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;lotusworker</span><br><span class="line"></span><br><span class="line"># proof 证明参数路径： </span><br><span class="line">FIL_PROOFS_PARAMETER_CACHE</span><br><span class="line"># 例如： export FIL_PROOFS_PARAMETER_CACHE&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;filecoin-proof-parameters</span><br><span class="line"></span><br><span class="line"># 临时文件夹路径： </span><br><span class="line">TMPDIR</span><br><span class="line"># 例如： export TMPDIR&#x3D;&#x2F;home&#x2F;user&#x2F;nvme_disk&#x2F;tmp</span><br><span class="line"></span><br><span class="line"># 最大化内存参数</span><br><span class="line">FIL_PROOFS_MAXIMIZE_CACHING</span><br><span class="line"># 例如： export FIL_PROOFS_MAXIMIZE_CACHING&#x3D;1</span><br><span class="line"></span><br><span class="line"># Rust 日志</span><br><span class="line">RUST_LOG</span><br><span class="line"># 例如： export RUST_LOG&#x3D;Debug</span><br><span class="line"></span><br><span class="line"># GPU计算Precommit2</span><br><span class="line">FIL_PROOFS_USE_GPU_COLUMN_BUILDER</span><br><span class="line"># 例如： export FIL_PROOFS_USE_GPU_COLUMN_BUILDER&#x3D;1</span><br><span class="line"></span><br><span class="line"># 源码编译底层库</span><br><span class="line">FFI_BUILD_FROM_SOURCE</span><br><span class="line"># 例如： export FFI_BUILD_FROM_SOURCE&#x3D;1</span><br><span class="line"></span><br><span class="line"># GOLANG 代理</span><br><span class="line">GOPROXY</span><br><span class="line"># 例如： export GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn</span><br><span class="line"></span><br><span class="line"># 启动小扇区支持</span><br><span class="line">FIL_USE_SMALL_SECTORS</span><br><span class="line"># 例如： export FIL_USE_SMALL_SECTORS&#x3D;true</span><br><span class="line"></span><br><span class="line"># 显卡相关</span><br><span class="line">BELLMAN_CUSTOM_GPU</span><br><span class="line"># 例如： export BELLMAN_CUSTOM_GPU&#x3D;&quot;GeForce RTX 2080 Ti:4352&quot;</span><br><span class="line"></span><br><span class="line"># 下载证明参数代理：</span><br><span class="line">IPFS_GATEWAY</span><br><span class="line"># 例如： export IPFS_GATEWAY&#x3D;&quot;https:&#x2F;&#x2F;proof-parameters.s3.cn-south-1.jdcloud-oss.com&#x2F;ipfs&#x2F;&quot;</span><br><span class="line"></span><br><span class="line"># 启用 GPU 计算 Precommit2 中的部分过程</span><br><span class="line">FIL_PROOFS_USE_GPU_TREE_BUILDER</span><br><span class="line">FIL_PROOFS_USE_GPU_COLUMN_BUILDER</span><br><span class="line"># 例如：export FIL_PROOFS_USE_GPU_TREE_BUILDER&#x3D;1</span><br><span class="line"># 例如：export FIL_PROOFS_USE_GPU_COLUMN_BUILDER&#x3D;1</span><br></pre></td></tr></table></figure>

<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># apt update </span><br><span class="line"># apt -y install mesa-opencl-icd ocl-icd-opencl-dev gcc git bzr jq pkg-config curl git</span><br><span class="line"># HTTP_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 HTTPS_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 curl --proto &#39;&#x3D;https&#39; --tlsv1.2 -sSf https:&#x2F;&#x2F;sh.rustup.rs | RUSTUP_INIT_SKIP_PATH_CHECK&#x3D;yes HTTP_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 HTTPS_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 sh</span><br><span class="line"># source $HOME&#x2F;.cargo&#x2F;env</span><br></pre></td></tr></table></figure>

<h3 id="安装-Golang"><a href="#安装-Golang" class="headerlink" title="安装 Golang"></a>安装 Golang</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;golang.org&#x2F;dl&#x2F;go1.14.7.linux-amd64.tar.gz</span><br><span class="line"># tar -C &#x2F;usr&#x2F;local -zxf go1.14.7.linux-amd64.tar.gz</span><br><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;etc&#x2F;profile.d&#x2F;go.sh </span><br><span class="line">export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;go&#x2F;bin</span><br><span class="line">export GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn</span><br><span class="line">EOF</span><br><span class="line"># source &#x2F;etc&#x2F;profile.d&#x2F;go.sh</span><br><span class="line"># go env</span><br></pre></td></tr></table></figure>

<h3 id="获取代码"><a href="#获取代码" class="headerlink" title="获取代码"></a>获取代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># git config --global http.proxy http:&#x2F;&#x2F;192.168.1.4:8118</span><br><span class="line"># git config --global https.proxy http:&#x2F;&#x2F;192.168.1.4:8118</span><br><span class="line"># git clone https:&#x2F;&#x2F;github.com&#x2F;filecoin-project&#x2F;lotus.git</span><br></pre></td></tr></table></figure>

<h3 id="切换标签"><a href="#切换标签" class="headerlink" title="切换标签"></a>切换标签</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd lotus</span><br><span class="line"># git tag                   ## 查看所有标签</span><br><span class="line"># git checkout v0.5.3       ## 切换标签</span><br><span class="line"># git branch                ## 查看所在标签</span><br></pre></td></tr></table></figure>

<h4 id="编译参数"><a href="#编译参数" class="headerlink" title="编译参数"></a>编译参数</h4><p>v26/v27版本代码的编译命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">env HTTP_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 \</span><br><span class="line">HTTPS_PROXY&#x3D;http:&#x2F;&#x2F;192.168.1.4:8118 \</span><br><span class="line">RUSTFLAGS&#x3D;&quot;-C target-cpu&#x3D;native -g&quot; \</span><br><span class="line">FFI_BUILD_FROM_SOURCE&#x3D;1 \</span><br><span class="line">make clean all \</span><br><span class="line">&amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3 id="将Lotus与systemd一起使用"><a href="#将Lotus与systemd一起使用" class="headerlink" title="将Lotus与systemd一起使用"></a>将Lotus与systemd一起使用</h3><h4 id="lotus-daemon-systemd"><a href="#lotus-daemon-systemd" class="headerlink" title="lotus-daemon systemd"></a>lotus-daemon systemd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;lotus-daemon.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Lotus Daemon</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line">Requires&#x3D;network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Environment&#x3D;GOLOG_FILE&#x3D;&quot;&#x2F;var&#x2F;log&#x2F;lotus&#x2F;daemon.log&quot;</span><br><span class="line">Environment&#x3D;GOLOG_LOG_FMT&#x3D;&quot;json&quot;</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;lotus daemon</span><br><span class="line">Restart&#x3D;always</span><br><span class="line">RestartSec&#x3D;10</span><br><span class="line"></span><br><span class="line">MemoryAccounting&#x3D;true</span><br><span class="line">MemoryHigh&#x3D;8G</span><br><span class="line">MemoryMax&#x3D;10G</span><br><span class="line">LimitNOFILE&#x3D;8192:10240</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl enable --now lotus-daemon</span><br></pre></td></tr></table></figure>

<h4 id="lotus-miner-systemd"><a href="#lotus-miner-systemd" class="headerlink" title="lotus-miner systemd"></a>lotus-miner systemd</h4><p>如果你拆开了lotus-daemon和lotus-miner，就先把 systemctl 写入，随后lotus-miner配置文件配置完成后再使用<code>systectl start lotus-miner</code>启动。</p>
<blockquote>
<p>如果没有使用 ceph rbdmap 服务挂载网络磁盘，可以把<code>After=rbdmap.service</code>注释掉。不注释掉，lotus-miner 服务不能启动成功。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;lotus-miner.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Lotus Miner</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">After&#x3D;rbdmap.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;lotus-miner run</span><br><span class="line">Environment&#x3D;GOLOG_FILE&#x3D;&quot;&#x2F;var&#x2F;log&#x2F;lotus&#x2F;miner.log&quot;</span><br><span class="line">Environment&#x3D;GOLOG_LOG_FMT&#x3D;&quot;json&quot;</span><br><span class="line">Environment&#x3D;RUST_LOG&#x3D;Debug</span><br><span class="line">Environment&#x3D;RUST_BACKTRACE&#x3D;full</span><br><span class="line">Environment&#x3D;FIL_PROOFS_MAXIMIZE_CACHING&#x3D;1</span><br><span class="line">Environment&#x3D;FIL_PROOFS_USE_GPU_COLUMN_BUILDER&#x3D;1</span><br><span class="line">Environment&#x3D;FIL_PROOFS_USE_GPU_TREE_BUILDER&#x3D;1</span><br><span class="line">Environment&#x3D;FIL_PROOFS_SDR_PARENTS_CACHE_SIZE&#x3D;1073741824</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl enable lotus-miner</span><br><span class="line"># mkdir ~&#x2F;.lotus</span><br><span class="line"># echo &lt;API&gt; &gt; ~&#x2F;.lotus&#x2F;api</span><br><span class="line"># echo &lt;TOKEN&gt; &gt; ~&#x2F;.lotus&#x2F;token</span><br></pre></td></tr></table></figure>

<h4 id="lotus-worker-systemd"><a href="#lotus-worker-systemd" class="headerlink" title="lotus-worker systemd"></a>lotus-worker systemd</h4><p>lotus-worker 和 lotus-miner 肯定是拆开的，先把 systemctl 写入。另外根据你的需要分配lotus-worker所需要进行的工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;lotus-worker.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Lotus Storage Seal Worker</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart&#x3D;lotus-worker run --listen&#x3D;192.168.1.46:10001 --precommit1&#x3D;false --precommit2&#x3D;false --commit&#x3D;true --addpiece&#x3D;false --unseal&#x3D;false</span><br><span class="line">Environment&#x3D;GOLOG_FILE&#x3D;&quot;&#x2F;var&#x2F;log&#x2F;lotus&#x2F;worker.log&quot;</span><br><span class="line">Environment&#x3D;GOLOG_LOG_FMT&#x3D;&quot;json&quot;</span><br><span class="line">Environment&#x3D;RUST_LOG&#x3D;Debug</span><br><span class="line">Environment&#x3D;RUST_BACKTRACE&#x3D;full</span><br><span class="line">Environment&#x3D;FIL_PROOFS_MAXIMIZE_CACHING&#x3D;1</span><br><span class="line">Environment&#x3D;FIL_PROOFS_USE_GPU_COLUMN_BUILDER&#x3D;1</span><br><span class="line">Environment&#x3D;FIL_PROOFS_USE_GPU_TREE_BUILDER&#x3D;1</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multiuser.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl enable lotus-miner</span><br><span class="line"># mkdir ~&#x2F;.lotusminer</span><br><span class="line"># echo &lt;API&gt; &gt; ~&#x2F;.lotusminer&#x2F;api</span><br><span class="line"># echo &lt;TOKEN&gt; &gt; ~&#x2F;.lotusminer&#x2F;token</span><br><span class="line"># systemctl start lotus-worker</span><br></pre></td></tr></table></figure>

<h4 id="跟踪服务的日志"><a href="#跟踪服务的日志" class="headerlink" title="跟踪服务的日志"></a>跟踪服务的日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo journalctl -u lotus-daemon -f</span><br></pre></td></tr></table></figure>

<h4 id="以相反的顺序查看日志"><a href="#以相反的顺序查看日志" class="headerlink" title="以相反的顺序查看日志"></a>以相反的顺序查看日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo journalctl -u lotus-daemon -r</span><br></pre></td></tr></table></figure>

<h2 id="使用远程-daemon"><a href="#使用远程-daemon" class="headerlink" title="使用远程 daemon"></a>使用远程 daemon</h2><p>假设daemon在 <code>192.168.1.100</code> 机器上，miner在 <code>192.168.1.101</code> 机器上：</p>
<ol>
<li>修改远程 daemon (192.168.1.100)上 <code>~/.lotus/config.toml</code> 中的 <code>ListenAddress</code> 为：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Default config:</span><br><span class="line">[API]</span><br><span class="line">ListenAddress &#x3D; &quot;&#x2F;ip4&#x2F;192.168.1.100&#x2F;tcp&#x2F;1234&#x2F;http&quot;</span><br></pre></td></tr></table></figure>

<ol>
<li>将远程 daemon (192.168.1.100) 上 <code>~/.lotus</code> 目录下的 <code>api</code> 和 <code>token</code> 拷贝到 miner 机器(192.168.1.101)的 <code>~/.lotus</code> 目录下，miner主机不用启动lotus-daemon。</li>
<li>重启miner机器的 miner 服务即可。</li>
</ol>
<h2 id="Testnet3-集群配置"><a href="#Testnet3-集群配置" class="headerlink" title="Testnet3 集群配置"></a>Testnet3 集群配置</h2><h3 id="修改-miner"><a href="#修改-miner" class="headerlink" title="修改 miner"></a>修改 miner</h3><p>修改 miner <code>~/.lotusstorage/config.toml</code> 里面的 <code>ListenAddress</code> 和 <code>RemoteListenAddress</code> ，把这两个变量中的地址都改为 miner 本机的地址:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[API]</span><br><span class="line">ListenAddress &#x3D; &quot;&#x2F;ip4&#x2F;192.168.1.100&#x2F;tcp&#x2F;2345&#x2F;http&quot;</span><br><span class="line">RemoteListenAddress &#x3D; &quot;192.168.1.100:2345&quot;</span><br></pre></td></tr></table></figure>

<h3 id="配置-worker"><a href="#配置-worker" class="headerlink" title="配置 worker"></a>配置 worker</h3><p>在 <strong>启动了 miner 之后</strong>，复制 miner 的 <code>~/.lotusstorage</code> 目录中的 <code>token</code> 和 <code>api</code> 到 worker 中的 <code>~/.lotusstorage</code> （worker 中没有这个目录就手动创建一个），然后启动 worker 即可。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/06/13/facileManager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/13/facileManager/" class="post-title-link" itemprop="url">facileManager</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-13 18:19:17" itemprop="dateCreated datePublished" datetime="2020-06-13T18:19:17+08:00">2020-06-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-14 03:29:04" itemprop="dateModified" datetime="2020-06-14T03:29:04+08:00">2020-06-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="安装-facileManager"><a href="#安装-facileManager" class="headerlink" title="安装 facileManager"></a>安装 facileManager</h2><ol>
<li><p>从github克隆facileManager的ansible安装脚本</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;renkeju&#x2F;ansible-facilemanager.git</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 inventory 中目录与文件</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd ansible-facilemanager</span><br><span class="line">mkdir inventory&#x2F;host_vars</span><br><span class="line">touch inventory&#x2F;host_vars&#x2F;fm.yml</span><br><span class="line"></span><br><span class="line">ansible_ssh_host: 192.168.0.2</span><br><span class="line">ansible_ssh_port: 22</span><br><span class="line">ansible_ssh_user: firefly</span><br><span class="line">ansible_ssh_pass: firefly</span><br><span class="line">ansible_sudo_pass: firefly</span><br><span class="line">ansible_become_user: root</span><br><span class="line">ansible_become_pass: firefly</span><br><span class="line">ansible_python_interpreter: &#x2F;usr&#x2F;bin&#x2F;python3.6</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>修改 fm.yml 的配置信息，可以参考<a href="http://www.ansible.com.cn/docs/intro_inventory.html#behavioral-parameters" target="_blank" rel="noopener">《Ansible 权威指南》Inventory参数的说明</a></p>
</blockquote>
<ol start="3">
<li><p>修改 <code>inventory/group_vars/all.yml</code> 配置文件。</p>
<p> 下面这两个参数是需要关注的。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apache_listen_interface: eth0</span><br><span class="line">php_packages_state: []</span><br></pre></td></tr></table></figure>
</li>
<li><p>开始安装</p>
<p> 现在配置完成了，可以执行ansible剧本。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible -i inventory&#x2F;hosts.ini fm -m ping</span><br><span class="line">ansible-playbook -i inventory&#x2F;hosts.ini main.yml</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="配置web界面"><a href="#配置web界面" class="headerlink" title="配置web界面"></a>配置web界面</h2><p>打开浏览器输入 http://<ip_address> 并按照下面实例进行操作。</p>
<ol>
<li><p>提供数据库密码并提交</p>
<p> 数据库主机：localhost<br> 数据库名称：facileManager<br> 数据库用户名：facileManager<br> 数据库密码：facileManagerPassword!</p>
<p> <img src="/images/facilemanager/fmdns-01.png" alt="数据库安装"></p>
</li>
<li><p>点击 <code>continue</code> 按钮创建数据库 schema。</p>
<p> <img src="/images/facilemanager/fmdns-02.png" alt="schema"></p>
</li>
<li><p>检查PHP依赖，所有检测通过后，点击continue。</p>
<p> <img src="/images/facilemanager/fmdns-03.png" alt="检查依赖"></p>
</li>
<li><p>创建管理员用户并未管理员用户提供密码，然后点击 continue。</p>
<p> <img src="/images/facilemanager/fmdns-04.png" alt="创建管理员"></p>
</li>
<li><p>到这一步就完成了，点击按钮 Next。</p>
<p> <img src="/images/facilemanager/fmdns-05.png" alt="完成"></p>
</li>
<li><p>输入用户名和密码登录。</p>
<p> <img src="/images/facilemanager/fmdns-06.png" alt="登录"></p>
</li>
<li><p>在配置模块部分激活 fmDNS 与 fmDHCP 模块。</p>
<p> <img src="/images/facilemanager/fmdns-07.png" alt="激活模块"></p>
</li>
<li><p>模块激活成功。</p>
<p> <img src="/images/facilemanager/fmdns-08.png" alt="模块激活成功"></p>
</li>
<li><p>fmDNS已成功加载。点击右上角切换到 fmDNS 模块。</p>
<p> <img src="/images/facilemanager/fmdns-09.png" alt="切换到 fmDNS 模块"></p>
</li>
</ol>
<h2 id="安装-fmDNS-客户端"><a href="#安装-fmDNS-客户端" class="headerlink" title="安装 fmDNS 客户端"></a>安装 fmDNS 客户端</h2><p>登录主机终端，切换到<code>/usr/local/facileManager/fmDNS</code>中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;facileManager&#x2F;fmDNS</span><br><span class="line">php client.php install</span><br><span class="line"></span><br><span class="line">Welcome to the fmDNS installer.</span><br><span class="line"></span><br><span class="line">Please answer the following questions and the necessary configurations will be performed for you.</span><br><span class="line"></span><br><span class="line">Please enter the location of the facileManager interface:</span><br><span class="line">    Examples include:</span><br><span class="line">        fm.mydomain.com</span><br><span class="line">        fm.mydomain.com:8443</span><br><span class="line">        mydomain.com&#x2F;fm</span><br><span class="line">        http:&#x2F;&#x2F;fm.mydomain.com&#x2F;facileManager</span><br><span class="line"></span><br><span class="line">Please enter the location of the facileManager interface: controller.k3s.lan&#x2F;</span><br><span class="line">  --&gt; Testing controller.k3s.lan via https...failed</span><br><span class="line">  --&gt; Testing controller.k3s.lan via http...ok</span><br><span class="line">  --&gt; Checking account details...Success</span><br><span class="line"></span><br><span class="line">Please enter the serial number for controller.k3s.lan (or leave blank to create new): 213688597</span><br><span class="line">  --&gt; Adding controller.k3s.lan to the database...Success</span><br><span class="line">  --&gt; Running version tests...ok</span><br><span class="line"></span><br><span class="line">  --&gt; Tests complete.  Continuing installation.</span><br><span class="line"></span><br><span class="line">Will controller.k3s.lan get updates via cron, ssh, or http(s) [c|s|h]? h</span><br><span class="line"></span><br><span class="line">Cannot find DocumentRoot in apache2.conf.  Please enter the full path of your default DocumentRoot (&#x2F;var&#x2F;www&#x2F;html): &#x2F;var&#x2F;www&#x2F;html&#x2F;facilemanager</span><br><span class="line">  --&gt; Creating &#x2F;var&#x2F;www&#x2F;html&#x2F;facilemanager&#x2F;fM link.</span><br><span class="line">      --&gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;facilemanager&#x2F;fM already exists...skipping</span><br><span class="line">  --&gt; Detected apache2 runs as &#39;www-data&#39;</span><br><span class="line">  --&gt; The sudoers entry already exists...skipping</span><br><span class="line"></span><br><span class="line">Configuration file has been saved.</span><br><span class="line"></span><br><span class="line">Installation is complete. Please login to the UI to ensure the server settings are correct.</span><br></pre></td></tr></table></figure>

<p>如果没有报错，我们在UI中添加服务器。点击 config -&gt; Servers，如下图：</p>
<p><img src="/images/facilemanager/fmdns-10.png" alt="添加服务器"></p>
<p>单击”Enable”按钮启用服务器：</p>
<p><img src="/images/facilemanager/fmdns-11.png" alt="启用服务器"></p>
<p>完成后，UI 右上角需要手动确认更新提交。您的UI界面可以与您的服务器进行通信，并在Web UI中配置您的域并在您的服务器中自动更新。</p>
<h3 id="创建-SOA-模板"><a href="#创建-SOA-模板" class="headerlink" title="创建 SOA 模板"></a>创建 SOA 模板</h3><ol>
<li><p>创建 Forware 使用的 SOA 模板 loaclhost</p>
<p> <img src="/images/facilemanager/SOA_template-01.png" alt="localhost SOA template"></p>
</li>
<li><p>创建 Reveres 使用的 SOA 模板 arpa-ipv6</p>
<p> <img src="/images/facilemanager/SOA_template-02.png" alt="arpa-ipv6 SOA template"></p>
</li>
<li><p>创建 Reveres 使用的 SOA 模板 arpa</p>
<p> <img src="/images/facilemanager/SOA_template-03.png" alt="arpa SOA template"></p>
</li>
</ol>
<h3 id="创建-Zone-模板"><a href="#创建-Zone-模板" class="headerlink" title="创建 Zone 模板"></a>创建 Zone 模板</h3><ol>
<li><p>添加Zone模板并不生效，也可以跳过这一步。</p>
<p> <img src="/images/facilemanager/Zone_Templates.png" alt="添加 Zone 模板"></p>
</li>
<li><p>在模板中添加A记录，Record 所在列是记录，Value为值。</p>
<p> <img src="/images/facilemanager/add_A.png" alt="在模板中添加A记录"></p>
</li>
<li><p>在模板中添加NS记录，NS记录为必须存在的。</p>
<p> <img src="/images/facilemanager/add_NS.png" alt="在模板中添加NS记录"></p>
</li>
<li><p>选择SOA模板，这些SOA模板就是刚刚创建的。</p>
<p> <img src="/images/facilemanager/select_SOA.png" alt="在模板中选择SOA模板"></p>
</li>
</ol>
<h3 id="添加正向解析"><a href="#添加正向解析" class="headerlink" title="添加正向解析"></a>添加正向解析</h3><ol>
<li><p>编辑正向解析区域</p>
<p> <img src="/images/facilemanager/Edit_Zone.png" alt="编辑正向解析区域"></p>
</li>
<li><p>编辑A解析记录</p>
<p> <img src="/images/facilemanager/A_Records.png" alt="编辑A解析记录"></p>
</li>
<li><p>编辑NS解析记录</p>
<p> <img src="/images/facilemanager/NS_Records.png" alt="编辑NS解析记录"></p>
</li>
</ol>
<h3 id="一些其他全局选项"><a href="#一些其他全局选项" class="headerlink" title="一些其他全局选项"></a>一些其他全局选项</h3><p><img src="/images/facilemanager/fmDNS_Global_Options.png" alt="fmDNS全局选项"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/21/firewalld-NAT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/21/firewalld-NAT/" class="post-title-link" itemprop="url">在 CentOS7 使用 firewalld 配置 NAT</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-21 15:16:21 / 修改时间：15:33:06" itemprop="dateCreated datePublished" datetime="2020-05-21T15:16:21+08:00">2020-05-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="创建WAN-LAN区域"><a href="#创建WAN-LAN区域" class="headerlink" title="创建WAN\LAN区域"></a>创建WAN\LAN区域</h2><p>配置NAT需要有两个网络平面，一个负责WAN，一个负责LAN，先创建网卡的zone分别为External（WAN）和Internal（LAN），下面的示例中ens32负责WAN，ens36负责LAN。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nmcli c mod ens32 connection.zone external</span><br><span class="line"># nmcli c mod ens36 connection.zone internal</span><br></pre></td></tr></table></figure>

<p>确认一下是否创建成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --get-active-zone</span><br></pre></td></tr></table></figure>

<p>WAN\LAN配置IP masquerad</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --zone&#x3D;external --add-masquerade --permanent</span><br><span class="line"># firewall-cmd --zone&#x3D;internal --add-masquerade --permanent</span><br><span class="line"># firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>检查一下ip fordwarding 是否启用，如果启用的话为1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br></pre></td></tr></table></figure>

<p>如果<code>/proc/sys/net/ipv4/ip_forward</code>不为1，执行下面的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;sysctl.d&#x2F;99-sysctl.conf </span><br><span class="line"></span><br><span class="line">net.ipv4&#x2F;ip_forward &#x3D; 1</span><br><span class="line"></span><br><span class="line"># sysctl --system</span><br></pre></td></tr></table></figure>

<h2 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h2><p>因为修改了网卡的区域，之前在 public 区域生效的防火墙规则已经失效，所以需要对需要对WAN/LAN开放的端口进行配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --add-service&#x3D;http --zone&#x3D;external --permanent</span><br></pre></td></tr></table></figure>

<ul>
<li>–add-service 指定服务</li>
<li>–zone 指定区域</li>
<li>–permanent 将规则添加到持久规则集</li>
</ul>
<p>当所有服务都定义完成后，可以使用如下命令重新加载 FirewallD。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><p>查看已经配置完成的区域</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --zone&#x3D;external --list-all</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/cobbler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/cobbler/" class="post-title-link" itemprop="url">cobbler 部署与实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:44:00" itemprop="dateCreated datePublished" datetime="2020-05-11T14:44:00+08:00">2020-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 15:38:39" itemprop="dateModified" datetime="2020-05-21T15:38:39+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">自动化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="初始化环境"><a href="#初始化环境" class="headerlink" title="初始化环境"></a>初始化环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install epel-release</span><br><span class="line"># yum makecache</span><br><span class="line"># yum -y update</span><br><span class="line"># systemctl --now disable postfix firewalld</span><br><span class="line"># setenforce 0</span><br><span class="line"># sed -i &#39;s@^\(SELINUX&#x3D;\).*@\1disabled@&#39; &#x2F;etc&#x2F;sysconfig&#x2F;selinux</span><br><span class="line"># sed -i &#39;s@^\(SELINUX&#x3D;\).*@\1disabled@&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line"># reboot</span><br></pre></td></tr></table></figure>

<h2 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install cobbler cobbler-web pykickstart debmirror httpd tftp-server rsync debmirror fence-agents xinetd dhcp bind</span><br><span class="line"># systemctl --now enable cobblerd httpd rsyncd dhcpd named xinetd</span><br></pre></td></tr></table></figure>

<h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># cobbler check</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : The &#39;server&#39; field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the &#39;next_server&#39; field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.   </span><br><span class="line">3 : SELinux is enabled. Please review the following wiki page for details on ensuring cobbler works correctly in your SELinux environment:</span><br><span class="line">    https:&#x2F;&#x2F;github.com&#x2F;cobbler&#x2F;cobbler&#x2F;wiki&#x2F;Selinux</span><br><span class="line">4 : Some network boot-loaders are missing from &#x2F;var&#x2F;lib&#x2F;cobbler&#x2F;loaders, you may run &#39;cobbler get-loaders&#39; to download them, or, if you only want to handle x86&#x2F;x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The &#39;cobbler get-loaders&#39; command is the easiest way to resolve these requirements.</span><br><span class="line">5 : comment out &#39;dists&#39; on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">6 : comment out &#39;arches&#39; on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">7 : The default password used by the sample templates for newly installed machines (default_password_crypted in &#x2F;etc&#x2F;cobbler&#x2F;settings) is still set to &#39;cobbler&#39; and should be changed, try: &quot;openssl passwd -1 -salt &#39;random-phrase-here&#39; &#39;your-password-here&#39;&quot; to generate new one</span><br><span class="line"></span><br><span class="line">Restart cobblerd and then run &#39;cobbler sync&#39; to apply changes.</span><br></pre></td></tr></table></figure>

<h2 id="解决报错"><a href="#解决报错" class="headerlink" title="解决报错"></a>解决报错</h2><ul>
<li><p><code>/etc/cobbler/settings</code> 配置文件中 “server” 字段必须设置为 localhos t以外的 IP 地址,否则 kickstart 将不会工作。应该使用的是一个可解析启动服务器的主机名或所有服务器可以访问的 IP 地址。</p>
</li>
<li><p>PXE 放置在 functional 区域,在 <code>/etc/cobbler/settings</code> 配置文件中 “next_server” 字段必须设置为 127.0.0.1 以外的 IP 地址,而且应该匹配 PXE 启动服务器的 IP 网络。</p>
</li>
<li><p>检查是否关闭了 SELinux</p>
</li>
<li><p><code>/var/lib/cobbler/loaders</code> 文件缺少一些网络引导加载程序,您可以运行 “cobbler get-loaders” 下载,或者,如果您只想处理 x86/x86_64 网络引导,你可以确保您已经安装了一个最近的 recent 版本的 syslinux 包安装和完全可以忽略此消息。这个目录中的文件,你应该要支持所有架构,应包括 pxelinux.0 menu.c32 elilo.efi yaboot。执行 <code>cobbler get-loaders</code> 命令是解决这些需求最简单的方法。</p>
</li>
<li><p>在 <code>/etc/debmirror.conf</code> 配置文件中将 <strong>dists</strong> 所在行注释</p>
</li>
<li><p>在 <code>/etc/debmirror.conf</code> 配置文件中将 <strong>arches</strong> 所在行注释</p>
</li>
<li><p>在新安装的示例模板机器仍将使用 “cobbler” 作为默认密码(/etc/cobbler/settings default_password_crypted)最好更改一下,尝试使用: <code>openssl passwd -1 -salt ‘random-phrase-here’ ‘your-password-here’</code> 产生新的密码</p>
</li>
</ul>
<h2 id="配置-cobbler"><a href="#配置-cobbler" class="headerlink" title="配置 cobbler"></a>配置 cobbler</h2><p>配置 <code>/etc/cobbler/settings</code>，让 cobbler 接管 dns、dhcp、rsync 服务，修改配置文件中的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">manager_dns: 1</span><br><span class="line">manager_dhcp: 1</span><br><span class="line">manager_rsync: 1</span><br></pre></td></tr></table></figure>

<p>修改 cobbler dhcpd <code>/etc/cobbler/dhcp.template</code> 配置模板文件，主要将 dhcp 地址段范围修改与你网卡相同地址段:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"># ******************************************************************</span><br><span class="line"># Cobbler managed dhcpd.conf file</span><br><span class="line">#</span><br><span class="line"># generated from cobbler dhcp.conf template ($date)</span><br><span class="line"># Do NOT make changes to &#x2F;etc&#x2F;dhcpd.conf. Instead, make your changes</span><br><span class="line"># in &#x2F;etc&#x2F;cobbler&#x2F;dhcp.template, as &#x2F;etc&#x2F;dhcpd.conf will be</span><br><span class="line"># overwritten.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">******************************************************************                                </span><br><span class="line"></span><br><span class="line">ddns-update-style interim;</span><br><span class="line">allow booting;</span><br><span class="line">allow bootp;</span><br><span class="line">ignore client-updates;</span><br><span class="line">set vendorclass &#x3D; option vendor-class-identifier;</span><br><span class="line"></span><br><span class="line">option pxe-system-type code 93 &#x3D; unsigned integer 16;</span><br><span class="line"></span><br><span class="line">subnet 192.168.133.0 netmask 255.255.255.0 &#123;</span><br><span class="line">     option routers             192.168.133.5;</span><br><span class="line">     option domain-name-servers 192.168.133.100;</span><br><span class="line">     option subnet-mask         255.255.255.0;</span><br><span class="line">     range dynamic-bootp        192.168.133.100 192.168.133.254;</span><br><span class="line">     default-lease-time         21600;</span><br><span class="line">     max-lease-time             43200;</span><br><span class="line">     next-server                $next_server;</span><br><span class="line">     class &quot;pxeclients&quot; &#123;</span><br><span class="line">          match if substring (option vendor-class-identifier, 0, 9) &#x3D; &quot;PXEClient&quot;;</span><br><span class="line">          if option pxe-system-type &#x3D; 00:02 &#123;</span><br><span class="line">                  filename &quot;ia64&#x2F;elilo.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:06 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:07 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86_64.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:09 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86_64.efi&quot;;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">                  filename &quot;pxelinux.0&quot;;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#for dhcp_tag in $dhcp_tags.keys():</span><br><span class="line">    ## group could be subnet if your dhcp tags line up with your subnets</span><br><span class="line">    ## or really any valid dhcpd.conf construct ... if you only use the</span><br><span class="line">    ## default dhcp tag in cobbler, the group block can be deleted for a</span><br><span class="line">    ## flat configuration</span><br><span class="line"># group for Cobbler DHCP tag: $dhcp_tag</span><br><span class="line">group &#123;</span><br><span class="line">        #for mac in $dhcp_tags[$dhcp_tag].keys():</span><br><span class="line">            #set iface &#x3D; $dhcp_tags[$dhcp_tag][$mac]</span><br><span class="line">    host $iface.name &#123;</span><br><span class="line">        #if $iface.interface_type &#x3D;&#x3D; &quot;infiniband&quot;:</span><br><span class="line">        option dhcp-client-identifier &#x3D; $mac;</span><br><span class="line">        #else</span><br><span class="line">        hardware ethernet $mac;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.ip_address:</span><br><span class="line">        fixed-address $iface.ip_address;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.hostname:</span><br><span class="line">        option host-name &quot;$iface.hostname&quot;;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.netmask:</span><br><span class="line">        option subnet-mask $iface.netmask;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.gateway:</span><br><span class="line">        option routers $iface.gateway;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.enable_gpxe:</span><br><span class="line">        if exists user-class and option user-class &#x3D; &quot;gPXE&quot; &#123;</span><br><span class="line">            filename &quot;http:&#x2F;&#x2F;$cobbler_server&#x2F;cblr&#x2F;svc&#x2F;op&#x2F;gpxe&#x2F;system&#x2F;$iface.owner&quot;;</span><br><span class="line">        &#125; else if exists user-class and option user-class &#x3D; &quot;iPXE&quot; &#123;</span><br><span class="line">            filename &quot;http:&#x2F;&#x2F;$cobbler_server&#x2F;cblr&#x2F;svc&#x2F;op&#x2F;gpxe&#x2F;system&#x2F;$iface.owner&quot;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            filename &quot;undionly.kpxe&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        #else</span><br><span class="line">        filename &quot;$iface.filename&quot;;</span><br><span class="line">        #end if</span><br><span class="line">        ## Cobbler defaults to $next_server, but some users</span><br><span class="line">        ## may like to use $iface.system.server for proxied setups</span><br><span class="line">        next-server $next_server;</span><br><span class="line">        ## next-server $iface.next_server;</span><br><span class="line">    &#125;</span><br><span class="line">        #end for</span><br><span class="line">&#125;</span><br><span class="line">#end for</span><br></pre></td></tr></table></figure>
<p>修改完成后，执行 <code>cobbler sync</code> 命令进行同步。</p>
<h2 id="访问-cobbler"><a href="#访问-cobbler" class="headerlink" title="访问 cobbler"></a>访问 cobbler</h2><p>此时在浏览器中输入 <code>https://&lt;your_virtual_machine_ip_address&gt;/cobbler_web</code> 访问 cobbler web，初始用户名为 <em>cobbler</em>，初始密码为 <em>cobbler</em>。 </p>
<p><img src="/images/cobbler/access_cobbler_web.png" alt="访问 cobbler web 界面"></p>
<p>上载启动镜像，你可以选择挂载光盘，也可以下载 ISO 到系统文件系统内，再进行挂载。</p>
<ul>
<li>挂载光盘后，使用命令 <code>mount /dev/sr0 /mnt</code> 进行挂载。</li>
<li>下载 ISO 镜像文件后，使用命令 <code>mount -or &lt;iso_file_path&gt; /mnt</code> 进行挂载。</li>
</ul>
<p><img src="/images/cobbler/import_image.png" alt="上传镜像"></p>
<p>上传完成后我们可以看到如下内容：</p>
<p><img src="/images/cobbler/distors.png" alt="发行版"></p>
<h2 id="修改Cobbler-web登录密码"><a href="#修改Cobbler-web登录密码" class="headerlink" title="修改Cobbler web登录密码"></a>修改Cobbler web登录密码</h2><p>在终端中执行如下命令，然后输入两次密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># htdigest &#x2F;etc&#x2F;cobbler&#x2F;users.digest &quot;Cobbler&quot; cobbler</span><br><span class="line">Changing password for user cobbler in realm Cobbler</span><br><span class="line">New password: </span><br><span class="line">Re-type new password:</span><br></pre></td></tr></table></figure>

<h2 id="在新主机上安装系统"><a href="#在新主机上安装系统" class="headerlink" title="在新主机上安装系统"></a>在新主机上安装系统</h2><p>网络引导：</p>
<p><img src="/images/cobbler/PXE.png" alt="pxe"><br><img src="/images/cobbler/boot.png" alt="网络引导"></p>
<p>选择你想要安装的发行版本</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Build_a_simple_container_image/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Build_a_simple_container_image/" class="post-title-link" itemprop="url">构建一个简单的容器镜像</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:44:00" itemprop="dateCreated datePublished" datetime="2020-05-11T14:44:00+08:00">2020-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">容器</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>先列出 <a href="https://github.com/renkeju/freerdp" target="_blank" rel="noopener">freerdp</a> 的目录树：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">freerdp</span><br><span class="line">├── docker-compose.build.yml</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── entrypoint.sh</span><br><span class="line">├── freerdp.repo</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>

<ul>
<li>Dockerfile 是构建镜像的文件，当我们在目录 freerdp 中执行<code>docker build -t freerdp:latest .</code>命令后，本地会构建一个名为“freerdp:latest”的镜像。</li>
<li>entrypoint.sh 是在构建镜像的过程中添加到镜像内部的一个 shell 脚本，主要作用为了启动容器是可以将一些自定义的变量在容器内生效。</li>
<li>docker-compose.yml/docker-compose.build.yml 这两个文件可以通过 <code>docker-compose</code> 命令启动容器，docker-compose.build.yml 会在本地构建镜像并启动，docker-compose.yml 则从公共镜像仓库获取镜像后启动。</li>
<li>freerdp.repo 是一个 repo 仓库文件，在构建镜像时，这个文件会添加到 <code>/etc/yum.repos.d</code> 目录下。</li>
</ul>
<h2 id="Dockerfile-的内容"><a href="#Dockerfile-的内容" class="headerlink" title="Dockerfile 的内容"></a>Dockerfile 的内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:6</span><br><span class="line">MAINTAINER Keju Ren &lt;renkeju@gmail.com&gt;</span><br><span class="line">ENV PORT 8888</span><br><span class="line">ENV BINDADDR 127.0.0.1</span><br><span class="line"></span><br><span class="line">ADD freerdp.repo &#x2F;etc&#x2F;yum.repos.d</span><br><span class="line">RUN yum makecache &amp;&amp; \</span><br><span class="line">    yum update -y &amp;&amp; \</span><br><span class="line">    yum -y install wsgate</span><br><span class="line"></span><br><span class="line">ADD entrypoint.sh &#x2F;</span><br><span class="line">RUN chmod +x &#x2F;entrypoint.sh &amp;&amp; \</span><br><span class="line">    ln -s &#x2F;entrypoint.sh &#x2F;usr&#x2F;bin</span><br><span class="line"></span><br><span class="line">EXPOSE $PORT</span><br><span class="line"></span><br><span class="line">CMD entrypoint.sh</span><br></pre></td></tr></table></figure>

<ol>
<li>通过 FROM 这个关键字我们可以从公共镜像仓库中获取一个镜像作为我们的基础镜像。</li>
<li>maintainer 说明一下维护者的联系方式</li>
<li>在 ENV 中定义了两个环境变量。环境变量不一定需要值，在启动镜像时也可以从外部传入值。PORT变量是配置文件中的端口，BINDADDR变量是配置文件中的绑定地址。</li>
<li>ADD 将当前目录下的 <code>freerdp.repo</code> 文件上传到了centos6 基础镜像的 <code>/etc/yum.repos.d</code> 目录下。</li>
<li>RUN 执行了与安装相关的命令</li>
<li>ADD 将 <code>entrypoint.sh</code> 脚本上传到了 centos6 基础镜像的根目录下。</li>
<li>RUN 脚本赋权并且做软链接</li>
<li>将 PORT 变量定义的端口号暴露出来</li>
<li>CMD 定义镜像启动时的执行操作</li>
</ol>
<h2 id="查看容器镜像详细的内容"><a href="#查看容器镜像详细的内容" class="headerlink" title="查看容器镜像详细的内容"></a>查看容器镜像详细的内容</h2><p>容器构建成功后，使用 <code>docker image inspect freerdp:latest</code> 命令查看容器镜像相关的内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">docker image inspect freerdp:latest</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;sha256:0a7b3333fe481578c6a8987e209e6a826ad046fb5099b7202d827033ea69cbf1&quot;,</span><br><span class="line">        &quot;RepoTags&quot;: [</span><br><span class="line">            &quot;freerdp:latest&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;RepoDigests&quot;: [],</span><br><span class="line">        &quot;Parent&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">        &quot;Comment&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2019-11-02T08:13:46.481340443Z&quot;,</span><br><span class="line">        &quot;Container&quot;: &quot;77535bee56c8f980129d3dcbc77367bedd85909ff6257ebb7c04997bf77419ae&quot;,</span><br><span class="line">        &quot;ContainerConfig&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;77535bee56c8&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: false,</span><br><span class="line">            &quot;AttachStdout&quot;: false,</span><br><span class="line">            &quot;AttachStderr&quot;: false,</span><br><span class="line">            &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">                &quot;8888&#x2F;tcp&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Tty&quot;: false,</span><br><span class="line">            &quot;OpenStdin&quot;: false,</span><br><span class="line">            &quot;StdinOnce&quot;: false,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;,</span><br><span class="line">                &quot;PORT&#x3D;8888&quot;,</span><br><span class="line">                &quot;BINDADDR&#x3D;127.0.0.1&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;&#x2F;bin&#x2F;sh&quot;,</span><br><span class="line">                &quot;-c&quot;,</span><br><span class="line">                &quot;#(nop) &quot;,</span><br><span class="line">                &quot;CMD [\&quot;&#x2F;bin&#x2F;sh\&quot; \&quot;-c\&quot; \&quot;entrypoint.sh\&quot;]&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20181006&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DockerVersion&quot;: &quot;19.03.4&quot;,</span><br><span class="line">        &quot;Author&quot;: &quot;Keju Ren &lt;renkeju@gmail.com&gt;&quot;,</span><br><span class="line">        &quot;Config&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: false,</span><br><span class="line">            &quot;AttachStdout&quot;: false,</span><br><span class="line">            &quot;AttachStderr&quot;: false,</span><br><span class="line">            &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">                &quot;8888&#x2F;tcp&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Tty&quot;: false,</span><br><span class="line">            &quot;OpenStdin&quot;: false,</span><br><span class="line">            &quot;StdinOnce&quot;: false,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;,</span><br><span class="line">                &quot;PORT&#x3D;8888&quot;,</span><br><span class="line">                &quot;BINDADDR&#x3D;127.0.0.1&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;&#x2F;bin&#x2F;sh&quot;,</span><br><span class="line">                &quot;-c&quot;,</span><br><span class="line">                &quot;entrypoint.sh&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20181006&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">        &quot;Os&quot;: &quot;linux&quot;,</span><br><span class="line">        &quot;Size&quot;: 625547394,</span><br><span class="line">        &quot;VirtualSize&quot;: 625547394,</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;ad889e09f7b4cbe8d3234f438c8319877172531f7392377600c8df876d7832dd&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;60dd8a91b33be52d53145fe3aed04834ece10a92166aaf0532d5f66a9d067318&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;077badaf444344118bd8197be3d0b841fdfdc1044aa9a5a483acceddc54627a5&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;17535fa5f72208d996b9b99fc325e4fc5066fb39bf7eebbbed2b202678418486&#x2F;diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;RootFS&quot;: &#123;</span><br><span class="line">            &quot;Type&quot;: &quot;layers&quot;,</span><br><span class="line">            &quot;Layers&quot;: [</span><br><span class="line">                &quot;sha256:af6bf1987c2eb07d73f33836b0d8fd825d7c785273526b077e46780e8b4b2ae9&quot;,</span><br><span class="line">                &quot;sha256:cc8e5a6b427b31cf82519aac2ca72844444e9df74734d343dd5b81527dc1f258&quot;,</span><br><span class="line">                &quot;sha256:87715d9735cfcae05d246891eee5583492253e37d270a480665fcd0985fa5dc5&quot;,</span><br><span class="line">                &quot;sha256:a7c3fa2ec462a6226c6d43afe2b694ece538acf184dd07f152a882657f8c51d8&quot;,</span><br><span class="line">                &quot;sha256:1456e758e7b477d0d55b8bd82e3711c57d6616181497044a2ca1f05a63f7b927&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Metadata&quot;: &#123;</span><br><span class="line">            &quot;LastTagTime&quot;: &quot;2019-11-02T16:13:46.509755292+08:00&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以看到在打印出的内容中 ENV 与 CMD 与Dockerfile 中定义的 ENV 与 CMD 相同。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Brief_description_of_the_configuration_file/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Brief_description_of_the_configuration_file/" class="post-title-link" itemprop="url">配置文件的简单说明</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在文章 <a href="/2020/05/11/Quickly_build_a_monitoring_system_test_environment/" title="快速构建监控系统测试环境">快速构建监控系统测试环境</a> 中，我们已经启动了一个实验环境，<a href="https://github.com/renkeju/prometheus_lab.git" target="_blank" rel="noopener">prometheus_lab</a> 中的配置文件内容被没有做详细的说明。下面我们来说说测试环境中的配置文件。</p>
<h2 id="Prometheus-scrape-config"><a href="#Prometheus-scrape-config" class="headerlink" title="Prometheus scrape config"></a>Prometheus scrape config</h2><p>这里只着重说明 <code>prometheus/prometheus.yml</code> 文件中与 SNMP 相关的配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/prometheus/file_sd/node.yml</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">snmp</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">30s</span> <span class="comment"># 覆盖全局默认值</span></span><br><span class="line">    <span class="attr">scrape_timeout:</span> <span class="string">5s</span> <span class="comment"># 覆盖全局默认值</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/prometheus/file_sd/snmp.yml</span> <span class="comment"># 指定 snmp 服务发现配置文件路径</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/snmp</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">if_mib</span>   <span class="comment"># 指定默认采集 MIB 模块的名称</span></span><br><span class="line">      <span class="attr">community:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">public</span>  <span class="comment"># 指定团体号，当 snmp_exporter snmp.yml 配置文件没有指定团体号，此处定义的团体号生效。</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">replacement:</span> <span class="string">snmp_exporter:9116</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span>  <span class="comment"># 从目标中获取MIB模块名称</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mib</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_module</span></span><br></pre></td></tr></table></figure>

<h2 id="Service-Discovery-Config"><a href="#Service-Discovery-Config" class="headerlink" title="Service Discovery Config"></a>Service Discovery Config</h2><p>snmp 的服务发现配置文件中我们可以额外定义一些参数，方便我们可以对不同目标做更小颗粒度的划分。<br>自动发现配置文件支持 json 格式与 yaml 格式，目标定义了 Prometheus 必须为指标而抓取的端点。<br>比如我在下面的示例中添加了<code>architecture</code>与<code>model</code>等变量，这些变量prometheus获取目标信息是，会作为目标的标签与目标绑定。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">"labels"</span>: &#123;</span><br><span class="line">          <span class="attr">"mib"</span>: <span class="string">"apcups"</span>,</span><br><span class="line">          <span class="attr">"architecture"</span>: <span class="string">"x86_64"</span>,</span><br><span class="line">          <span class="attr">"model"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"targets"</span>: [</span><br><span class="line">          <span class="string">"snmpd"</span></span><br><span class="line">      ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><img src="/images/Brief_description_of_the_configuration_file/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" alt="服务发现中的目标标签"></p>
<h2 id="多个目标"><a href="#多个目标" class="headerlink" title="多个目标"></a>多个目标</h2><p>如果有多个目标，需要在服务发现配置文件中列出多个目标信息，这里我贴出一个简单的 python 脚本，可以生成自动发现配置文件，你也可以根据自己的需求修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>], <span class="string">"r"</span>) <span class="keyword">as</span> handler:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> handler:</span><br><span class="line">        line = line.strip(<span class="string">'\n'</span>)</span><br><span class="line">        fields = line.split(<span class="string">','</span>)</span><br><span class="line">        labels = &#123;&#125;</span><br><span class="line">        labels[<span class="string">'brand'</span>] = fields[<span class="number">1</span>]</span><br><span class="line">        labels[<span class="string">'model'</span>] = fields[<span class="number">2</span>]</span><br><span class="line">        labels[<span class="string">'hostname'</span>] = fields[<span class="number">3</span>]</span><br><span class="line">        labels[<span class="string">'mib'</span>] = fields[<span class="number">4</span>]</span><br><span class="line">        targets = []</span><br><span class="line">        targets.append(fields[<span class="number">0</span>])</span><br><span class="line">        custom = &#123;&#125;</span><br><span class="line">	custom[<span class="string">'targets'</span>] = targets</span><br><span class="line">        custom[<span class="string">'labels'</span>] = labels</span><br><span class="line">        print(custom)</span><br><span class="line">        data.append(custom)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">2</span>], <span class="string">"w"</span>) <span class="keyword">as</span> json_handler:</span><br><span class="line">    json.dump(data, json_handler, indent=<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>你需要提前编辑一个 csv 文件，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.1,Huawei,S5328C-EI,BJ-LG-HW5328,if_mib</span><br><span class="line">192.168.100.2,Huawei,Quidway S9306,SH-GQ-HW9306CSS,if_mib</span><br><span class="line">192.168.100.3,Huawei,Quidway S9306,BJ-LG-HW9306CSS,if_mib</span><br><span class="line">192.168.100.4,Huawei,Quidway S9306,GZ-RMZ-HW9306CSS,if_mib</span><br></pre></td></tr></table></figure>

<p>第一个逗号前的内容为主机地址，第二个逗号前的内容为设备厂商名称，第三个逗号前的内容设备型号，第四个逗号前的内容为自定义设备名称，最后一段内容为获取mib名称。<br>使用下面的名称执行脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sd_generate.py &lt;your_csv_file_name&gt; &lt;sd_json_file_name&gt;</span><br></pre></td></tr></table></figure>

<p>执行后生成如下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"BJ-LG-HW5328"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"S5328C-EI"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.1"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"SH-GQ-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.2"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"BJ-LG-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.3"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"GZ-RMZ-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.4"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>之后 prometheus 会自动加载刚刚生成的服务发现配置文件，不需要重启 prometheus。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/SNMP_Exporter_config_generate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/SNMP_Exporter_config_generate/" class="post-title-link" itemprop="url">SNMP Exporter 配置生成器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://github.com/prometheus/snmp_exporter/tree/master/generator" target="_blank" rel="noopener">SNMP Exporter generator 项目地址</a></p>
<p>此配置生成器使用 NetSNMP 解析 MIB，并使用它们为 snmp_exporter 生成配置。</p>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>由于对 NetSNMP 的动态依赖，因此您必须自己构建生成器。</p>
<ul>
<li><p>Debian 系发行版</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install unzip build-essential libsnmp-dev # Debian-based distros</span><br></pre></td></tr></table></figure>
</li>
<li><p>Redhat 系发行版</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gcc gcc-g++ make net-snmp net-snmp-utils net-snmp-libs net-snmp-devel # RHEL-based distros</span><br><span class="line">go get github.com&#x2F;prometheus&#x2F;snmp_exporter&#x2F;generator</span><br><span class="line">cd $&#123;GOPATH-$HOME&#x2F;go&#125;&#x2F;src&#x2F;github.com&#x2F;prometheus&#x2F;snmp_exporter&#x2F;generator</span><br><span class="line">go build</span><br><span class="line">make mibs</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export MIBDIRS&#x3D;mibs</span><br><span class="line">.&#x2F;generator generate</span><br></pre></td></tr></table></figure>

<p>生成器从 <code>generator.yml</code> 读取并写入 <code>snmp.yml</code>。<br>其他命令可用于调试，请使用 <code>help</code> 命令查看它们。</p>
<h2 id="使用-Docker"><a href="#使用-Docker" class="headerlink" title="使用 Docker"></a>使用 Docker</h2><p>如果要在 docker 中运行生成器以生成 <code>snmp.yml</code> 配置，请运行以下命令。<br>Docker 镜像需要一个包含 <code>generator.yml</code> 的目录和一个名为 mibs 的目录，其中包含您要使用的所有 MIB。<br>此示例将生成示例 <code>snmp.yml</code>，该示例包含在 <code>snmp_exporter</code> 存储库的顶级中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">make</span> <span class="string">mibs</span></span><br><span class="line"><span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">snmp-generator</span> <span class="string">.</span></span><br><span class="line"><span class="string">docker</span> <span class="string">run</span> <span class="string">-ti</span> <span class="string">\</span></span><br><span class="line">  <span class="string">-v</span> <span class="string">"$&#123;PWD&#125;:/opt/"</span> <span class="string">\</span></span><br><span class="line">  <span class="string">snmp-generator</span> <span class="string">generate</span></span><br></pre></td></tr></table></figure>

<h2 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h2><p><code>generator.yml</code> 提供模块列表。最简单的模块只是一个名称和一组要遍历的 OID。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">module_name:</span>  <span class="comment"># The module name. You can have as many modules as you want.</span></span><br><span class="line">    <span class="attr">walk:</span>       <span class="comment"># List of OIDs to walk. Can also be SNMP object names or specific instances.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span>              <span class="comment"># Same as "interfaces"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sysUpTime</span>                  <span class="comment"># Same as "1.3.6.1.2.1.1.3"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.6</span><span class="number">.40</span>  <span class="comment"># Instance of "ifHCInOctets" with index "40"</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span>  <span class="comment"># SNMP version to use. Defaults to 2.</span></span><br><span class="line">                <span class="comment"># 1 will use GETNEXT, 2 and 3 use GETBULK.</span></span><br><span class="line">    <span class="attr">max_repetitions:</span> <span class="number">25</span>  <span class="comment"># How many objects to request with GET/GETBULK, defaults to 25.</span></span><br><span class="line">                         <span class="comment"># May need to be reduced for buggy devices.</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">3</span>   <span class="comment"># How many times to retry a failed request, defaults to 3.</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span> <span class="comment"># Timeout for each walk, defaults to 10s.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">auth:</span></span><br><span class="line">      <span class="comment"># Community string is used with SNMP v1 and v2. Defaults to "public".</span></span><br><span class="line">      <span class="attr">community:</span> <span class="string">public</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># v3 has different and more complex settings.</span></span><br><span class="line">      <span class="comment"># Which are required depends on the security_level.</span></span><br><span class="line">      <span class="comment"># The equivalent options on NetSNMP commands like snmpbulkwalk</span></span><br><span class="line">      <span class="comment"># and snmpget are also listed. See snmpcmd(1).</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">user</span>  <span class="comment"># Required, no default. -u option to NetSNMP.</span></span><br><span class="line">      <span class="attr">security_level:</span> <span class="string">noAuthNoPriv</span>  <span class="comment"># Defaults to noAuthNoPriv. -l option to NetSNMP.</span></span><br><span class="line">                                    <span class="comment"># Can be noAuthNoPriv, authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">pass</span>  <span class="comment"># Has no default. Also known as authKey, -A option to NetSNMP.</span></span><br><span class="line">                      <span class="comment"># Required if security_level is authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">auth_protocol:</span> <span class="string">MD5</span>  <span class="comment"># MD5 or SHA, defaults to MD5. -a option to NetSNMP.</span></span><br><span class="line">                          <span class="comment"># Used if security_level is authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">priv_protocol:</span> <span class="string">DES</span>  <span class="comment"># DES or AES, defaults to DES. -x option to NetSNMP.</span></span><br><span class="line">                          <span class="comment"># Used if security_level is authPriv.</span></span><br><span class="line">      <span class="attr">priv_password:</span> <span class="string">otherPass</span> <span class="comment"># Has no default. Also known as privKey, -X option to NetSNMP.</span></span><br><span class="line">                               <span class="comment"># Required if security_level is authPriv.</span></span><br><span class="line">      <span class="attr">context_name:</span> <span class="string">context</span> <span class="comment"># Has no default. -n option to NetSNMP.</span></span><br><span class="line">                            <span class="comment"># Required if context is configured on the device.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">lookups:</span>  <span class="comment"># Optional list of lookups to perform.</span></span><br><span class="line">              <span class="comment"># The default for `keep_source_indexes` is false. Indexes must be unique for this option to be used.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># If the index of a table is bsnDot11EssIndex, usually that'd be the label</span></span><br><span class="line">      <span class="comment"># on the resulting metrics from that table. Instead, use the index to</span></span><br><span class="line">      <span class="comment"># lookup the bsnDot11EssSsid table entry and create a bsnDot11EssSsid label</span></span><br><span class="line">      <span class="comment"># with that value.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_indexes:</span> <span class="string">[bsnDot11EssIndex]</span></span><br><span class="line">        <span class="attr">lookup:</span> <span class="string">bsnDot11EssSsid</span></span><br><span class="line">        <span class="attr">drop_source_indexes:</span> <span class="literal">false</span>  <span class="comment"># If true, delete source index labels for this lookup.</span></span><br><span class="line">                                    <span class="comment"># This avoids label clutter when the new index is unique.</span></span><br><span class="line"></span><br><span class="line">     <span class="attr">overrides:</span> <span class="comment"># Allows for per-module overrides of bits of MIBs</span></span><br><span class="line">       <span class="attr">metricName:</span></span><br><span class="line">         <span class="attr">ignore:</span> <span class="literal">true</span> <span class="comment"># Drops the metric from the output.</span></span><br><span class="line">         <span class="attr">regex_extracts:</span></span><br><span class="line">           <span class="attr">Temp:</span> <span class="comment"># A new metric will be created appending this to the metricName to become metricNameTemp.</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'(.*)'</span> <span class="comment"># Regex to extract a value from the returned SNMP walks's value.</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'$1'</span> <span class="comment"># The result will be parsed as a float64, defaults to $1.</span></span><br><span class="line">           <span class="attr">Status:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'.*Example'</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'1'</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'.*'</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'0'</span></span><br><span class="line">         <span class="attr">type:</span> <span class="string">DisplayString</span> <span class="comment"># Override the metric type, possible types are:</span></span><br><span class="line">                             <span class="comment">#   gauge:   An integer with type gauge.</span></span><br><span class="line">                             <span class="comment">#   counter: An integer with type counter.</span></span><br><span class="line">                             <span class="comment">#   OctetString: A bit string, rendered as 0xff34.</span></span><br><span class="line">                             <span class="comment">#   DateAndTime: An RFC 2579 DateAndTime byte sequence. If the device has no time zone data, UTC is used.</span></span><br><span class="line">                             <span class="comment">#   DisplayString: An ASCII or UTF-8 string.</span></span><br><span class="line">                             <span class="comment">#   PhysAddress48: A 48 bit MAC address, rendered as 00:01:02:03:04:ff.</span></span><br><span class="line">                             <span class="comment">#   Float: A 32 bit floating-point value with type gauge.</span></span><br><span class="line">                             <span class="comment">#   Double: A 64 bit floating-point value with type gauge.</span></span><br><span class="line">                             <span class="comment">#   InetAddressIPv4: An IPv4 address, rendered as 1.2.3.4.</span></span><br><span class="line">                             <span class="comment">#   InetAddressIPv6: An IPv6 address, rendered as 0102:0304:0506:0708:090A:0B0C:0D0E:0F10.</span></span><br><span class="line">                             <span class="comment">#   InetAddress: An InetAddress per RFC 4001. Must be preceded by an InetAddressType.</span></span><br><span class="line">                             <span class="comment">#   InetAddressMissingSize: An InetAddress that violates section 4.1 of RFC 4001 by</span></span><br><span class="line">                             <span class="comment">#       not having the size in the index. Must be preceded by an InetAddressType.</span></span><br><span class="line">                             <span class="comment">#   EnumAsInfo: An enum for which a single timeseries is created. Good for constant values.</span></span><br><span class="line">                             <span class="comment">#   EnumAsStateSet: An enum with a time series per state. Good for variable low-cardinality enums.</span></span><br></pre></td></tr></table></figure>

<h2 id="EnumAsInfo-和-EnumAsStateSet"><a href="#EnumAsInfo-和-EnumAsStateSet" class="headerlink" title="EnumAsInfo 和 EnumAsStateSet"></a>EnumAsInfo 和 EnumAsStateSet</h2><p>SNMP 包含整数索引枚举的概念。 在 Prometheus 中有两种表示这些字符串的方法。 它们可以是“信息”指标，也可以是“状态集”。 SNMP 没有指定应使用的内容，这取决于数据的使用情况。 一些用户可能更喜欢原始整数值，而不是字符串。<br>为了将枚举整数设置为字符串映射，必须使用两个替代之一。<br><code>EnumAsInfo</code>应该用于提供类库存数据的属性。 例如设备类型，颜色名称等。此值恒定是很重要的。<br><code>EnumAsStateSet</code>应该用于表示状态或您可能要发出警报的事物。 例如，链接状态是打开还是关闭，处于错误状态，面板是打开还是关闭等。请注意不要将其用于高基数值，因为它将为每个可能的值生成1个时间序列。</p>
<h2 id="从哪里获得-MIB"><a href="#从哪里获得-MIB" class="headerlink" title="从哪里获得 MIB"></a>从哪里获得 MIB</h2><p>其中一些相当缓慢，建议使用 wget下载。<br>将提取的 mib 放在 NetSNMP 可以读取的位置。 <code>$HOME/.snmp/mibs</code> 是一种选择。</p>
<ul>
<li>Cisco: <a href="ftp://ftp.cisco.com/pub/mibs/v2/v2.tar.gz">ftp://ftp.cisco.com/pub/mibs/v2/v2.tar.gz</a></li>
<li>APC: <a href="https://download.schneider-electric.com/files?p_File_Name=powernet426.mib" target="_blank" rel="noopener">https://download.schneider-electric.com/files?p_File_Name=powernet426.mib</a></li>
<li>Servertech: <a href="ftp://ftp.servertech.com/Pub/SNMP/sentry3/Sentry3.mib">ftp://ftp.servertech.com/Pub/SNMP/sentry3/Sentry3.mib</a></li>
<li>Palo Alto PanOS 7.0 enterprise MIBs: <a href="https://www.paloaltonetworks.com/content/dam/pan/en_US/assets/zip/technical-documentation/snmp-mib-modules/PAN-MIB-MODULES-7.0.zip" target="_blank" rel="noopener">https://www.paloaltonetworks.com/content/dam/pan/en_US/assets/zip/technical-documentation/snmp-mib-modules/PAN-MIB-MODULES-7.0.zip</a></li>
<li>Arista Networks:<br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-ENTITY-SENSOR-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-ENTITY-SENSOR-MIB.txt</a><br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-SW-IP-FORWARDING-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-SW-IP-FORWARDING-MIB.txt</a><br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-SMI-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-SMI-MIB.txt</a></li>
<li>Synology: <a href="https://global.download.synology.com/download/Document/MIBGuide/Synology_MIB_File.zip" target="_blank" rel="noopener">https://global.download.synology.com/download/Document/MIBGuide/Synology_MIB_File.zip</a></li>
<li>MikroTik: <a href="http://download2.mikrotik.com/Mikrotik.mib" target="_blank" rel="noopener">http://download2.mikrotik.com/Mikrotik.mib</a></li>
<li>UCD-SNMP-MIB (Net-SNMP): <a href="http://www.net-snmp.org/docs/mibs/UCD-SNMP-MIB.txt" target="_blank" rel="noopener">http://www.net-snmp.org/docs/mibs/UCD-SNMP-MIB.txt</a></li>
<li>Ubiquiti Networks:<br><a href="http://dl.ubnt-ut.com/snmp/UBNT-MIB" target="_blank" rel="noopener">http://dl.ubnt-ut.com/snmp/UBNT-MIB</a><br><a href="http://dl.ubnt-ut.com/snmp/UBNT-UniFi-MIB" target="_blank" rel="noopener">http://dl.ubnt-ut.com/snmp/UBNT-UniFi-MIB</a><br><a href="https://dl.ubnt.com/firmwares/airos-ubnt-mib/ubnt-mib.zip" target="_blank" rel="noopener">https://dl.ubnt.com/firmwares/airos-ubnt-mib/ubnt-mib.zip</a></li>
</ul>
<p><a href="https://github.com/librenms/librenms/tree/master/mibs" target="_blank" rel="noopener">https://github.com/librenms/librenms/tree/master/mibs</a> can also be a good source of MIBs.<br><a href="http://oidref.com" target="_blank" rel="noopener">http://oidref.com</a> is recommended for browsing MIBs.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Quickly_build_a_monitoring_system_test_environment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Quickly_build_a_monitoring_system_test_environment/" class="post-title-link" itemprop="url">快速构建监控系统测试环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>在测试环境中建议使用 Docker 进行部署。在后面的生产环境部署中我也会提供 Ansible 安装方式。<br><a href="https://download.daocloud.io/Docker_Mirror/Docker" target="_blank" rel="noopener">Docker 安装方式</a><br><a href="https://download.daocloud.io/Docker_Mirror/Docker_Compose" target="_blank" rel="noopener">Docker Compose 安装方式</a><br><a href="https://www.daocloud.io/mirror" target="_blank" rel="noopener">Docker 加速器</a></p>
<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p><a href="https://github.com/renkeju/prometheus_lab" target="_blank" rel="noopener">prometheus 实验环境 Docker Compose 编排文件项目地址</a></p>
<ul>
<li>启动<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/renkeju/prometheus_lab.git</span><br><span class="line"><span class="built_in">cd</span> prometheus_lab</span><br><span class="line">docker-compose push</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li>
<li>停止<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br></pre></td></tr></table></figure></li>
<li>删除<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose rm -f</span><br><span class="line">docker volume prune <span class="comment"># 注意：执行此命令之后所存储的历史数据都会被删除</span></span><br></pre></td></tr></table></figure></li>
<li>查看日志<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs</span><br></pre></td></tr></table></figure>
<h2 id="启动后检查"><a href="#启动后检查" class="headerlink" title="启动后检查"></a>启动后检查</h2>在 docker compose 文件中暴露了三个端口号，分别是：</li>
</ul>
<table>
<thead>
<tr>
<th align="center">端口号</th>
<th align="center">容器内端口号</th>
<th align="center">服务</th>
<th align="center">用户认证</th>
</tr>
</thead>
<tbody><tr>
<td align="center">3000</td>
<td align="center">3000</td>
<td align="center">grafana</td>
<td align="center">有</td>
</tr>
<tr>
<td align="center">9090</td>
<td align="center">9090</td>
<td align="center">prometheus</td>
<td align="center">无</td>
</tr>
<tr>
<td align="center">9116</td>
<td align="center">9116</td>
<td align="center">snmp_exporter</td>
<td align="center">无</td>
</tr>
</tbody></table>
<p>其他容器内启动的服务端口号没有必要暴露出来，使用 <code>links</code> 作为链接，可以提高安全性。如果需要为其他服务端口访问添加访问认证，可以配置 Nginx 使用，在后面我们会提到。</p>
<ul>
<li><p>Grafana</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:3000</code> 访问 Grafana，默认用户名：<code>admin</code>，密码则是 docker-composer 文件中变量 <code>GF_SECURITY_ADMIN_PASSWORD</code> 的值。</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/grafana.png" alt="第一次登录 Grafana"></p>
</li>
<li><p>prometheus</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:9090</code> 访问 prometheus</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" alt="prometheus 服务发现"></p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E7%9B%AE%E6%A0%87.png" alt="prometheus 目标"></p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E5%91%8A%E8%AD%A6.png" alt="prometheus 报警"></p>
</li>
<li><p>snmp_exporter</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:9116</code> 访问 snmp_exporter，snmp_exporter web 提供的信息并不多，你可以查看 <code>snmp.yml</code> 配置文件的内容，也可以对 snmpd 服务进行测试。</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/SNMP_exporter.png" alt="snmp_exporter"></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Prometheus_SNMP_Exporter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Prometheus_SNMP_Exporter/" class="post-title-link" itemprop="url">Prometheus SNMP Exporter</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://github.com/prometheus/snmp_exporter" target="_blank" rel="noopener">Prometheus SNMP Exporter 项目地址</a></p>
<p>SNMP Exporter 从 SNMP 服务中采集信息提供给 Promethers 监控系统使用。<br>有两个部分，执行提供数据的 exporter，以使用的 <a href="https://github.com/prometheus/snmp_exporter/blob/master/generator" target="_blank" rel="noopener">generator</a> （取决于netsnmp）生成配置为 exporter 提供配置。</p>
<h2 id="Exporter-配置"><a href="#Exporter-配置" class="headerlink" title="Exporter 配置"></a>Exporter 配置</h2><p>默认情况下，snmp exporter 从 snmp.yml 文件中读取配置。此文件不是手动编写的，而是使用 <a href="https://github.com/prometheus/snmp_exporter/blob/master/generator" target="_blank" rel="noopener">generator</a> 生成它。<br>默认配置的 snmp.yml 配置文件中包含各种公共硬件，对于这些硬件，mib对常见设备通用，使用 snmp v2 GETBULK 可以遍历它们。<br>除了最简单的设置外，您还需要使用生成器。需要定制哪些对象是遍历的，使用非公开 MIB 或指定认证参数。</p>
<h2 id="Prometheus-配置"><a href="#Prometheus-配置" class="headerlink" title="Prometheus 配置"></a>Prometheus 配置</h2><p>SNMP Exporter 需要将地址作为参数传递，这可以通过重新标记来完成。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'snmp'</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span>  <span class="comment"># SNMP 设备</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/snmp</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span> <span class="string">[if_mib]</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9116</span>  <span class="comment"># SNMP exporter's 真正地址，格式为 hostname:port。</span></span><br></pre></td></tr></table></figure>

<p>这种配置允许 Prometheus 提供调度和服务自动发现，这与不能在我们要从其获取指标的机器上运行 Exporter 的所有其他 Exporter 有所不同。</p>
<h2 id="处理大计数器值"><a href="#处理大计数器值" class="headerlink" title="处理大计数器值"></a>处理大计数器值</h2><p>为 Counter64 较大的值提供准确的计数器，exporter 将为每 2^53 值自动包装，以避免 64 位浮点舍入。<br>要禁用此功能，请使用命令行参数 <code>--no-snmp.wrap-large-counters</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Keju Ren"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Keju Ren</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/renkeju" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;renkeju" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:renkeju@gmail.com" title="E-Mail → mailto:renkeju@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Keju Ren</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
