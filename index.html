<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.renkeju.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="时光穿梭机">
<meta property="og:url" content="https://blog.renkeju.com/index.html">
<meta property="og:site_name" content="时光穿梭机">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Keju Ren">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="Cloud">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.renkeju.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>时光穿梭机</title>
  
    <script>
      function sendPageView() {
        if (CONFIG.hostname !== location.hostname) return;
        var uid = localStorage.getItem('uid') || (Math.random() + '.' + Math.random());
        localStorage.setItem('uid', uid);
        navigator.sendBeacon('https://www.google-analytics.com/collect', new URLSearchParams({
          v  : 1,
          tid: 'UA-149464655-1',
          cid: uid,
          t  : 'pageview',
          dp : encodeURIComponent(location.pathname)
        }));
      }
      document.addEventListener('pjax:complete', sendPageView);
      sendPageView();
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">时光穿梭机</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">穿梭时间的飞行日志</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/21/firewalld-NAT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/21/firewalld-NAT/" class="post-title-link" itemprop="url">在 CentOS7 使用 firewalld 配置 NAT</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-21 15:16:21 / 修改时间：15:33:06" itemprop="dateCreated datePublished" datetime="2020-05-21T15:16:21+08:00">2020-05-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="创建WAN-LAN区域"><a href="#创建WAN-LAN区域" class="headerlink" title="创建WAN\LAN区域"></a>创建WAN\LAN区域</h2><p>配置NAT需要有两个网络平面，一个负责WAN，一个负责LAN，先创建网卡的zone分别为External（WAN）和Internal（LAN），下面的示例中ens32负责WAN，ens36负责LAN。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nmcli c mod ens32 connection.zone external</span><br><span class="line"># nmcli c mod ens36 connection.zone internal</span><br></pre></td></tr></table></figure>

<p>确认一下是否创建成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --get-active-zone</span><br></pre></td></tr></table></figure>

<p>WAN\LAN配置IP masquerad</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --zone&#x3D;external --add-masquerade --permanent</span><br><span class="line"># firewall-cmd --zone&#x3D;internal --add-masquerade --permanent</span><br><span class="line"># firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>检查一下ip fordwarding 是否启用，如果启用的话为1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br></pre></td></tr></table></figure>

<p>如果<code>/proc/sys/net/ipv4/ip_forward</code>不为1，执行下面的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;sysctl.d&#x2F;99-sysctl.conf </span><br><span class="line"></span><br><span class="line">net.ipv4&#x2F;ip_forward &#x3D; 1</span><br><span class="line"></span><br><span class="line"># sysctl --system</span><br></pre></td></tr></table></figure>

<h2 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h2><p>因为修改了网卡的区域，之前在 public 区域生效的防火墙规则已经失效，所以需要对需要对WAN/LAN开放的端口进行配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --add-service&#x3D;http --zone&#x3D;external --permanent</span><br></pre></td></tr></table></figure>

<ul>
<li>–add-service 指定服务</li>
<li>–zone 指定区域</li>
<li>–permanent 将规则添加到持久规则集</li>
</ul>
<p>当所有服务都定义完成后，可以使用如下命令重新加载 FirewallD。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><p>查看已经配置完成的区域</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --zone&#x3D;external --list-all</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/cobbler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/cobbler/" class="post-title-link" itemprop="url">cobbler 部署与实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:44:00" itemprop="dateCreated datePublished" datetime="2020-05-11T14:44:00+08:00">2020-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-21 15:38:39" itemprop="dateModified" datetime="2020-05-21T15:38:39+08:00">2020-05-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">自动化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="初始化环境"><a href="#初始化环境" class="headerlink" title="初始化环境"></a>初始化环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install epel-release</span><br><span class="line"># yum makecache</span><br><span class="line"># yum -y update</span><br><span class="line"># systemctl --now disable postfix firewalld</span><br><span class="line"># setenforce 0</span><br><span class="line"># sed -i &#39;s@^\(SELINUX&#x3D;\).*@\1disabled@&#39; &#x2F;etc&#x2F;sysconfig&#x2F;selinux</span><br><span class="line"># sed -i &#39;s@^\(SELINUX&#x3D;\).*@\1disabled@&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line"># reboot</span><br></pre></td></tr></table></figure>

<h2 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install cobbler cobbler-web pykickstart debmirror httpd tftp-server rsync debmirror fence-agents xinetd dhcp bind</span><br><span class="line"># systemctl --now enable cobblerd httpd rsyncd dhcpd named xinetd</span><br></pre></td></tr></table></figure>

<h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># cobbler check</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : The &#39;server&#39; field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the &#39;next_server&#39; field in &#x2F;etc&#x2F;cobbler&#x2F;settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.   </span><br><span class="line">3 : SELinux is enabled. Please review the following wiki page for details on ensuring cobbler works correctly in your SELinux environment:</span><br><span class="line">    https:&#x2F;&#x2F;github.com&#x2F;cobbler&#x2F;cobbler&#x2F;wiki&#x2F;Selinux</span><br><span class="line">4 : Some network boot-loaders are missing from &#x2F;var&#x2F;lib&#x2F;cobbler&#x2F;loaders, you may run &#39;cobbler get-loaders&#39; to download them, or, if you only want to handle x86&#x2F;x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The &#39;cobbler get-loaders&#39; command is the easiest way to resolve these requirements.</span><br><span class="line">5 : comment out &#39;dists&#39; on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">6 : comment out &#39;arches&#39; on &#x2F;etc&#x2F;debmirror.conf for proper debian support</span><br><span class="line">7 : The default password used by the sample templates for newly installed machines (default_password_crypted in &#x2F;etc&#x2F;cobbler&#x2F;settings) is still set to &#39;cobbler&#39; and should be changed, try: &quot;openssl passwd -1 -salt &#39;random-phrase-here&#39; &#39;your-password-here&#39;&quot; to generate new one</span><br><span class="line"></span><br><span class="line">Restart cobblerd and then run &#39;cobbler sync&#39; to apply changes.</span><br></pre></td></tr></table></figure>

<h2 id="解决报错"><a href="#解决报错" class="headerlink" title="解决报错"></a>解决报错</h2><ul>
<li><p><code>/etc/cobbler/settings</code> 配置文件中 “server” 字段必须设置为 localhos t以外的 IP 地址,否则 kickstart 将不会工作。应该使用的是一个可解析启动服务器的主机名或所有服务器可以访问的 IP 地址。</p>
</li>
<li><p>PXE 放置在 functional 区域,在 <code>/etc/cobbler/settings</code> 配置文件中 “next_server” 字段必须设置为 127.0.0.1 以外的 IP 地址,而且应该匹配 PXE 启动服务器的 IP 网络。</p>
</li>
<li><p>检查是否关闭了 SELinux</p>
</li>
<li><p><code>/var/lib/cobbler/loaders</code> 文件缺少一些网络引导加载程序,您可以运行 “cobbler get-loaders” 下载,或者,如果您只想处理 x86/x86_64 网络引导,你可以确保您已经安装了一个最近的 recent 版本的 syslinux 包安装和完全可以忽略此消息。这个目录中的文件,你应该要支持所有架构,应包括 pxelinux.0 menu.c32 elilo.efi yaboot。执行 <code>cobbler get-loaders</code> 命令是解决这些需求最简单的方法。</p>
</li>
<li><p>在 <code>/etc/debmirror.conf</code> 配置文件中将 <strong>dists</strong> 所在行注释</p>
</li>
<li><p>在 <code>/etc/debmirror.conf</code> 配置文件中将 <strong>arches</strong> 所在行注释</p>
</li>
<li><p>在新安装的示例模板机器仍将使用 “cobbler” 作为默认密码(/etc/cobbler/settings default_password_crypted)最好更改一下,尝试使用: <code>openssl passwd -1 -salt ‘random-phrase-here’ ‘your-password-here’</code> 产生新的密码</p>
</li>
</ul>
<h2 id="配置-cobbler"><a href="#配置-cobbler" class="headerlink" title="配置 cobbler"></a>配置 cobbler</h2><p>配置 <code>/etc/cobbler/settings</code>，让 cobbler 接管 dns、dhcp、rsync 服务，修改配置文件中的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">manager_dns: 1</span><br><span class="line">manager_dhcp: 1</span><br><span class="line">manager_rsync: 1</span><br></pre></td></tr></table></figure>

<p>修改 cobbler dhcpd <code>/etc/cobbler/dhcp.template</code> 配置模板文件，主要将 dhcp 地址段范围修改与你网卡相同地址段:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"># ******************************************************************</span><br><span class="line"># Cobbler managed dhcpd.conf file</span><br><span class="line">#</span><br><span class="line"># generated from cobbler dhcp.conf template ($date)</span><br><span class="line"># Do NOT make changes to &#x2F;etc&#x2F;dhcpd.conf. Instead, make your changes</span><br><span class="line"># in &#x2F;etc&#x2F;cobbler&#x2F;dhcp.template, as &#x2F;etc&#x2F;dhcpd.conf will be</span><br><span class="line"># overwritten.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line">******************************************************************                                </span><br><span class="line"></span><br><span class="line">ddns-update-style interim;</span><br><span class="line">allow booting;</span><br><span class="line">allow bootp;</span><br><span class="line">ignore client-updates;</span><br><span class="line">set vendorclass &#x3D; option vendor-class-identifier;</span><br><span class="line"></span><br><span class="line">option pxe-system-type code 93 &#x3D; unsigned integer 16;</span><br><span class="line"></span><br><span class="line">subnet 192.168.133.0 netmask 255.255.255.0 &#123;</span><br><span class="line">     option routers             192.168.133.5;</span><br><span class="line">     option domain-name-servers 192.168.133.100;</span><br><span class="line">     option subnet-mask         255.255.255.0;</span><br><span class="line">     range dynamic-bootp        192.168.133.100 192.168.133.254;</span><br><span class="line">     default-lease-time         21600;</span><br><span class="line">     max-lease-time             43200;</span><br><span class="line">     next-server                $next_server;</span><br><span class="line">     class &quot;pxeclients&quot; &#123;</span><br><span class="line">          match if substring (option vendor-class-identifier, 0, 9) &#x3D; &quot;PXEClient&quot;;</span><br><span class="line">          if option pxe-system-type &#x3D; 00:02 &#123;</span><br><span class="line">                  filename &quot;ia64&#x2F;elilo.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:06 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:07 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86_64.efi&quot;;</span><br><span class="line">          &#125; else if option pxe-system-type &#x3D; 00:09 &#123;</span><br><span class="line">                  filename &quot;grub&#x2F;grub-x86_64.efi&quot;;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">                  filename &quot;pxelinux.0&quot;;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#for dhcp_tag in $dhcp_tags.keys():</span><br><span class="line">    ## group could be subnet if your dhcp tags line up with your subnets</span><br><span class="line">    ## or really any valid dhcpd.conf construct ... if you only use the</span><br><span class="line">    ## default dhcp tag in cobbler, the group block can be deleted for a</span><br><span class="line">    ## flat configuration</span><br><span class="line"># group for Cobbler DHCP tag: $dhcp_tag</span><br><span class="line">group &#123;</span><br><span class="line">        #for mac in $dhcp_tags[$dhcp_tag].keys():</span><br><span class="line">            #set iface &#x3D; $dhcp_tags[$dhcp_tag][$mac]</span><br><span class="line">    host $iface.name &#123;</span><br><span class="line">        #if $iface.interface_type &#x3D;&#x3D; &quot;infiniband&quot;:</span><br><span class="line">        option dhcp-client-identifier &#x3D; $mac;</span><br><span class="line">        #else</span><br><span class="line">        hardware ethernet $mac;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.ip_address:</span><br><span class="line">        fixed-address $iface.ip_address;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.hostname:</span><br><span class="line">        option host-name &quot;$iface.hostname&quot;;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.netmask:</span><br><span class="line">        option subnet-mask $iface.netmask;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.gateway:</span><br><span class="line">        option routers $iface.gateway;</span><br><span class="line">        #end if</span><br><span class="line">        #if $iface.enable_gpxe:</span><br><span class="line">        if exists user-class and option user-class &#x3D; &quot;gPXE&quot; &#123;</span><br><span class="line">            filename &quot;http:&#x2F;&#x2F;$cobbler_server&#x2F;cblr&#x2F;svc&#x2F;op&#x2F;gpxe&#x2F;system&#x2F;$iface.owner&quot;;</span><br><span class="line">        &#125; else if exists user-class and option user-class &#x3D; &quot;iPXE&quot; &#123;</span><br><span class="line">            filename &quot;http:&#x2F;&#x2F;$cobbler_server&#x2F;cblr&#x2F;svc&#x2F;op&#x2F;gpxe&#x2F;system&#x2F;$iface.owner&quot;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            filename &quot;undionly.kpxe&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        #else</span><br><span class="line">        filename &quot;$iface.filename&quot;;</span><br><span class="line">        #end if</span><br><span class="line">        ## Cobbler defaults to $next_server, but some users</span><br><span class="line">        ## may like to use $iface.system.server for proxied setups</span><br><span class="line">        next-server $next_server;</span><br><span class="line">        ## next-server $iface.next_server;</span><br><span class="line">    &#125;</span><br><span class="line">        #end for</span><br><span class="line">&#125;</span><br><span class="line">#end for</span><br></pre></td></tr></table></figure>
<p>修改完成后，执行 <code>cobbler sync</code> 命令进行同步。</p>
<h2 id="访问-cobbler"><a href="#访问-cobbler" class="headerlink" title="访问 cobbler"></a>访问 cobbler</h2><p>此时在浏览器中输入 <code>https://&lt;your_virtual_machine_ip_address&gt;/cobbler_web</code> 访问 cobbler web，初始用户名为 <em>cobbler</em>，初始密码为 <em>cobbler</em>。 </p>
<p><img src="/images/cobbler/access_cobbler_web.png" alt="访问 cobbler web 界面"></p>
<p>上载启动镜像，你可以选择挂载光盘，也可以下载 ISO 到系统文件系统内，再进行挂载。</p>
<ul>
<li>挂载光盘后，使用命令 <code>mount /dev/sr0 /mnt</code> 进行挂载。</li>
<li>下载 ISO 镜像文件后，使用命令 <code>mount -or &lt;iso_file_path&gt; /mnt</code> 进行挂载。</li>
</ul>
<p><img src="/images/cobbler/import_image.png" alt="上传镜像"></p>
<p>上传完成后我们可以看到如下内容：</p>
<p><img src="/images/cobbler/distors.png" alt="发行版"></p>
<h2 id="修改Cobbler-web登录密码"><a href="#修改Cobbler-web登录密码" class="headerlink" title="修改Cobbler web登录密码"></a>修改Cobbler web登录密码</h2><p>在终端中执行如下命令，然后输入两次密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># htdigest &#x2F;etc&#x2F;cobbler&#x2F;users.digest &quot;Cobbler&quot; cobbler</span><br><span class="line">Changing password for user cobbler in realm Cobbler</span><br><span class="line">New password: </span><br><span class="line">Re-type new password:</span><br></pre></td></tr></table></figure>

<h2 id="在新主机上安装系统"><a href="#在新主机上安装系统" class="headerlink" title="在新主机上安装系统"></a>在新主机上安装系统</h2><p>网络引导：</p>
<p><img src="/images/cobbler/PXE.png" alt="pxe"><br><img src="/images/cobbler/boot.png" alt="网络引导"></p>
<p>选择你想要安装的发行版本</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Build_a_simple_container_image/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Build_a_simple_container_image/" class="post-title-link" itemprop="url">构建一个简单的容器镜像</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:44:00" itemprop="dateCreated datePublished" datetime="2020-05-11T14:44:00+08:00">2020-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">容器</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>先列出 <a href="https://github.com/renkeju/freerdp" target="_blank" rel="noopener">freerdp</a> 的目录树：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">freerdp</span><br><span class="line">├── docker-compose.build.yml</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── entrypoint.sh</span><br><span class="line">├── freerdp.repo</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>

<ul>
<li>Dockerfile 是构建镜像的文件，当我们在目录 freerdp 中执行<code>docker build -t freerdp:latest .</code>命令后，本地会构建一个名为“freerdp:latest”的镜像。</li>
<li>entrypoint.sh 是在构建镜像的过程中添加到镜像内部的一个 shell 脚本，主要作用为了启动容器是可以将一些自定义的变量在容器内生效。</li>
<li>docker-compose.yml/docker-compose.build.yml 这两个文件可以通过 <code>docker-compose</code> 命令启动容器，docker-compose.build.yml 会在本地构建镜像并启动，docker-compose.yml 则从公共镜像仓库获取镜像后启动。</li>
<li>freerdp.repo 是一个 repo 仓库文件，在构建镜像时，这个文件会添加到 <code>/etc/yum.repos.d</code> 目录下。</li>
</ul>
<h2 id="Dockerfile-的内容"><a href="#Dockerfile-的内容" class="headerlink" title="Dockerfile 的内容"></a>Dockerfile 的内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:6</span><br><span class="line">MAINTAINER Keju Ren &lt;renkeju@gmail.com&gt;</span><br><span class="line">ENV PORT 8888</span><br><span class="line">ENV BINDADDR 127.0.0.1</span><br><span class="line"></span><br><span class="line">ADD freerdp.repo &#x2F;etc&#x2F;yum.repos.d</span><br><span class="line">RUN yum makecache &amp;&amp; \</span><br><span class="line">    yum update -y &amp;&amp; \</span><br><span class="line">    yum -y install wsgate</span><br><span class="line"></span><br><span class="line">ADD entrypoint.sh &#x2F;</span><br><span class="line">RUN chmod +x &#x2F;entrypoint.sh &amp;&amp; \</span><br><span class="line">    ln -s &#x2F;entrypoint.sh &#x2F;usr&#x2F;bin</span><br><span class="line"></span><br><span class="line">EXPOSE $PORT</span><br><span class="line"></span><br><span class="line">CMD entrypoint.sh</span><br></pre></td></tr></table></figure>

<ol>
<li>通过 FROM 这个关键字我们可以从公共镜像仓库中获取一个镜像作为我们的基础镜像。</li>
<li>maintainer 说明一下维护者的联系方式</li>
<li>在 ENV 中定义了两个环境变量。环境变量不一定需要值，在启动镜像时也可以从外部传入值。PORT变量是配置文件中的端口，BINDADDR变量是配置文件中的绑定地址。</li>
<li>ADD 将当前目录下的 <code>freerdp.repo</code> 文件上传到了centos6 基础镜像的 <code>/etc/yum.repos.d</code> 目录下。</li>
<li>RUN 执行了与安装相关的命令</li>
<li>ADD 将 <code>entrypoint.sh</code> 脚本上传到了 centos6 基础镜像的根目录下。</li>
<li>RUN 脚本赋权并且做软链接</li>
<li>将 PORT 变量定义的端口号暴露出来</li>
<li>CMD 定义镜像启动时的执行操作</li>
</ol>
<h2 id="查看容器镜像详细的内容"><a href="#查看容器镜像详细的内容" class="headerlink" title="查看容器镜像详细的内容"></a>查看容器镜像详细的内容</h2><p>容器构建成功后，使用 <code>docker image inspect freerdp:latest</code> 命令查看容器镜像相关的内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">docker image inspect freerdp:latest</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;sha256:0a7b3333fe481578c6a8987e209e6a826ad046fb5099b7202d827033ea69cbf1&quot;,</span><br><span class="line">        &quot;RepoTags&quot;: [</span><br><span class="line">            &quot;freerdp:latest&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;RepoDigests&quot;: [],</span><br><span class="line">        &quot;Parent&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">        &quot;Comment&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2019-11-02T08:13:46.481340443Z&quot;,</span><br><span class="line">        &quot;Container&quot;: &quot;77535bee56c8f980129d3dcbc77367bedd85909ff6257ebb7c04997bf77419ae&quot;,</span><br><span class="line">        &quot;ContainerConfig&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;77535bee56c8&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: false,</span><br><span class="line">            &quot;AttachStdout&quot;: false,</span><br><span class="line">            &quot;AttachStderr&quot;: false,</span><br><span class="line">            &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">                &quot;8888&#x2F;tcp&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Tty&quot;: false,</span><br><span class="line">            &quot;OpenStdin&quot;: false,</span><br><span class="line">            &quot;StdinOnce&quot;: false,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;,</span><br><span class="line">                &quot;PORT&#x3D;8888&quot;,</span><br><span class="line">                &quot;BINDADDR&#x3D;127.0.0.1&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;&#x2F;bin&#x2F;sh&quot;,</span><br><span class="line">                &quot;-c&quot;,</span><br><span class="line">                &quot;#(nop) &quot;,</span><br><span class="line">                &quot;CMD [\&quot;&#x2F;bin&#x2F;sh\&quot; \&quot;-c\&quot; \&quot;entrypoint.sh\&quot;]&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20181006&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DockerVersion&quot;: &quot;19.03.4&quot;,</span><br><span class="line">        &quot;Author&quot;: &quot;Keju Ren &lt;renkeju@gmail.com&gt;&quot;,</span><br><span class="line">        &quot;Config&quot;: &#123;</span><br><span class="line">            &quot;Hostname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">            &quot;User&quot;: &quot;&quot;,</span><br><span class="line">            &quot;AttachStdin&quot;: false,</span><br><span class="line">            &quot;AttachStdout&quot;: false,</span><br><span class="line">            &quot;AttachStderr&quot;: false,</span><br><span class="line">            &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">                &quot;8888&#x2F;tcp&quot;: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Tty&quot;: false,</span><br><span class="line">            &quot;OpenStdin&quot;: false,</span><br><span class="line">            &quot;StdinOnce&quot;: false,</span><br><span class="line">            &quot;Env&quot;: [</span><br><span class="line">                &quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;,</span><br><span class="line">                &quot;PORT&#x3D;8888&quot;,</span><br><span class="line">                &quot;BINDADDR&#x3D;127.0.0.1&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Cmd&quot;: [</span><br><span class="line">                &quot;&#x2F;bin&#x2F;sh&quot;,</span><br><span class="line">                &quot;-c&quot;,</span><br><span class="line">                &quot;entrypoint.sh&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Image&quot;: &quot;sha256:68fa7bdcf45877d81f0f17e3deda0d2172c2edf6b9ea78243ee87bd9599efe2c&quot;,</span><br><span class="line">            &quot;Volumes&quot;: null,</span><br><span class="line">            &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">            &quot;Entrypoint&quot;: null,</span><br><span class="line">            &quot;OnBuild&quot;: null,</span><br><span class="line">            &quot;Labels&quot;: &#123;</span><br><span class="line">                &quot;org.label-schema.build-date&quot;: &quot;20181006&quot;,</span><br><span class="line">                &quot;org.label-schema.license&quot;: &quot;GPLv2&quot;,</span><br><span class="line">                &quot;org.label-schema.name&quot;: &quot;CentOS Base Image&quot;,</span><br><span class="line">                &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,</span><br><span class="line">                &quot;org.label-schema.vendor&quot;: &quot;CentOS&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">        &quot;Os&quot;: &quot;linux&quot;,</span><br><span class="line">        &quot;Size&quot;: 625547394,</span><br><span class="line">        &quot;VirtualSize&quot;: 625547394,</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;ad889e09f7b4cbe8d3234f438c8319877172531f7392377600c8df876d7832dd&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;60dd8a91b33be52d53145fe3aed04834ece10a92166aaf0532d5f66a9d067318&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;077badaf444344118bd8197be3d0b841fdfdc1044aa9a5a483acceddc54627a5&#x2F;diff:&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;17535fa5f72208d996b9b99fc325e4fc5066fb39bf7eebbbed2b202678418486&#x2F;diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;99cb65f76695c76e84cd07ae95f121aa5c5e4a915a9649119084569a924f5f54&#x2F;work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;RootFS&quot;: &#123;</span><br><span class="line">            &quot;Type&quot;: &quot;layers&quot;,</span><br><span class="line">            &quot;Layers&quot;: [</span><br><span class="line">                &quot;sha256:af6bf1987c2eb07d73f33836b0d8fd825d7c785273526b077e46780e8b4b2ae9&quot;,</span><br><span class="line">                &quot;sha256:cc8e5a6b427b31cf82519aac2ca72844444e9df74734d343dd5b81527dc1f258&quot;,</span><br><span class="line">                &quot;sha256:87715d9735cfcae05d246891eee5583492253e37d270a480665fcd0985fa5dc5&quot;,</span><br><span class="line">                &quot;sha256:a7c3fa2ec462a6226c6d43afe2b694ece538acf184dd07f152a882657f8c51d8&quot;,</span><br><span class="line">                &quot;sha256:1456e758e7b477d0d55b8bd82e3711c57d6616181497044a2ca1f05a63f7b927&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Metadata&quot;: &#123;</span><br><span class="line">            &quot;LastTagTime&quot;: &quot;2019-11-02T16:13:46.509755292+08:00&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以看到在打印出的内容中 ENV 与 CMD 与Dockerfile 中定义的 ENV 与 CMD 相同。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Brief_description_of_the_configuration_file/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Brief_description_of_the_configuration_file/" class="post-title-link" itemprop="url">配置文件的简单说明</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在文章 <a href="/2020/05/11/Quickly_build_a_monitoring_system_test_environment/" title="快速构建监控系统测试环境">快速构建监控系统测试环境</a> 中，我们已经启动了一个实验环境，<a href="https://github.com/renkeju/prometheus_lab.git" target="_blank" rel="noopener">prometheus_lab</a> 中的配置文件内容被没有做详细的说明。下面我们来说说测试环境中的配置文件。</p>
<h2 id="Prometheus-scrape-config"><a href="#Prometheus-scrape-config" class="headerlink" title="Prometheus scrape config"></a>Prometheus scrape config</h2><p>这里只着重说明 <code>prometheus/prometheus.yml</code> 文件中与 SNMP 相关的配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/prometheus/file_sd/node.yml</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">snmp</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">30s</span> <span class="comment"># 覆盖全局默认值</span></span><br><span class="line">    <span class="attr">scrape_timeout:</span> <span class="string">5s</span> <span class="comment"># 覆盖全局默认值</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/prometheus/file_sd/snmp.yml</span> <span class="comment"># 指定 snmp 服务发现配置文件路径</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/snmp</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">if_mib</span>   <span class="comment"># 指定默认采集 MIB 模块的名称</span></span><br><span class="line">      <span class="attr">community:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">public</span>  <span class="comment"># 指定团体号，当 snmp_exporter snmp.yml 配置文件没有指定团体号，此处定义的团体号生效。</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">replacement:</span> <span class="string">snmp_exporter:9116</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span>  <span class="comment"># 从目标中获取MIB模块名称</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mib</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__param_module</span></span><br></pre></td></tr></table></figure>

<h2 id="Service-Discovery-Config"><a href="#Service-Discovery-Config" class="headerlink" title="Service Discovery Config"></a>Service Discovery Config</h2><p>snmp 的服务发现配置文件中我们可以额外定义一些参数，方便我们可以对不同目标做更小颗粒度的划分。<br>自动发现配置文件支持 json 格式与 yaml 格式，目标定义了 Prometheus 必须为指标而抓取的端点。<br>比如我在下面的示例中添加了<code>architecture</code>与<code>model</code>等变量，这些变量prometheus获取目标信息是，会作为目标的标签与目标绑定。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">"labels"</span>: &#123;</span><br><span class="line">          <span class="attr">"mib"</span>: <span class="string">"apcups"</span>,</span><br><span class="line">          <span class="attr">"architecture"</span>: <span class="string">"x86_64"</span>,</span><br><span class="line">          <span class="attr">"model"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"targets"</span>: [</span><br><span class="line">          <span class="string">"snmpd"</span></span><br><span class="line">      ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><img src="/images/Brief_description_of_the_configuration_file/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" alt="服务发现中的目标标签"></p>
<h2 id="多个目标"><a href="#多个目标" class="headerlink" title="多个目标"></a>多个目标</h2><p>如果有多个目标，需要在服务发现配置文件中列出多个目标信息，这里我贴出一个简单的 python 脚本，可以生成自动发现配置文件，你也可以根据自己的需求修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">data = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>], <span class="string">"r"</span>) <span class="keyword">as</span> handler:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> handler:</span><br><span class="line">        line = line.strip(<span class="string">'\n'</span>)</span><br><span class="line">        fields = line.split(<span class="string">','</span>)</span><br><span class="line">        labels = &#123;&#125;</span><br><span class="line">        labels[<span class="string">'brand'</span>] = fields[<span class="number">1</span>]</span><br><span class="line">        labels[<span class="string">'model'</span>] = fields[<span class="number">2</span>]</span><br><span class="line">        labels[<span class="string">'hostname'</span>] = fields[<span class="number">3</span>]</span><br><span class="line">        labels[<span class="string">'mib'</span>] = fields[<span class="number">4</span>]</span><br><span class="line">        targets = []</span><br><span class="line">        targets.append(fields[<span class="number">0</span>])</span><br><span class="line">        custom = &#123;&#125;</span><br><span class="line">	custom[<span class="string">'targets'</span>] = targets</span><br><span class="line">        custom[<span class="string">'labels'</span>] = labels</span><br><span class="line">        print(custom)</span><br><span class="line">        data.append(custom)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">2</span>], <span class="string">"w"</span>) <span class="keyword">as</span> json_handler:</span><br><span class="line">    json.dump(data, json_handler, indent=<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>你需要提前编辑一个 csv 文件，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.1,Huawei,S5328C-EI,BJ-LG-HW5328,if_mib</span><br><span class="line">192.168.100.2,Huawei,Quidway S9306,SH-GQ-HW9306CSS,if_mib</span><br><span class="line">192.168.100.3,Huawei,Quidway S9306,BJ-LG-HW9306CSS,if_mib</span><br><span class="line">192.168.100.4,Huawei,Quidway S9306,GZ-RMZ-HW9306CSS,if_mib</span><br></pre></td></tr></table></figure>

<p>第一个逗号前的内容为主机地址，第二个逗号前的内容为设备厂商名称，第三个逗号前的内容设备型号，第四个逗号前的内容为自定义设备名称，最后一段内容为获取mib名称。<br>使用下面的名称执行脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sd_generate.py &lt;your_csv_file_name&gt; &lt;sd_json_file_name&gt;</span><br></pre></td></tr></table></figure>

<p>执行后生成如下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"BJ-LG-HW5328"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"S5328C-EI"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.1"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"SH-GQ-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.2"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"BJ-LG-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.3"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"mib"</span>: <span class="string">"if_mib"</span>,</span><br><span class="line">            <span class="attr">"brand"</span>: <span class="string">"Huawei"</span>,</span><br><span class="line">            <span class="attr">"hostname"</span>: <span class="string">"GZ-RMZ-HW9306CSS"</span>,</span><br><span class="line">            <span class="attr">"model"</span>: <span class="string">"Quidway S9306"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"targets"</span>: [</span><br><span class="line">            <span class="string">"192.168.100.4"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>之后 prometheus 会自动加载刚刚生成的服务发现配置文件，不需要重启 prometheus。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/SNMP_Exporter_config_generate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/SNMP_Exporter_config_generate/" class="post-title-link" itemprop="url">SNMP Exporter 配置生成器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://github.com/prometheus/snmp_exporter/tree/master/generator" target="_blank" rel="noopener">SNMP Exporter generator 项目地址</a></p>
<p>此配置生成器使用 NetSNMP 解析 MIB，并使用它们为 snmp_exporter 生成配置。</p>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>由于对 NetSNMP 的动态依赖，因此您必须自己构建生成器。</p>
<ul>
<li><p>Debian 系发行版</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install unzip build-essential libsnmp-dev # Debian-based distros</span><br></pre></td></tr></table></figure>
</li>
<li><p>Redhat 系发行版</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gcc gcc-g++ make net-snmp net-snmp-utils net-snmp-libs net-snmp-devel # RHEL-based distros</span><br><span class="line">go get github.com&#x2F;prometheus&#x2F;snmp_exporter&#x2F;generator</span><br><span class="line">cd $&#123;GOPATH-$HOME&#x2F;go&#125;&#x2F;src&#x2F;github.com&#x2F;prometheus&#x2F;snmp_exporter&#x2F;generator</span><br><span class="line">go build</span><br><span class="line">make mibs</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export MIBDIRS&#x3D;mibs</span><br><span class="line">.&#x2F;generator generate</span><br></pre></td></tr></table></figure>

<p>生成器从 <code>generator.yml</code> 读取并写入 <code>snmp.yml</code>。<br>其他命令可用于调试，请使用 <code>help</code> 命令查看它们。</p>
<h2 id="使用-Docker"><a href="#使用-Docker" class="headerlink" title="使用 Docker"></a>使用 Docker</h2><p>如果要在 docker 中运行生成器以生成 <code>snmp.yml</code> 配置，请运行以下命令。<br>Docker 镜像需要一个包含 <code>generator.yml</code> 的目录和一个名为 mibs 的目录，其中包含您要使用的所有 MIB。<br>此示例将生成示例 <code>snmp.yml</code>，该示例包含在 <code>snmp_exporter</code> 存储库的顶级中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">make</span> <span class="string">mibs</span></span><br><span class="line"><span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">snmp-generator</span> <span class="string">.</span></span><br><span class="line"><span class="string">docker</span> <span class="string">run</span> <span class="string">-ti</span> <span class="string">\</span></span><br><span class="line">  <span class="string">-v</span> <span class="string">"$&#123;PWD&#125;:/opt/"</span> <span class="string">\</span></span><br><span class="line">  <span class="string">snmp-generator</span> <span class="string">generate</span></span><br></pre></td></tr></table></figure>

<h2 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h2><p><code>generator.yml</code> 提供模块列表。最简单的模块只是一个名称和一组要遍历的 OID。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">module_name:</span>  <span class="comment"># The module name. You can have as many modules as you want.</span></span><br><span class="line">    <span class="attr">walk:</span>       <span class="comment"># List of OIDs to walk. Can also be SNMP object names or specific instances.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.2</span>              <span class="comment"># Same as "interfaces"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sysUpTime</span>                  <span class="comment"># Same as "1.3.6.1.2.1.1.3"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.31</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.6</span><span class="number">.40</span>  <span class="comment"># Instance of "ifHCInOctets" with index "40"</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span>  <span class="comment"># SNMP version to use. Defaults to 2.</span></span><br><span class="line">                <span class="comment"># 1 will use GETNEXT, 2 and 3 use GETBULK.</span></span><br><span class="line">    <span class="attr">max_repetitions:</span> <span class="number">25</span>  <span class="comment"># How many objects to request with GET/GETBULK, defaults to 25.</span></span><br><span class="line">                         <span class="comment"># May need to be reduced for buggy devices.</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">3</span>   <span class="comment"># How many times to retry a failed request, defaults to 3.</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span> <span class="comment"># Timeout for each walk, defaults to 10s.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">auth:</span></span><br><span class="line">      <span class="comment"># Community string is used with SNMP v1 and v2. Defaults to "public".</span></span><br><span class="line">      <span class="attr">community:</span> <span class="string">public</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># v3 has different and more complex settings.</span></span><br><span class="line">      <span class="comment"># Which are required depends on the security_level.</span></span><br><span class="line">      <span class="comment"># The equivalent options on NetSNMP commands like snmpbulkwalk</span></span><br><span class="line">      <span class="comment"># and snmpget are also listed. See snmpcmd(1).</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">user</span>  <span class="comment"># Required, no default. -u option to NetSNMP.</span></span><br><span class="line">      <span class="attr">security_level:</span> <span class="string">noAuthNoPriv</span>  <span class="comment"># Defaults to noAuthNoPriv. -l option to NetSNMP.</span></span><br><span class="line">                                    <span class="comment"># Can be noAuthNoPriv, authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">pass</span>  <span class="comment"># Has no default. Also known as authKey, -A option to NetSNMP.</span></span><br><span class="line">                      <span class="comment"># Required if security_level is authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">auth_protocol:</span> <span class="string">MD5</span>  <span class="comment"># MD5 or SHA, defaults to MD5. -a option to NetSNMP.</span></span><br><span class="line">                          <span class="comment"># Used if security_level is authNoPriv or authPriv.</span></span><br><span class="line">      <span class="attr">priv_protocol:</span> <span class="string">DES</span>  <span class="comment"># DES or AES, defaults to DES. -x option to NetSNMP.</span></span><br><span class="line">                          <span class="comment"># Used if security_level is authPriv.</span></span><br><span class="line">      <span class="attr">priv_password:</span> <span class="string">otherPass</span> <span class="comment"># Has no default. Also known as privKey, -X option to NetSNMP.</span></span><br><span class="line">                               <span class="comment"># Required if security_level is authPriv.</span></span><br><span class="line">      <span class="attr">context_name:</span> <span class="string">context</span> <span class="comment"># Has no default. -n option to NetSNMP.</span></span><br><span class="line">                            <span class="comment"># Required if context is configured on the device.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">lookups:</span>  <span class="comment"># Optional list of lookups to perform.</span></span><br><span class="line">              <span class="comment"># The default for `keep_source_indexes` is false. Indexes must be unique for this option to be used.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># If the index of a table is bsnDot11EssIndex, usually that'd be the label</span></span><br><span class="line">      <span class="comment"># on the resulting metrics from that table. Instead, use the index to</span></span><br><span class="line">      <span class="comment"># lookup the bsnDot11EssSsid table entry and create a bsnDot11EssSsid label</span></span><br><span class="line">      <span class="comment"># with that value.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_indexes:</span> <span class="string">[bsnDot11EssIndex]</span></span><br><span class="line">        <span class="attr">lookup:</span> <span class="string">bsnDot11EssSsid</span></span><br><span class="line">        <span class="attr">drop_source_indexes:</span> <span class="literal">false</span>  <span class="comment"># If true, delete source index labels for this lookup.</span></span><br><span class="line">                                    <span class="comment"># This avoids label clutter when the new index is unique.</span></span><br><span class="line"></span><br><span class="line">     <span class="attr">overrides:</span> <span class="comment"># Allows for per-module overrides of bits of MIBs</span></span><br><span class="line">       <span class="attr">metricName:</span></span><br><span class="line">         <span class="attr">ignore:</span> <span class="literal">true</span> <span class="comment"># Drops the metric from the output.</span></span><br><span class="line">         <span class="attr">regex_extracts:</span></span><br><span class="line">           <span class="attr">Temp:</span> <span class="comment"># A new metric will be created appending this to the metricName to become metricNameTemp.</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'(.*)'</span> <span class="comment"># Regex to extract a value from the returned SNMP walks's value.</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'$1'</span> <span class="comment"># The result will be parsed as a float64, defaults to $1.</span></span><br><span class="line">           <span class="attr">Status:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'.*Example'</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'1'</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">regex:</span> <span class="string">'.*'</span></span><br><span class="line">               <span class="attr">value:</span> <span class="string">'0'</span></span><br><span class="line">         <span class="attr">type:</span> <span class="string">DisplayString</span> <span class="comment"># Override the metric type, possible types are:</span></span><br><span class="line">                             <span class="comment">#   gauge:   An integer with type gauge.</span></span><br><span class="line">                             <span class="comment">#   counter: An integer with type counter.</span></span><br><span class="line">                             <span class="comment">#   OctetString: A bit string, rendered as 0xff34.</span></span><br><span class="line">                             <span class="comment">#   DateAndTime: An RFC 2579 DateAndTime byte sequence. If the device has no time zone data, UTC is used.</span></span><br><span class="line">                             <span class="comment">#   DisplayString: An ASCII or UTF-8 string.</span></span><br><span class="line">                             <span class="comment">#   PhysAddress48: A 48 bit MAC address, rendered as 00:01:02:03:04:ff.</span></span><br><span class="line">                             <span class="comment">#   Float: A 32 bit floating-point value with type gauge.</span></span><br><span class="line">                             <span class="comment">#   Double: A 64 bit floating-point value with type gauge.</span></span><br><span class="line">                             <span class="comment">#   InetAddressIPv4: An IPv4 address, rendered as 1.2.3.4.</span></span><br><span class="line">                             <span class="comment">#   InetAddressIPv6: An IPv6 address, rendered as 0102:0304:0506:0708:090A:0B0C:0D0E:0F10.</span></span><br><span class="line">                             <span class="comment">#   InetAddress: An InetAddress per RFC 4001. Must be preceded by an InetAddressType.</span></span><br><span class="line">                             <span class="comment">#   InetAddressMissingSize: An InetAddress that violates section 4.1 of RFC 4001 by</span></span><br><span class="line">                             <span class="comment">#       not having the size in the index. Must be preceded by an InetAddressType.</span></span><br><span class="line">                             <span class="comment">#   EnumAsInfo: An enum for which a single timeseries is created. Good for constant values.</span></span><br><span class="line">                             <span class="comment">#   EnumAsStateSet: An enum with a time series per state. Good for variable low-cardinality enums.</span></span><br></pre></td></tr></table></figure>

<h2 id="EnumAsInfo-和-EnumAsStateSet"><a href="#EnumAsInfo-和-EnumAsStateSet" class="headerlink" title="EnumAsInfo 和 EnumAsStateSet"></a>EnumAsInfo 和 EnumAsStateSet</h2><p>SNMP 包含整数索引枚举的概念。 在 Prometheus 中有两种表示这些字符串的方法。 它们可以是“信息”指标，也可以是“状态集”。 SNMP 没有指定应使用的内容，这取决于数据的使用情况。 一些用户可能更喜欢原始整数值，而不是字符串。<br>为了将枚举整数设置为字符串映射，必须使用两个替代之一。<br><code>EnumAsInfo</code>应该用于提供类库存数据的属性。 例如设备类型，颜色名称等。此值恒定是很重要的。<br><code>EnumAsStateSet</code>应该用于表示状态或您可能要发出警报的事物。 例如，链接状态是打开还是关闭，处于错误状态，面板是打开还是关闭等。请注意不要将其用于高基数值，因为它将为每个可能的值生成1个时间序列。</p>
<h2 id="从哪里获得-MIB"><a href="#从哪里获得-MIB" class="headerlink" title="从哪里获得 MIB"></a>从哪里获得 MIB</h2><p>其中一些相当缓慢，建议使用 wget下载。<br>将提取的 mib 放在 NetSNMP 可以读取的位置。 <code>$HOME/.snmp/mibs</code> 是一种选择。</p>
<ul>
<li>Cisco: <a href="ftp://ftp.cisco.com/pub/mibs/v2/v2.tar.gz">ftp://ftp.cisco.com/pub/mibs/v2/v2.tar.gz</a></li>
<li>APC: <a href="https://download.schneider-electric.com/files?p_File_Name=powernet426.mib" target="_blank" rel="noopener">https://download.schneider-electric.com/files?p_File_Name=powernet426.mib</a></li>
<li>Servertech: <a href="ftp://ftp.servertech.com/Pub/SNMP/sentry3/Sentry3.mib">ftp://ftp.servertech.com/Pub/SNMP/sentry3/Sentry3.mib</a></li>
<li>Palo Alto PanOS 7.0 enterprise MIBs: <a href="https://www.paloaltonetworks.com/content/dam/pan/en_US/assets/zip/technical-documentation/snmp-mib-modules/PAN-MIB-MODULES-7.0.zip" target="_blank" rel="noopener">https://www.paloaltonetworks.com/content/dam/pan/en_US/assets/zip/technical-documentation/snmp-mib-modules/PAN-MIB-MODULES-7.0.zip</a></li>
<li>Arista Networks:<br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-ENTITY-SENSOR-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-ENTITY-SENSOR-MIB.txt</a><br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-SW-IP-FORWARDING-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-SW-IP-FORWARDING-MIB.txt</a><br><a href="https://www.arista.com/assets/data/docs/MIBS/ARISTA-SMI-MIB.txt" target="_blank" rel="noopener">https://www.arista.com/assets/data/docs/MIBS/ARISTA-SMI-MIB.txt</a></li>
<li>Synology: <a href="https://global.download.synology.com/download/Document/MIBGuide/Synology_MIB_File.zip" target="_blank" rel="noopener">https://global.download.synology.com/download/Document/MIBGuide/Synology_MIB_File.zip</a></li>
<li>MikroTik: <a href="http://download2.mikrotik.com/Mikrotik.mib" target="_blank" rel="noopener">http://download2.mikrotik.com/Mikrotik.mib</a></li>
<li>UCD-SNMP-MIB (Net-SNMP): <a href="http://www.net-snmp.org/docs/mibs/UCD-SNMP-MIB.txt" target="_blank" rel="noopener">http://www.net-snmp.org/docs/mibs/UCD-SNMP-MIB.txt</a></li>
<li>Ubiquiti Networks:<br><a href="http://dl.ubnt-ut.com/snmp/UBNT-MIB" target="_blank" rel="noopener">http://dl.ubnt-ut.com/snmp/UBNT-MIB</a><br><a href="http://dl.ubnt-ut.com/snmp/UBNT-UniFi-MIB" target="_blank" rel="noopener">http://dl.ubnt-ut.com/snmp/UBNT-UniFi-MIB</a><br><a href="https://dl.ubnt.com/firmwares/airos-ubnt-mib/ubnt-mib.zip" target="_blank" rel="noopener">https://dl.ubnt.com/firmwares/airos-ubnt-mib/ubnt-mib.zip</a></li>
</ul>
<p><a href="https://github.com/librenms/librenms/tree/master/mibs" target="_blank" rel="noopener">https://github.com/librenms/librenms/tree/master/mibs</a> can also be a good source of MIBs.<br><a href="http://oidref.com" target="_blank" rel="noopener">http://oidref.com</a> is recommended for browsing MIBs.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Quickly_build_a_monitoring_system_test_environment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Quickly_build_a_monitoring_system_test_environment/" class="post-title-link" itemprop="url">快速构建监控系统测试环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>在测试环境中建议使用 Docker 进行部署。在后面的生产环境部署中我也会提供 Ansible 安装方式。<br><a href="https://download.daocloud.io/Docker_Mirror/Docker" target="_blank" rel="noopener">Docker 安装方式</a><br><a href="https://download.daocloud.io/Docker_Mirror/Docker_Compose" target="_blank" rel="noopener">Docker Compose 安装方式</a><br><a href="https://www.daocloud.io/mirror" target="_blank" rel="noopener">Docker 加速器</a></p>
<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p><a href="https://github.com/renkeju/prometheus_lab" target="_blank" rel="noopener">prometheus 实验环境 Docker Compose 编排文件项目地址</a></p>
<ul>
<li>启动<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/renkeju/prometheus_lab.git</span><br><span class="line"><span class="built_in">cd</span> prometheus_lab</span><br><span class="line">docker-compose push</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li>
<li>停止<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br></pre></td></tr></table></figure></li>
<li>删除<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose rm -f</span><br><span class="line">docker volume prune <span class="comment"># 注意：执行此命令之后所存储的历史数据都会被删除</span></span><br></pre></td></tr></table></figure></li>
<li>查看日志<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs</span><br></pre></td></tr></table></figure>
<h2 id="启动后检查"><a href="#启动后检查" class="headerlink" title="启动后检查"></a>启动后检查</h2>在 docker compose 文件中暴露了三个端口号，分别是：</li>
</ul>
<table>
<thead>
<tr>
<th align="center">端口号</th>
<th align="center">容器内端口号</th>
<th align="center">服务</th>
<th align="center">用户认证</th>
</tr>
</thead>
<tbody><tr>
<td align="center">3000</td>
<td align="center">3000</td>
<td align="center">grafana</td>
<td align="center">有</td>
</tr>
<tr>
<td align="center">9090</td>
<td align="center">9090</td>
<td align="center">prometheus</td>
<td align="center">无</td>
</tr>
<tr>
<td align="center">9116</td>
<td align="center">9116</td>
<td align="center">snmp_exporter</td>
<td align="center">无</td>
</tr>
</tbody></table>
<p>其他容器内启动的服务端口号没有必要暴露出来，使用 <code>links</code> 作为链接，可以提高安全性。如果需要为其他服务端口访问添加访问认证，可以配置 Nginx 使用，在后面我们会提到。</p>
<ul>
<li><p>Grafana</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:3000</code> 访问 Grafana，默认用户名：<code>admin</code>，密码则是 docker-composer 文件中变量 <code>GF_SECURITY_ADMIN_PASSWORD</code> 的值。</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/grafana.png" alt="第一次登录 Grafana"></p>
</li>
<li><p>prometheus</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:9090</code> 访问 prometheus</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.png" alt="prometheus 服务发现"></p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E7%9B%AE%E6%A0%87.png" alt="prometheus 目标"></p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/%E5%91%8A%E8%AD%A6.png" alt="prometheus 报警"></p>
</li>
<li><p>snmp_exporter</p>
<p>  在浏览器中输入 <code>http://&lt;your_ip_address&gt;:9116</code> 访问 snmp_exporter，snmp_exporter web 提供的信息并不多，你可以查看 <code>snmp.yml</code> 配置文件的内容，也可以对 snmpd 服务进行测试。</p>
<p>  <img src="/images/Quickly_build_a_monitoring_system_test_environment/SNMP_exporter.png" alt="snmp_exporter"></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/Prometheus_SNMP_Exporter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/Prometheus_SNMP_Exporter/" class="post-title-link" itemprop="url">Prometheus SNMP Exporter</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://github.com/prometheus/snmp_exporter" target="_blank" rel="noopener">Prometheus SNMP Exporter 项目地址</a></p>
<p>SNMP Exporter 从 SNMP 服务中采集信息提供给 Promethers 监控系统使用。<br>有两个部分，执行提供数据的 exporter，以使用的 <a href="https://github.com/prometheus/snmp_exporter/blob/master/generator" target="_blank" rel="noopener">generator</a> （取决于netsnmp）生成配置为 exporter 提供配置。</p>
<h2 id="Exporter-配置"><a href="#Exporter-配置" class="headerlink" title="Exporter 配置"></a>Exporter 配置</h2><p>默认情况下，snmp exporter 从 snmp.yml 文件中读取配置。此文件不是手动编写的，而是使用 <a href="https://github.com/prometheus/snmp_exporter/blob/master/generator" target="_blank" rel="noopener">generator</a> 生成它。<br>默认配置的 snmp.yml 配置文件中包含各种公共硬件，对于这些硬件，mib对常见设备通用，使用 snmp v2 GETBULK 可以遍历它们。<br>除了最简单的设置外，您还需要使用生成器。需要定制哪些对象是遍历的，使用非公开 MIB 或指定认证参数。</p>
<h2 id="Prometheus-配置"><a href="#Prometheus-配置" class="headerlink" title="Prometheus 配置"></a>Prometheus 配置</h2><p>SNMP Exporter 需要将地址作为参数传递，这可以通过重新标记来完成。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'snmp'</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span>  <span class="comment"># SNMP 设备</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/snmp</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span> <span class="string">[if_mib]</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9116</span>  <span class="comment"># SNMP exporter's 真正地址，格式为 hostname:port。</span></span><br></pre></td></tr></table></figure>

<p>这种配置允许 Prometheus 提供调度和服务自动发现，这与不能在我们要从其获取指标的机器上运行 Exporter 的所有其他 Exporter 有所不同。</p>
<h2 id="处理大计数器值"><a href="#处理大计数器值" class="headerlink" title="处理大计数器值"></a>处理大计数器值</h2><p>为 Counter64 较大的值提供准确的计数器，exporter 将为每 2^53 值自动包装，以避免 64 位浮点舍入。<br>要禁用此功能，请使用命令行参数 <code>--no-snmp.wrap-large-counters</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/private_airport/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/private_airport/" class="post-title-link" itemprop="url">个人小机场</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GFW/" itemprop="url" rel="index"><span itemprop="name">GFW</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这篇笔记主要对 <a href="https://github.com/shadowsocks/shadowsocks-manager" target="_blank" rel="noopener">shadowsocks manager</a> 做一些补充，更详细的内容请查看 <a href="https://shadowsocks.github.io/shadowsocks-manager/#/home" target="_blank" rel="noopener">Shadowsocks manager 官方文档</a>。</p>
<h2 id="shadowsocks-manager"><a href="#shadowsocks-manager" class="headerlink" title="shadowsocks manager"></a>shadowsocks manager</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sL https:&#x2F;&#x2F;deb.nodesource.com&#x2F;setup_10.x | bash -</span><br><span class="line">apt-get -y install nodejs</span><br></pre></td></tr></table></figure>

<h3 id="安装-ssmgr"><a href="#安装-ssmgr" class="headerlink" title="安装 ssmgr"></a>安装 ssmgr</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g shadowsocks-manager --unsafe-perm</span><br></pre></td></tr></table></figure>

<h3 id="配置-systemd"><a href="#配置-systemd" class="headerlink" title="配置 systemd"></a>配置 systemd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;ssmgr-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Shadowsocks Node Service Master 2</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">User&#x3D;root</span><br><span class="line">LimitNOFILE&#x3D;32768</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;ssmgr -c &#x2F;etc&#x2F;ssmgr&#x2F;manager.yml </span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<h3 id="配置-ssmgr"><a href="#配置-ssmgr" class="headerlink" title="配置 ssmgr"></a>配置 ssmgr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /etc/ssmgr</span></span><br><span class="line"><span class="comment"># cat &lt;&lt; EOF &gt; /etc/ssmgr/manager.yml</span></span><br><span class="line"><span class="built_in">type</span>: m</span><br><span class="line">manager:</span><br><span class="line">  address: 172.22.217.6:6789</span><br><span class="line">  password: <span class="string">'password'</span></span><br><span class="line">plugins:</span><br><span class="line">  flowSaver:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">  user:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">  account:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">  email:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">    <span class="built_in">type</span>: <span class="string">'smtp'</span></span><br><span class="line">    username: <span class="string">'17003905536@163.com'</span></span><br><span class="line">    password: <span class="string">'password'</span></span><br><span class="line">    host: <span class="string">'smtp.163.com'</span></span><br><span class="line">  webgui:</span><br><span class="line">    use: <span class="literal">true</span></span><br><span class="line">    host: <span class="string">'127.0.0.1'</span></span><br><span class="line">    port: <span class="string">'8080'</span></span><br><span class="line">    <span class="comment"># site: 'http://yourwebsite.com'</span></span><br><span class="line">    <span class="comment"># icon: 'icon.png'</span></span><br><span class="line">    <span class="comment"># skin: 'default'</span></span><br><span class="line">    <span class="comment"># googleAnalytics: 'UA-xxxxxxxx-x'</span></span><br><span class="line">    <span class="comment"># gcmSenderId: '476902381496'</span></span><br><span class="line">    <span class="comment"># gcmAPIKey: 'AAAAGzddLRc:XXXXXXXXXXXXXX'</span></span><br><span class="line">db:</span><br><span class="line">  host: <span class="string">'localhost'</span></span><br><span class="line">  port: 3306</span><br><span class="line">  user: <span class="string">'renkeju'</span></span><br><span class="line">  password: <span class="string">'password'</span></span><br><span class="line">  database: <span class="string">'ssmgr'</span></span><br><span class="line"><span class="comment"># 从 0.30 开始需要配置 redis</span></span><br><span class="line">redis:</span><br><span class="line">  host: <span class="string">'localhost'</span></span><br><span class="line">  port: 6379</span><br><span class="line">  password: <span class="string">'password'</span></span><br><span class="line">  db: 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get -y install mysql-server</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>

<h3 id="安全设置"><a href="#安全设置" class="headerlink" title="安全设置"></a>安全设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>

<h3 id="修改数据库配置"><a href="#修改数据库配置" class="headerlink" title="修改数据库配置"></a>修改数据库配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/mysql/conf.d/mysql.cnf</span><br><span class="line">[client]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">collation-server = utf8_unicode_ci</span><br><span class="line">init-connect=<span class="string">'SET NAMES utf8'</span></span><br><span class="line">character-set-server = utf8</span><br><span class="line"><span class="built_in">bind</span>-address=127.0.0.1</span><br></pre></td></tr></table></figure>

<h3 id="重启数据库"><a href="#重启数据库" class="headerlink" title="重启数据库"></a>重启数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set @@global.sql_mode &#x3D;&#39;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#39;;</span><br><span class="line">create database ssmgr;</span><br><span class="line">grant all privileges on ssmgr.* to ssmgr@localhost identified by &#39;Password&#39;;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt -y install nginx</span><br></pre></td></tr></table></figure>

<h3 id="配置-http"><a href="#配置-http" class="headerlink" title="配置 http"></a>配置 http</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rm -rf &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;default</span><br><span class="line">cat &lt;&lt; &quot;EOF&quot; &gt; &#x2F;etc&#x2F;nginx&#x2F;sites-available&#x2F;ssmgr</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  wg.renkeju.com;</span><br><span class="line">    # return       301 https:&#x2F;&#x2F;$server_name$request_uri;</span><br><span class="line">    </span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">        proxy_set_header   Host             $http_host;</span><br><span class="line">        proxy_set_header   X-Frame-Options  DENY;</span><br><span class="line">        proxy_pass         http:&#x2F;&#x2F;127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 &#x2F;404.html;</span><br><span class="line">        location &#x3D; &#x2F;40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">ln -s &#x2F;etc&#x2F;nginx&#x2F;sites-&#123;available,enabled&#125;&#x2F;ssmgr</span><br></pre></td></tr></table></figure>

<h3 id="安装-certbot"><a href="#安装-certbot" class="headerlink" title="安装 certbot"></a>安装 certbot</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install software-properties-common</span><br><span class="line">$ sudo add-apt-repository universe</span><br><span class="line">$ sudo add-apt-repository ppa:certbot&#x2F;certbot</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get -y install certbot python-certbot-nginx</span><br></pre></td></tr></table></figure>

<h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo certbot --nginx</span><br></pre></td></tr></table></figure>

<h3 id="配置-https"><a href="#配置-https" class="headerlink" title="配置 https"></a>配置 https</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; &quot;EOF&quot; &gt; &#x2F;etc&#x2F;nginx&#x2F;sites-available&#x2F;ssmgr_ssl</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  wg.renkeju.com;</span><br><span class="line">    ssl_certificate &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;wg.renkeju.com&#x2F;fullchain.pem; # managed by Certbot</span><br><span class="line">    ssl_certificate_key &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;wg.renkeju.com&#x2F;privkey.pem; # managed by Certbot</span><br><span class="line">    include &#x2F;etc&#x2F;letsencrypt&#x2F;options-ssl-nginx.conf; # managed by Certbot</span><br><span class="line">    ssl_dhparam &#x2F;etc&#x2F;letsencrypt&#x2F;ssl-dhparams.pem; # managed by Certbot</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">        proxy_set_header   Host             $http_host;</span><br><span class="line">        proxy_set_header   X-Frame-Options  DENY;</span><br><span class="line">        proxy_pass         http:&#x2F;&#x2F;127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 &#x2F;404.html;</span><br><span class="line">        location &#x3D; &#x2F;40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">ln -s &#x2F;etc&#x2F;nginx&#x2F;sites-&#123;available,enabled&#125;&#x2F;ssmgr_ssl</span><br></pre></td></tr></table></figure>

<h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now nginx</span><br></pre></td></tr></table></figure>

<h2 id="Shadowsocks"><a href="#Shadowsocks" class="headerlink" title="Shadowsocks"></a>Shadowsocks</h2><h3 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt -y install shadowsocks-libev</span><br></pre></td></tr></table></figure>

<h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; &#x2F;etc&#x2F;ssmgr&#x2F;server.yml</span><br><span class="line">type: s</span><br><span class="line">shadowsocks:</span><br><span class="line">  address: 127.0.0.1:6001</span><br><span class="line">manager:</span><br><span class="line">  address: 0.0.0.0:4002</span><br><span class="line">  password: &#39;password&#39;</span><br><span class="line">db: &#39;db.sqlite&#39;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="ssmgr-server-systemd"><a href="#ssmgr-server-systemd" class="headerlink" title="ssmgr-server systemd"></a>ssmgr-server systemd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;lib&#x2F;systemd&#x2F;system&#x2F;ssmgr-server.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Shadowsocks Manager Server mode Service</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">User&#x3D;root</span><br><span class="line">LimitNOFILE&#x3D;32768</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;ssmgr -c &#x2F;etc&#x2F;ssmgr&#x2F;server.yml -r libev:aes-256-cfb</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl --now enable ssmgr-server</span><br></pre></td></tr></table></figure>

<h2 id="wireguard"><a href="#wireguard" class="headerlink" title="wireguard"></a>wireguard</h2><h3 id="安装-tables-addons"><a href="#安装-tables-addons" class="headerlink" title="安装 tables-addons"></a>安装 tables-addons</h3><p>安装 iptables geoip 模块依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install iptables-dev xtables-addons-common libtext-csv-xs-perl pkg-config libnet-cidr-lite-perl</span><br></pre></td></tr></table></figure>

<p>下载并编译 xtables-addons（所需 kernel 版本 4.15）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;downloads.sourceforge.net&#x2F;project&#x2F;xtables-addons&#x2F;Xtables-addons&#x2F;xtables-addons-3.3.tar.xz</span><br><span class="line">tar xf xtables-addons-3.3.tar.xz</span><br><span class="line">cd xtables-addons-3.3</span><br><span class="line">.&#x2F;configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">cd geoip</span><br><span class="line">make install</span><br><span class="line">mkdir -p &#x2F;usr&#x2F;share&#x2F;xt_geoip</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;libexec&#x2F;xtables-addons</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;libexec&#x2F;xtables-addons&#x2F;xt_geoip_dl</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;libexec&#x2F;xtables-addons&#x2F;xt_geoip_build -D &#x2F;usr&#x2F;share&#x2F;xt_geoip -S &#x2F;usr&#x2F;share&#x2F;xt_geoip&#x2F;GeoLite2-Country-CSV_$(date &#39;+%Y%m%d&#39;)</span><br></pre></td></tr></table></figure>

<h3 id="开启转发"><a href="#开启转发" class="headerlink" title="开启转发"></a>开启转发</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">net.ipv4.ip_forward&#x3D;1</span><br><span class="line">sysctl -p</span><br><span class="line">echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward</span><br></pre></td></tr></table></figure>

<h3 id="开启松散的源地址校验"><a href="#开启松散的源地址校验" class="headerlink" title="开启松散的源地址校验"></a>开启松散的源地址校验</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 2 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;conf&#x2F;ens3&#x2F;rp_filter</span><br><span class="line">echo &quot;net.ipv4.conf.ens3.rp_filter&#x3D;2&quot; &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="安装-4"><a href="#安装-4" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo add-apt-repository ppa:wireguard/wireguard</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install wireguard</span><br></pre></td></tr></table></figure>

<h3 id="生成服务端密钥对"><a href="#生成服务端密钥对" class="headerlink" title="生成服务端密钥对"></a>生成服务端密钥对</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;wireguard&#x2F;</span><br><span class="line">wg genkey | tee privatekey | wg pubkey &gt; publickey</span><br></pre></td></tr></table></figure>

<h3 id="生成环境变量"><a href="#生成环境变量" class="headerlink" title="生成环境变量"></a>生成环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export SERVER_IP_ADDRESS&#x3D;$(curl icanhazip.com)</span><br><span class="line">export SPRIVATE&#x3D;$(cat privatekey)</span><br><span class="line">export SPUBLIC&#x3D;$(cat publickey)</span><br></pre></td></tr></table></figure>

<h3 id="增加配置文件"><a href="#增加配置文件" class="headerlink" title="增加配置文件"></a>增加配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/wireguard/</span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/wireguard/wg0.conf</span><br><span class="line">[Interface]</span><br><span class="line">Address = 10.100.0.1/16</span><br><span class="line">ListenPort = 49999</span><br><span class="line">PostUp   = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE; iptables -t nat -A POSTROUTING -o ens7 -j MASQUERADE; iptables -t mangle -A PREROUTING -i wg0 -m geoip --destination-country CN -j MARK --<span class="built_in">set</span>-mark 2</span><br><span class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE; iptables -t nat -D POSTROUTING -o ens7 -j MASQUERADE; iptables -t mangle -D PREROUTING -i wg0 -m geoip --destination-country CN -j MARK --<span class="built_in">set</span>-mark 2</span><br><span class="line">PrivateKey = <span class="variable">$SPRIVATE</span></span><br><span class="line">MTU = 1420</span><br><span class="line">DNS = 1.1.1.1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="开机启动-1"><a href="#开机启动-1" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl --now disable ufw</span><br><span class="line"># systemctl --now enable wg-quick@wg0</span><br></pre></td></tr></table></figure>

<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># wg show</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: xE1SNRHKGDppk0+b7fdmy2+YydXm6kzx6iOkiP5uc1U&#x3D;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 50000</span><br></pre></td></tr></table></figure>

<h3 id="shadowsocks-manager-wireguard"><a href="#shadowsocks-manager-wireguard" class="headerlink" title="shadowsocks-manager-wireguard"></a>shadowsocks-manager-wireguard</h3><p>安装 nodejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sL https:&#x2F;&#x2F;deb.nodesource.com&#x2F;setup_8.x | bash -</span><br><span class="line">apt-get install nodejs</span><br></pre></td></tr></table></figure>

<p>获取项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;gyteng&#x2F;shadowsocks-manager-wireguard.git</span><br></pre></td></tr></table></figure>

<p>添加 systemd 环境配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; EOF &gt; &#x2F;opt&#x2F;shadowsocks-manager-wireguard&#x2F;env</span><br><span class="line">GATEWAY&#x3D;10.100.0.1</span><br><span class="line">MANAGER_IP_ADDRESS&#x3D;0.0.0.0</span><br><span class="line">MANAGER_PORT&#x3D;6002</span><br><span class="line">PASSWORD&#x3D;password</span><br><span class="line">INTERFACE&#x3D;wg0</span><br><span class="line">DATABASE_FILE_PATH&#x3D;&#x2F;opt&#x2F;shadowsocks-manager-wireguard&#x2F;data.json</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>编辑 systemd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># cat &lt;&lt; &quot;EOF&quot; &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;ssmgr-wireguard.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Shadowsocks Manager Wireguard</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;&#x2F;opt&#x2F;shadowsocks-manager-wireguard&#x2F;env</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">User&#x3D;root</span><br><span class="line">LimitNOFILE&#x3D;32768</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;opt&#x2F;shadowsocks-manager-wireguard</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;node index \</span><br><span class="line">--gateway $&#123;GATEWAY&#125; \</span><br><span class="line">--manager $&#123;MANAGER_IP_ADDRESS&#125;:$&#123;MANAGER_PORT&#125; \</span><br><span class="line">--password $&#123;PASSWORD&#125; \</span><br><span class="line">--interface $&#123;INTERFACE&#125; \</span><br><span class="line">--db $&#123;DATABASE_FILE_PATH&#125;</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl --now enable ssmgr-wireguard</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/network_device_monitor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/network_device_monitor/" class="post-title-link" itemprop="url">网络设备监控系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在监控系统中的实践中发现，现在开源软件中针对网络设备的监控系统使用比较广泛的有 cacti 和 zabbix。其中cacti 的功能比较单一，主要针对网络设备。而 zabbix 监控可以覆盖到设备层、系统层、中间件层等。但是这两款监控系统都存在因为架构设计造成的一些短板。比如 cacti 高可用性比较差，zabbix 对一些协议的采集过于复杂，配置繁琐等。</p>
<h2 id="cacti"><a href="#cacti" class="headerlink" title="cacti"></a>cacti</h2><p>cacti 使用的 RDD tool 时序数据库提供数据存储，但是RDD tool 并不能作为分布式，数据只能存放在单一节点上。所以我们只能对一台主机进行纵向扩展来提高数据的存储量与查询性能。<br>所以现在 cacti 只对公司的网络设备进行流量采集作为与客户结算费用使用，并不对设备性能与流量进行报警。<br>常见计费方式多为 95 计费：</p>
<p><img src="/images/network_device_monitor/95th_zh-CN.png" alt="95计费计算方式"></p>
<h2 id="zabbix"><a href="#zabbix" class="headerlink" title="zabbix"></a>zabbix</h2><p>zabbix 提供了丰富的模版，并且 SNMP 协议也可以使用自动发现机制对网络设备进行监控，从效率上大大提高了网络设备指标的采集。zabbix 对分布式有非常好的支持，zabbix proxy 可以让我们在不同的网域进行数据采集，最终在汇集到 zabbix-server 中。zabbix 的数据存储使用的是 mysql 或 DB2，从扩展性上也是非常强大的。但是mysql 属于关系型数据库，并非时序数据库，所以在针对线性时间数据存储的方面，需要运维人员对数据库的维护格外小心，因为数据表与表之间的耦合性非常高。</p>
<p>所在zabbix监控与 cacti 监控并存，主要作用为报警，对数据的存储时间周期要求并不高。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>我曾考虑替换 zabbix 后端存储数据库，因为在 zabbix 4.0+ 版本后，zabbix 已经支持对接 elasticsearch。当zabbix的历史数据存储到 elasticsearch 后，zabbix 的历史检索性相比之前使用 mysql 确实有很大的提高，但是整体架构却变得更加复杂，因为我使用了 10 台主机去单独作为 elasticsearch 集群。</p>
<table>
<thead>
<tr>
<th>节点数量</th>
<th>角色</th>
<th>CPU</th>
<th>内存</th>
<th>数据存储</th>
</tr>
</thead>
<tbody><tr>
<td>3</td>
<td>master</td>
<td>2</td>
<td>4G</td>
<td>None</td>
</tr>
<tr>
<td>1</td>
<td>Ingest</td>
<td>2</td>
<td>4G</td>
<td>None</td>
</tr>
<tr>
<td>1</td>
<td>Coordingting</td>
<td>2</td>
<td>4G</td>
<td>None</td>
</tr>
<tr>
<td>5</td>
<td>date</td>
<td>8</td>
<td>16G</td>
<td>1T</td>
</tr>
</tbody></table>
<p><img src="/images/network_device_monitor/elasticsearch_nodes.png" alt="Elasticsearch 节点与角色"></p>
<p>替换了elasticsearch之后确实性能有了很大的提高，但是elasticsearch 属于倒排数据库，每个文本为了记录一个指标的数据，附带了很多其他额外的数据。虽然这样提高的检索的速度，但在存储海量数据上并不合适。</p>
<p>对于一个IDC或者一个运营网络的企业来说，我们并不需要定制自己监控系统。但现有我们可用的开源监控系统都各有千秋，我们很难顾此失彼去做一个抉择，因为一旦监控系统上线运行，替换监控系统就相当于高速路上换引擎，是一件非常危险的事情。</p>
<p>刚才的这些已经属于先贬后仰，后面我一定会抛出一套我认为更加优秀的监控系统。但是我想在此之前着重提示一下，并不是 zabbix 与 cacti 不优秀、有缺陷，而是我们应该去了解更多不同的产品，根据自己的业务选择合适监控系统。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.renkeju.com/2020/05/11/kubeedge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Keju Ren">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="时光穿梭机">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/kubeedge/" class="post-title-link" itemprop="url">KubeEdge 部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 14:43:59" itemprop="dateCreated datePublished" datetime="2020-05-11T14:43:59+08:00">2020-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BE%B9%E7%BC%98%E8%AE%A1%E7%AE%97/" itemprop="url" rel="index"><span itemprop="name">边缘计算</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><ul>
<li>CentOS 7.x</li>
<li>kubernetes 1.14.x</li>
<li>docker 18.9.x</li>
<li>kubeedge release 1.1.0</li>
</ul>
<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>KubeEdge由云和边缘部分组成。它基于Kubernetes构建，并为云、边缘之间联网，应用程序部署以及元数据同步提供核心基础架构支持。因此，如果要设置KubeEdge，则需要设置kubernetes集群，云端和边缘端。</p>
<ul>
<li>在云端，我们需要安装docker、kubernetes集群和cloudcore</li>
<li>在边缘端，我们需要安装docker、mqtt和edgecore</li>
</ul>
<h2 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h2><ul>
<li>在云端和边缘端安装docker</li>
<li>在云端安装kubeadm、kubectl</li>
<li>在云端通过kubeadm创建kubernetes集群</li>
<li>在边缘段安装 mosquitto</li>
</ul>
<h2 id="运行-KubeEdge"><a href="#运行-KubeEdge" class="headerlink" title="运行 KubeEdge"></a>运行 KubeEdge</h2><h3 id="设置云端"><a href="#设置云端" class="headerlink" title="设置云端"></a>设置云端</h3><h4 id="下载-KubeEdge"><a href="#下载-KubeEdge" class="headerlink" title="下载 KubeEdge"></a>下载 KubeEdge</h4><p>当kubernetst基础创建完成之后，下载<a href="https://github.com/kubeedge/kubeedge/releases" target="_blank" rel="noopener">kubeedge</a>与<a href="https://raw.githubusercontent.com/kubeedge/kubeedge/release-1.1/build/tools/certgen.sh" target="_blank" rel="noopener">证书生成脚本</a>到本地，并上传master节点。</p>
<h4 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &#x2F;path&#x2F;to&#x2F;certgen.sh genCertAndKey edge</span><br></pre></td></tr></table></figure>

<p>生成证书/密钥将分别在<code>/etc/kubeedge/ca</code>和<code>/etc/kubeedge/certs</code>中，因此此命令应以root用户或有权访问这些目录的用户运行。我们需要将这些文件复制到相应的边缘服务器目录<code>/etc/kubeedge</code>。</p>
<h4 id="运行-cloudcore"><a href="#运行-cloudcore" class="headerlink" title="运行 cloudcore"></a>运行 cloudcore</h4><ol>
<li><p>运行前在kubernetes中创建设备型号和设备CRD，下载<a href="https://raw.githubusercontent.com/kubeedge/kubeedge/release-1.1/build/crds/devices/devices_v1alpha1_device.yaml" target="_blank" rel="noopener">devices_v1alpha1_device.yaml</a>、<a href="https://raw.githubusercontent.com/kubeedge/kubeedge/release-1.1/build/crds/devices/devices_v1alpha1_devicemodel.yaml" target="_blank" rel="noopener">devices_v1alpha1_devicemodel.yaml</a>文件</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f devices_v1alpha1_devicemodel.yaml</span><br><span class="line">kubectl create -f devices_v1alpha1_device.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>解压kubeedge压缩包到<code>/opt</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">tar xfv kubeedge-v1.1.0-linux-amd64.tar.gz -C &#x2F;opt</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;edge&#x2F;</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;edge&#x2F;conf&#x2F;</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;edge&#x2F;conf&#x2F;edge.yaml</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;edge&#x2F;conf&#x2F;modules.yaml</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;edge&#x2F;conf&#x2F;logging.yaml</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;edge&#x2F;edgecore</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;csidriver&#x2F;</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;csidriver&#x2F;csidriver</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;admission&#x2F;</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;admission&#x2F;admission</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;cloudcore&#x2F;</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;cloudcore&#x2F;conf&#x2F;</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;cloudcore&#x2F;conf&#x2F;controller.yaml</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;cloudcore&#x2F;conf&#x2F;modules.yaml</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;cloudcore&#x2F;conf&#x2F;logging.yaml</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;cloud&#x2F;cloudcore&#x2F;cloudcore</span><br><span class="line">kubeedge-v1.1.0-linux-amd64&#x2F;version</span><br><span class="line">ln -s kubeedge-v1.1.0-linux-amd64 kubeedge</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置cloudcore配置文件</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;kubeedge&#x2F;cloud&#x2F;cloudcore&#x2F;conf&#x2F;</span><br><span class="line">vim controller.yaml</span><br></pre></td></tr></table></figure>

<p> 在运行cloudcore之前验证配置</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">controller:</span><br><span class="line">kube:</span><br><span class="line">  master:     # kube-apiserver address (such as:http:&#x2F;&#x2F;localhost:8080)</span><br><span class="line">  namespace: &quot;&quot;</span><br><span class="line">  content_type: &quot;application&#x2F;vnd.kubernetes.protobuf&quot;</span><br><span class="line">  qps: 5</span><br><span class="line">  burst: 10</span><br><span class="line">  node_update_frequency: 10</span><br><span class="line">  kubeconfig: &quot;~&#x2F;.kube&#x2F;config&quot;   #Enter path to kubeconfig file to enable https connection to k8s apiserver, if master and kubeconfig are both set, master will override any value in kubeconfig.</span><br><span class="line">cloudhub:</span><br><span class="line">  protocol_websocket: true # enable websocket protocol</span><br><span class="line">  port: 10000 # open port for websocket server</span><br><span class="line">  protocol_quic: true # enable quic protocol</span><br><span class="line">  quic_port: 10001 # open prot for quic server</span><br><span class="line">  max_incomingstreams: 10000 # the max incoming stream for quic server</span><br><span class="line">  enable_uds: true # enable unix domain socket protocol</span><br><span class="line">  uds_address: unix:&#x2F;&#x2F;&#x2F;var&#x2F;lib&#x2F;kubeedge&#x2F;kubeedge.sock # unix domain socket address</span><br><span class="line">  address: 0.0.0.0</span><br><span class="line">  ca: &#x2F;etc&#x2F;kubeedge&#x2F;ca&#x2F;rootCA.crt</span><br><span class="line">  cert: &#x2F;etc&#x2F;kubeedge&#x2F;certs&#x2F;edge.crt</span><br><span class="line">  key: &#x2F;etc&#x2F;kubeedge&#x2F;certs&#x2F;edge.key</span><br><span class="line">  keepalive-interval: 30</span><br><span class="line">  write-timeout: 30</span><br><span class="line">  node-limit: 10</span><br><span class="line">devicecontroller:</span><br><span class="line">  kube:</span><br><span class="line">    master:        # kube-apiserver address (such as:http:&#x2F;&#x2F;localhost:8080)</span><br><span class="line">    namespace: &quot;&quot;</span><br><span class="line">    content_type: &quot;application&#x2F;vnd.kubernetes.protobuf&quot;</span><br><span class="line">    qps: 5</span><br><span class="line">    burst: 10</span><br><span class="line">    kubeconfig: &quot;~&#x2F;.kube&#x2F;config&quot; #Enter path to kubeconfig file to enable https connection to k8s apiserver,if master and kubeconfig are both set, master will override any value in kubeconfig.</span><br></pre></td></tr></table></figure>

<p> cloudcore默认支持与Kubernetes apiserver的https连接，因此您需要检查<code>controller.kube.kubeconfig</code>和<code>devicecontroller.kube.kubeconfig</code>的路径是否存在，但是如果同时设置<code>master</code>和<code>kubeconfig</code>，则<code>master</code>将覆盖<code>kubeconfig</code>中的任何值。检查<code>cloudhub.ca</code>，<code>cloudhub.cert</code>，<code>cloudhub.key</code>的证书文件是否存在。</p>
</li>
<li><p>通过systemd运行cloudcore</p>
<p> 使用systemd启动cloudcore。如果需要，可以使用示例systemd-unit-file。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubeedge-cloud.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;https:&#x2F;&#x2F;kubeedge.io&#x2F;</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;opt&#x2F;kubeedge&#x2F;cloud&#x2F;cloudcore</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;kubeedge&#x2F;cloud&#x2F;cloudcore&#x2F;cloudcore</span><br><span class="line">Restart&#x3D;always</span><br><span class="line">StartLimitInterval&#x3D;0</span><br><span class="line">RestartSec&#x3D;10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubeedge-cloud</span><br><span class="line">systemctl enable kubeedge-cloud</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查端口</p>
<p>启动后检查端口号，确认 10000 与 10001 端口存在。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -tulnp | grep cloudcore</span><br><span class="line">tcp6       0      0 :::10000                :::*                    LISTEN      17462&#x2F;cloudcore     </span><br><span class="line">udp6       0      0 :::10001                :::*                                17462&#x2F;cloudcore</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="部署边缘节点"><a href="#部署边缘节点" class="headerlink" title="部署边缘节点"></a>部署边缘节点</h4><p>我们提供了一个示例node.json来在kubernetes中添加一个节点。请确保在Kubernetes中添加了Edge节点。运行以下步骤以添加边缘节点。</p>
<ul>
<li><p>下载 <a href="https://raw.githubusercontent.com/kubeedge/kubeedge/release-1.1/build/node.json" target="_blank" rel="noopener">node.js</a> 文件并在文件中的修改边缘节点<code>metadata.name</code>的名称。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubeedge&#x2F;kubeedge&#x2F;release-1.1&#x2F;build&#x2F;node.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>确保该节点的设置为边缘角色。因此在<code>metadata</code>中的<code>labels</code>标签必须有<code>&quot;node-role.kubernetes.io/edge&quot;</code>这个关键字。</p>
</li>
<li><p>请确保在<code>node.json</code>文件中添加了标签<code>node-role.kubernetes.io/edge</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"kind"</span>: <span class="string">"Node"</span>,</span><br><span class="line">  <span class="attr">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"edge-node"</span>,</span><br><span class="line">    <span class="attr">"labels"</span>: &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"edge-node"</span>,</span><br><span class="line">      <span class="attr">"node-role.kubernetes.io/edge"</span>: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：你需要记录下 <code>metadata.name</code>，因为 edgecore 需要它。</p>
</blockquote>
</li>
<li><p>如果没有为节点设置角色，则pod，configmap和secrets无法在云中创建、更新，并与它们所对应的节点同步。</p>
</li>
<li><p>部署边缘节点（您必须在云端运行）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f node.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>将证书文件传输到边缘节点，因为 edgecore 需要使用这些证书文件来连接 cloudcore。</p>
</li>
<li><p>在云端将已经生成的证书打包并上到边缘节点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc</span><br><span class="line">tar zcf kubeedge.tgz &#x2F;etc&#x2F;kubeedge</span><br><span class="line">scp kubeedge.tgz &lt;username&gt;@&lt;ip&gt;:&#x2F;etc</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h3 id="设置边缘端"><a href="#设置边缘端" class="headerlink" title="设置边缘端"></a>设置边缘端</h3><h4 id="下载-EdgeSide"><a href="#下载-EdgeSide" class="headerlink" title="下载 EdgeSide"></a>下载 EdgeSide</h4><p>先将刚才上传的压缩包<code>kubeedge.tgz</code>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc</span><br><span class="line">tar xf kubeedge.tgz</span><br></pre></td></tr></table></figure>

<p>边缘节点和云端部署使用的二进制文件相同，都是<code>kubeedge-v1.1.0-linux-amd64.tar.gz</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -P &#x2F;tmp https:&#x2F;&#x2F;github.com&#x2F;kubeedge&#x2F;kubeedge&#x2F;releases&#x2F;download&#x2F;v1.1.0&#x2F;kubeedge-v1.1.0-linux-amd64.tar.gz </span><br><span class="line">tar xf &#x2F;tmp&#x2F;kubeedge-v1.1.0-linux-amd64.tar.gz -C &#x2F;opt&#x2F;</span><br><span class="line">ln -s &#x2F;opt&#x2F;kubeedge-v1.1.0-linux-amd64 &#x2F;opt&#x2F;kubeedge</span><br></pre></td></tr></table></figure>

<h4 id="安装Mosquitto"><a href="#安装Mosquitto" class="headerlink" title="安装Mosquitto"></a>安装Mosquitto</h4><p>安装 Mosquitto 为 kubeedge edgesite 提供消息队列遥测传输服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install mosquitto</span><br><span class="line">systemctl start mosquitto</span><br><span class="line">systemctl enable mosquitto</span><br></pre></td></tr></table></figure>

<p>启动后检查端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -tulnp | grep mosquitto</span><br><span class="line">tcp        0      0 127.0.0.1:1883          0.0.0.0:*               LISTEN      31482&#x2F;mosquitto</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里我对Mosquitto配置文件<code>/etc/mosquitto/mosquitto.conf</code>中的<code>bind_addr</code>作了更改，更改为<code>127.0.0.1</code>,其默认为<code>0.0.0.0</code>。</p>
</blockquote>
<h4 id="运行-edgesite"><a href="#运行-edgesite" class="headerlink" title="运行 edgesite"></a>运行 edgesite</h4><p>在运行edgecore之前验证配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mqtt:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">tcp://127.0.0.1:1883</span> <span class="comment"># external mqtt broker url.</span></span><br><span class="line">    <span class="attr">internal-server:</span> <span class="string">tcp://127.0.0.1:1884</span> <span class="comment"># internal mqtt broker url.</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0</span> <span class="comment"># 0: internal mqtt broker enable only. 1: internal and external mqtt broker enable. 2: external mqtt broker enable only.</span></span><br><span class="line">    <span class="attr">qos:</span> <span class="number">0</span> <span class="comment"># 0: QOSAtMostOnce, 1: QOSAtLeastOnce, 2: QOSExactlyOnce.</span></span><br><span class="line">    <span class="attr">retain:</span> <span class="literal">false</span> <span class="comment"># if the flag set true, server will store the message and can be delivered to future subscribers.</span></span><br><span class="line">    <span class="attr">session-queue-size:</span> <span class="number">100</span> <span class="comment"># A size of how many sessions will be handled. default to 100.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">edgehub:</span></span><br><span class="line">    <span class="attr">websocket:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">wss://0.0.0.0:10000/e632aba927ea4ac2b575ec1603d56f10/fb4ebb70-2783-42b8-b3ef-63e2fd6d242e/events</span></span><br><span class="line">        <span class="attr">certfile:</span> <span class="string">/etc/kubeedge/certs/edge.crt</span></span><br><span class="line">        <span class="attr">keyfile:</span> <span class="string">/etc/kubeedge/certs/edge.key</span></span><br><span class="line">        <span class="attr">handshake-timeout:</span> <span class="number">30</span> <span class="comment">#second</span></span><br><span class="line">        <span class="attr">write-deadline:</span> <span class="number">15</span> <span class="comment"># second</span></span><br><span class="line">        <span class="attr">read-deadline:</span> <span class="number">15</span> <span class="comment"># second</span></span><br><span class="line">    <span class="attr">quic:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10001</span></span><br><span class="line">        <span class="attr">cafile:</span> <span class="string">/etc/kubeedge/ca/rootCA.crt</span></span><br><span class="line">        <span class="attr">certfile:</span> <span class="string">/etc/kubeedge/certs/edge.crt</span></span><br><span class="line">        <span class="attr">keyfile:</span> <span class="string">/etc/kubeedge/certs/edge.key</span></span><br><span class="line">        <span class="attr">handshake-timeout:</span> <span class="number">30</span> <span class="comment">#second</span></span><br><span class="line">        <span class="attr">write-deadline:</span> <span class="number">15</span> <span class="comment"># second</span></span><br><span class="line">        <span class="attr">read-deadline:</span> <span class="number">15</span> <span class="comment"># second</span></span><br><span class="line">    <span class="attr">controller:</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">websocket</span> <span class="comment"># websocket, quic</span></span><br><span class="line">        <span class="attr">heartbeat:</span> <span class="number">15</span>  <span class="comment"># second</span></span><br><span class="line">        <span class="attr">project-id:</span> <span class="string">e632aba927ea4ac2b575ec1603d56f10</span></span><br><span class="line">        <span class="attr">node-id:</span> <span class="string">fb4ebb70-2783-42b8-b3ef-63e2fd6d242e</span></span><br><span class="line"></span><br><span class="line"><span class="attr">edged:</span></span><br><span class="line">    <span class="attr">register-node-namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">hostname-override:</span> <span class="string">fb4ebb70-2783-42b8-b3ef-63e2fd6d242e</span></span><br><span class="line">    <span class="attr">interface-name:</span> <span class="string">eth0</span></span><br><span class="line">    <span class="attr">edged-memory-capacity-bytes:</span> <span class="number">7852396000</span></span><br><span class="line">    <span class="attr">node-status-update-frequency:</span> <span class="number">10</span> <span class="comment"># second</span></span><br><span class="line">    <span class="attr">device-plugin-enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">gpu-plugin-enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">image-gc-high-threshold:</span> <span class="number">80</span> <span class="comment"># percent</span></span><br><span class="line">    <span class="attr">image-gc-low-threshold:</span> <span class="number">40</span> <span class="comment"># percent</span></span><br><span class="line">    <span class="attr">maximum-dead-containers-per-container:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">docker-address:</span> <span class="string">unix:///var/run/docker.sock</span></span><br><span class="line">    <span class="attr">runtime-type:</span> <span class="string">docker</span></span><br><span class="line">    <span class="attr">remote-runtime-endpoint:</span> <span class="string">unix:///var/run/dockershim.sock</span></span><br><span class="line">    <span class="attr">remote-image-endpoint:</span> <span class="string">unix:///var/run/dockershim.sock</span></span><br><span class="line">    <span class="attr">runtime-request-timeout:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">podsandbox-image:</span> <span class="string">kubeedge/pause:3.1</span> <span class="comment"># kubeedge/pause:3.1 for x86 arch , kubeedge/pause-arm:3.1 for arm arch, kubeedge/pause-arm64 for arm64 arch</span></span><br><span class="line">    <span class="attr">image-pull-progress-deadline:</span> <span class="number">60</span> <span class="comment"># second</span></span><br><span class="line">    <span class="attr">cgroup-driver:</span> <span class="string">cgroupfs</span></span><br><span class="line">    <span class="attr">node-ip:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">cluster-dns:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">cluster-domain:</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mesh:</span></span><br><span class="line">    <span class="attr">loadbalance:</span></span><br><span class="line">        <span class="attr">strategy-name:</span> <span class="string">RoundRobin</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果您已经在边缘端主机上运行了mosquitto，请设置<code>mqtt.mode</code>为”2”。</li>
<li>如果是以双mqtt模式或外部模式（将mqtt.mode设置为1）使用KubeEdge，需要确保在边缘节点上以MQTT Broker形式安装了mosquitto或emqx edge。</li>
<li>检查<code>edgehub.websocket.certfile</code>和<code>edgehub.websocket.keyfile</code>的证书文件是否存在。</li>
<li>检查<code>edgehub.quic.certfile</code>，<code>edgehub.quic.keyfile</code>和<code>edgehub.quic.cafile</code>的证书文件是否存在。如果这些文件不存在，则需要从云端复制它们。</li>
<li>检查<code>edged.podsandbox-image</code><ul>
<li><code>kubeedge/pause-arm:3.1</code>是ARM架构</li>
<li><code>kubeedge/pause-arm64:3.1</code>是ARM64架构</li>
<li><code>kubeedge/pause:3.1</code>是x86架构</li>
</ul>
</li>
<li>在<code>edgehub.websocket.url</code>字段中更新主服务器的IP地址。您需要设置cloudcore IP地址。</li>
<li>如果您使用quic协议，请在<code>edgehub.quic.url</code>字段中更新主服务器的IP地址。您需要设置cloudcore IP地址。</li>
<li>在以下字段中，用<code>edge.yaml</code>中的边缘节点名称替换<code>edge-node</code>：<ul>
<li><code>websocket:URL</code></li>
<li><code>controller:node-id</code></li>
<li><code>edged:hostname-override</code></li>
</ul>
</li>
</ul>
<p>使用 systemctl 运行 edgesite</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubeedge-edge.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;https:&#x2F;&#x2F;kubeedge.io&#x2F;</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;opt&#x2F;kubeedge&#x2F;edge</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;kubeedge&#x2F;edge&#x2F;edgecore</span><br><span class="line">Restart&#x3D;always</span><br><span class="line">StartLimitInterval&#x3D;0</span><br><span class="line">RestartSec&#x3D;10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubeedge-edge</span><br><span class="line">systemctl enable kubeedge-edge</span><br></pre></td></tr></table></figure>

<h4 id="检查状态"><a href="#检查状态" class="headerlink" title="检查状态"></a>检查状态</h4><p>启动Cloud and Edge部件后，可以使用以下命令检查边缘节点状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">NAME                                   STATUS   ROLES    AGE   VERSION</span><br><span class="line">fb4ebb70-2783-42b8-b3ef-63e2fd6d242e   Ready    edge     50m   v1.15.3-kubeedge-v1.1.0</span><br><span class="line">kubeedge.localdomain                   Ready    master   90m   v1.14.3kubectl get nodes</span><br></pre></td></tr></table></figure>

<p>请确保您创建的边缘节点的状态为ready。</p>
<h3 id="在云端部署应用"><a href="#在云端部署应用" class="headerlink" title="在云端部署应用"></a>在云端部署应用</h3><p>请按照以下步骤尝试部署示例应用程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubeedge&#x2F;kubeedge&#x2F;master&#x2F;build&#x2F;deployment.yaml</span><br></pre></td></tr></table></figure>

<p>注意：目前，对于在边缘节点上运行的应用程序，我们不支持<code>kubectl logs</code>和<code>kubectl exec</code>命令（将在将来的版本中支持），支持使用EdgeMes​​h在同一子网中的边缘节点上运行的Pod到Pod通信。</p>
<p>在云端查看pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-d86dfb797-8n7bg   1&#x2F;1     Running   0          4m15s</span><br></pre></td></tr></table></figure>

<p>在边缘节点查看服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -tulnp | grep docker-proxy</span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      462&#x2F;docker-proxy</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Keju Ren"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Keju Ren</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/renkeju" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;renkeju" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:renkeju@gmail.com" title="E-Mail → mailto:renkeju@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Keju Ren</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
